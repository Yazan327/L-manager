{% extends "base.html" %}

{% block title %}Listings - PropertyFinder{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center">
    <h1><i class="bi bi-house-door me-2"></i>Listings</h1>
    <div>
        <a href="/bulk" class="btn btn-outline-pf me-2">
            <i class="bi bi-cloud-upload me-1"></i> Bulk Upload
        </a>
        <a href="/listings/create" class="btn btn-pf">
            <i class="bi bi-plus-lg me-1"></i> New Listing
        </a>
    </div>
</div>

<!-- Filters -->
<div class="card p-3 mb-4">
    <form class="row g-3 align-items-center" method="GET">
        <div class="col-md-3">
            <input type="text" class="form-control" placeholder="Search listings..." name="q">
        </div>
        <div class="col-md-2">
            <select class="form-select" name="status">
                <option value="">All Status</option>
                <option value="live">Live</option>
                <option value="draft">Draft</option>
                <option value="expired">Expired</option>
            </select>
        </div>
        <div class="col-md-2">
            <select class="form-select" name="type">
                <option value="">All Types</option>
                <option value="AP">Apartment</option>
                <option value="VH">Villa</option>
                <option value="TH">Townhouse</option>
                <option value="OF">Office</option>
            </select>
        </div>
        <div class="col-md-2">
            <select class="form-select" name="per_page">
                <option value="25" {% if per_page == 25 %}selected{% endif %}>25 per page</option>
                <option value="50" {% if per_page == 50 %}selected{% endif %}>50 per page</option>
                <option value="100" {% if per_page == 100 %}selected{% endif %}>100 per page</option>
            </select>
        </div>
        <div class="col-md-3">
            <button type="submit" class="btn btn-secondary me-2">
                <i class="bi bi-search me-1"></i> Search
            </button>
            <a href="/listings" class="btn btn-outline-secondary">Reset</a>
        </div>
    </form>
</div>

<!-- Listings Table -->
<div class="card">
    <div class="table-responsive">
        <table class="table mb-0">
            <thead>
                <tr>
                    <th style="width: 60px;">Image</th>
                    <th>Reference</th>
                    <th>Title</th>
                    <th>Type</th>
                    <th>Price</th>
                    <th>Location</th>
                    <th>Beds</th>
                    <th>Size</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% if listings %}
                    {% for listing in listings %}
                    <tr>
                        <td>
                            {% set first_image = listing.images[0] if listing.images else none %}
                            {% if first_image %}
                                {% set img_url = first_image if first_image is string else (first_image.url or (first_image.original.url if first_image.original else '')) %}
                                <img src="{{ img_url }}" 
                                     alt="Listing image"
                                     class="rounded"
                                     style="width: 50px; height: 40px; object-fit: cover;"
                                     onerror="this.style.display='none'">
                            {% else %}
                                <div class="bg-light rounded d-flex align-items-center justify-content-center" 
                                     style="width: 50px; height: 40px;">
                                    <i class="bi bi-image text-muted"></i>
                                </div>
                            {% endif %}
                        </td>
                        <td>
                            <small class="text-muted">{{ listing.reference_number or listing.reference or listing.id[:8] if listing.id is string else listing.id }}</small>
                        </td>
                        <td>
                            <a href="/listings/{{ listing.id }}" class="text-decoration-none fw-medium">
                                {{ listing.title or 'Untitled' }}
                            </a>
                            {% if listing.featured %}
                            <span class="badge bg-warning text-dark ms-1">Featured</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="property-type-badge">{{ listing.property_type or 'N/A' }}</span>
                        </td>
                        <td class="price-tag">
                            {% if listing.price %}
                                {{ listing.price.currency or 'AED' }} {{ "{:,.0f}".format(listing.price.amount or listing.price) }}
                                {% if listing.price.frequency %}
                                <small class="text-muted">/{{ listing.price.frequency }}</small>
                                {% endif %}
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                        <td>
                            {{ listing.location.community if listing.location else 'N/A' }}
                            {% if listing.location and listing.location.sub_community %}
                            <br><small class="text-muted">{{ listing.location.sub_community }}</small>
                            {% endif %}
                        </td>
                        <td>{{ listing.bedrooms if listing.bedrooms is not none else '-' }}</td>
                        <td>
                            {% if listing.size %}
                            {{ "{:,.0f}".format(listing.size) }} sqft
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge-status badge-{{ listing.status or 'draft' }}">
                                {{ listing.status or 'draft' }}
                            </span>
                        </td>
                        <td>
                            <div class="d-flex gap-1">
                                <a href="/listings/{{ listing.id }}" class="action-btn btn btn-light" title="View">
                                    <i class="bi bi-eye"></i>
                                </a>
                                <a href="/listings/{{ listing.id }}/edit" class="action-btn btn btn-light" title="Edit">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <form action="/listings/{{ listing.id }}/delete" method="POST" class="d-inline" 
                                      onsubmit="return confirm('Are you sure you want to delete this listing?');">
                                    <button type="submit" class="action-btn btn btn-light text-danger" title="Delete">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="9" class="text-center py-5">
                            <i class="bi bi-inbox display-4 text-muted"></i>
                            <p class="text-muted mt-3 mb-2">No listings found</p>
                            <a href="/listings/create" class="btn btn-pf">
                                <i class="bi bi-plus-lg me-1"></i> Create your first listing
                            </a>
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
    
    <!-- Pagination -->
    {% if pagination %}
    <div class="card-footer bg-white d-flex justify-content-between align-items-center">
        <small class="text-muted">
            Showing {{ ((page - 1) * per_page) + 1 }} - {{ min(page * per_page, pagination.total or 0) }} 
            of {{ pagination.total or 0 }} listings
        </small>
        <nav>
            <ul class="pagination pagination-sm mb-0">
                <li class="page-item {% if page <= 1 %}disabled{% endif %}">
                    <a class="page-link" href="?page={{ page - 1 }}&per_page={{ per_page }}">Previous</a>
                </li>
                {% for p in range(1, (pagination.total_pages or 1) + 1) %}
                    {% if p <= 5 or p > (pagination.total_pages or 1) - 3 or (p >= page - 1 and p <= page + 1) %}
                    <li class="page-item {% if p == page %}active{% endif %}">
                        <a class="page-link" href="?page={{ p }}&per_page={{ per_page }}">{{ p }}</a>
                    </li>
                    {% elif p == 6 or p == (pagination.total_pages or 1) - 3 %}
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                    {% endif %}
                {% endfor %}
                <li class="page-item {% if page >= (pagination.total_pages or 1) %}disabled{% endif %}">
                    <a class="page-link" href="?page={{ page + 1 }}&per_page={{ per_page }}">Next</a>
                </li>
            </ul>
        </nav>
    </div>
    {% endif %}
</div>
{% endblock %}
