{% extends "base.html" %}

{% block title %}{{ listing.title or 'Listing Details' }} - PropertyFinder{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center">
    <div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-2">
                <li class="breadcrumb-item"><a href="/listings">Listings</a></li>
                <li class="breadcrumb-item active">{{ listing.reference_number or listing.id[:8] }}</li>
            </ol>
        </nav>
        <h1>{{ listing.title or 'Untitled Listing' }}</h1>
    </div>
    <div class="d-flex gap-2">
        {% set effective_status = listing.pf_state or listing.status or listing.state %}
        {% if effective_status in ['draft', 'pf_draft', 'unpublished', 'takendown', 'live_unpublishing_failed'] %}
        <form action="/listings/{{ listing.id }}/publish" method="POST" class="d-inline">
            <button type="submit" class="btn btn-success">
                <i class="bi bi-check-circle me-1"></i> Publish
            </button>
        </form>
        {% endif %}
        {% if effective_status in ['live', 'published', 'live_pending_unpublishing'] or (listing.pf_listing_id and listing.pf_state_error) %}
        <form action="/listings/{{ listing.id }}/unpublish" method="POST" class="d-inline">
            <button type="submit" class="btn btn-warning">
                <i class="bi bi-pause-circle me-1"></i> Unpublish
            </button>
        </form>
        {% endif %}
        <form action="/listings/{{ listing.id }}/sync-pf-status" method="POST" class="d-inline">
            <button type="submit" class="btn btn-outline-secondary" title="Sync status from PropertyFinder">
                <i class="bi bi-arrow-repeat me-1"></i> Sync PF Status
            </button>
        </form>
        <a href="/listings/{{ listing.id }}/edit" class="btn btn-outline-pf">
            <i class="bi bi-pencil me-1"></i> Edit
        </a>
        <form action="/listings/{{ listing.id }}/delete" method="POST" class="d-inline"
              onsubmit="return confirm('Are you sure you want to delete this listing?');">
            <button type="submit" class="btn btn-outline-danger">
                <i class="bi bi-trash me-1"></i> Delete
            </button>
        </form>
    </div>
</div>

<div class="row g-4">
    <!-- Main Info -->
    <div class="col-md-8">
        <div class="card p-4 mb-4">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div>
                    <span class="property-type-badge me-2">{{ listing.property_type or 'N/A' }}</span>
                    <span class="badge-status badge-{{ effective_status or 'draft' }}">
                        {{ effective_status or 'draft' }}
                    </span>
                    {% if listing.pf_state %}
                    <span class="badge bg-info text-dark ms-2">PF: {{ listing.pf_state }}</span>
                    {% elif listing.pf_state_error %}
                    <span class="badge bg-warning text-dark ms-2">PF state unavailable</span>
                    {% endif %}
                    {% if listing.featured %}
                    <span class="badge bg-warning text-dark ms-2">Featured</span>
                    {% endif %}
                </div>
                <div class="price-tag fs-4">
                    {% if listing.price %}
                        {{ listing.price.currency or 'AED' }} {{ "{:,.0f}".format(listing.price.amount or listing.price) }}
                        {% if listing.price.frequency %}
                        <small class="text-muted fs-6">/{{ listing.price.frequency }}</small>
                        {% endif %}
                    {% else %}
                        Price not set
                    {% endif %}
                </div>
            </div>
            
            <h5 class="text-muted mb-3">
                <i class="bi bi-geo-alt me-1"></i>
                {% if listing.location %}
                    {{ listing.location.community or '' }}
                    {% if listing.location.sub_community %}, {{ listing.location.sub_community }}{% endif %}
                    {% if listing.location.city %}, {{ listing.location.city }}{% endif %}
                {% else %}
                    Location not specified
                {% endif %}
            </h5>
            
            <!-- Property Details -->
            <div class="row g-3 mb-4">
                <div class="col-4 col-md-2 text-center">
                    <div class="bg-light rounded p-3">
                        <i class="bi bi-door-open fs-4 text-primary"></i>
                        <div class="fw-bold mt-1">{{ listing.bedrooms if listing.bedrooms is not none else '-' }}</div>
                        <small class="text-muted">Beds</small>
                    </div>
                </div>
                <div class="col-4 col-md-2 text-center">
                    <div class="bg-light rounded p-3">
                        <i class="bi bi-droplet fs-4 text-primary"></i>
                        <div class="fw-bold mt-1">{{ listing.bathrooms if listing.bathrooms is not none else '-' }}</div>
                        <small class="text-muted">Baths</small>
                    </div>
                </div>
                <div class="col-4 col-md-2 text-center">
                    <div class="bg-light rounded p-3">
                        <i class="bi bi-arrows-angle-expand fs-4 text-primary"></i>
                        <div class="fw-bold mt-1">{{ "{:,.0f}".format(listing.size) if listing.size else '-' }}</div>
                        <small class="text-muted">sqft</small>
                    </div>
                </div>
                {% if listing.parking %}
                <div class="col-4 col-md-2 text-center">
                    <div class="bg-light rounded p-3">
                        <i class="bi bi-car-front fs-4 text-primary"></i>
                        <div class="fw-bold mt-1">{{ listing.parking }}</div>
                        <small class="text-muted">Parking</small>
                    </div>
                </div>
                {% endif %}
            </div>
            
            <!-- Description -->
            <h5>Description</h5>
            <p class="text-muted">{{ listing.description or 'No description provided.' }}</p>
            
            {% if listing.description_ar %}
            <h5>الوصف</h5>
            <p class="text-muted" dir="rtl">{{ listing.description_ar }}</p>
            {% endif %}
        </div>
        
        <!-- Amenities -->
        {% if listing.amenities %}
        <div class="card p-4 mb-4">
            <h5><i class="bi bi-star me-2"></i>Amenities</h5>
            <div class="d-flex flex-wrap gap-2 mt-3">
                {% for amenity in listing.amenities %}
                <span class="badge bg-light text-dark border">
                    <i class="bi bi-check-circle text-success me-1"></i>{{ amenity }}
                </span>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- Media Section (Images, Videos) -->
        {% set images = listing.images or [] %}
        {% set video_tour = listing.video_tour or listing.get('videoTour') %}
        {% set video_360 = listing.video_360 or listing.get('video360') %}
        
        {% if images or video_tour or video_360 %}
        <div class="card p-4 mb-4">
            <h5><i class="bi bi-images me-2"></i>Media</h5>
            
            <!-- Main Image Display -->
            {% if images %}
            <div class="position-relative mt-3 mb-3">
                <img id="mainImage" 
                     src="{{ images[0] if images[0] is string else (images[0].url or images[0].original.url if images[0].original else '') }}" 
                     class="img-fluid rounded w-100" 
                     style="max-height: 400px; object-fit: cover; cursor: pointer;"
                     alt="Property image"
                     onclick="openLightbox(0)"
                     onerror="this.src='https://via.placeholder.com/800x400?text=Image+Not+Found'">
                <div class="position-absolute top-0 end-0 m-2">
                    <span class="badge bg-dark bg-opacity-75">
                        <i class="bi bi-images me-1"></i>{{ images|length }} photos
                    </span>
                </div>
            </div>
            
            <!-- Thumbnails -->
            <div class="d-flex flex-wrap gap-2" id="thumbnailGallery">
                {% for image in images[:8] %}
                {% set img_url = image if image is string else (image.url or (image.original.url if image.original else '')) %}
                <div class="thumbnail-item" onclick="selectImage({{ loop.index0 }})" style="cursor: pointer;">
                    <img src="{{ img_url }}" 
                         class="rounded {% if loop.index0 == 0 %}border border-primary border-2{% endif %}"
                         style="width: 80px; height: 60px; object-fit: cover;"
                         alt="Thumbnail {{ loop.index }}"
                         onerror="this.parentElement.style.display='none'">
                </div>
                {% endfor %}
                {% if images|length > 8 %}
                <div class="d-flex align-items-center justify-content-center bg-light rounded" 
                     style="width: 80px; height: 60px; cursor: pointer;"
                     onclick="openLightbox(8)">
                    <span class="text-muted small">+{{ images|length - 8 }} more</span>
                </div>
                {% endif %}
            </div>
            {% endif %}
            
            <!-- Videos Section -->
            {% if video_tour or video_360 %}
            <div class="mt-4">
                <h6><i class="bi bi-play-circle me-2"></i>Videos</h6>
                <div class="d-flex flex-wrap gap-2 mt-2">
                    {% if video_tour %}
                    <a href="{{ video_tour }}" target="_blank" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-camera-video me-1"></i> Video Tour
                    </a>
                    {% endif %}
                    {% if video_360 %}
                    <a href="{{ video_360 }}" target="_blank" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-badge-vr me-1"></i> 360° Video
                    </a>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Lightbox Modal -->
        <div id="lightboxModal" class="modal fade" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-xl modal-dialog-centered">
                <div class="modal-content bg-dark">
                    <div class="modal-header border-0">
                        <span class="text-white" id="lightboxCounter">1 / {{ images|length }}</span>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body p-0 text-center position-relative">
                        <button class="btn btn-dark position-absolute start-0 top-50 translate-middle-y ms-2" 
                                onclick="navigateLightbox(-1)" style="z-index: 10;">
                            <i class="bi bi-chevron-left fs-4"></i>
                        </button>
                        <img id="lightboxImage" src="" class="img-fluid" style="max-height: 80vh;" alt="Full size image">
                        <button class="btn btn-dark position-absolute end-0 top-50 translate-middle-y me-2" 
                                onclick="navigateLightbox(1)" style="z-index: 10;">
                            <i class="bi bi-chevron-right fs-4"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <script>
        // Image gallery data
        const galleryImages = [
            {% for image in images %}
            "{{ image if image is string else (image.url or (image.original.url if image.original else '')) }}"{% if not loop.last %},{% endif %}
            {% endfor %}
        ];
        let currentImageIndex = 0;
        
        function selectImage(index) {
            currentImageIndex = index;
            const mainImg = document.getElementById('mainImage');
            mainImg.src = galleryImages[index];
            
            // Update thumbnail borders
            document.querySelectorAll('#thumbnailGallery .thumbnail-item img').forEach((thumb, i) => {
                if (i === index) {
                    thumb.classList.add('border', 'border-primary', 'border-2');
                } else {
                    thumb.classList.remove('border', 'border-primary', 'border-2');
                }
            });
        }
        
        function openLightbox(index) {
            currentImageIndex = index;
            document.getElementById('lightboxImage').src = galleryImages[index];
            document.getElementById('lightboxCounter').textContent = `${index + 1} / ${galleryImages.length}`;
            new bootstrap.Modal(document.getElementById('lightboxModal')).show();
        }
        
        function navigateLightbox(direction) {
            currentImageIndex = (currentImageIndex + direction + galleryImages.length) % galleryImages.length;
            document.getElementById('lightboxImage').src = galleryImages[currentImageIndex];
            document.getElementById('lightboxCounter').textContent = `${currentImageIndex + 1} / ${galleryImages.length}`;
        }
        
        // Keyboard navigation for lightbox
        document.addEventListener('keydown', function(e) {
            const modal = document.getElementById('lightboxModal');
            if (modal.classList.contains('show')) {
                if (e.key === 'ArrowLeft') navigateLightbox(-1);
                if (e.key === 'ArrowRight') navigateLightbox(1);
                if (e.key === 'Escape') bootstrap.Modal.getInstance(modal).hide();
            }
        });
        </script>
        {% endif %}
    </div>
    
    <!-- Sidebar -->
    <div class="col-md-4">
        <!-- Details Card -->
        <div class="card p-4 mb-4">
            <h5><i class="bi bi-info-circle me-2"></i>Details</h5>
            <table class="table table-sm mt-3">
                <tr>
                    <td class="text-muted">Reference</td>
                    <td class="fw-medium">{{ listing.reference_number or listing.id }}</td>
                </tr>
                <tr>
                    <td class="text-muted">Offering Type</td>
                    <td class="fw-medium text-capitalize">{{ listing.offering_type or 'N/A' }}</td>
                </tr>
                <tr>
                    <td class="text-muted">Property Type</td>
                    <td class="fw-medium">{{ listing.property_type or 'N/A' }}</td>
                </tr>
                {% if listing.completion_status %}
                <tr>
                    <td class="text-muted">Completion</td>
                    <td class="fw-medium text-capitalize">{{ listing.completion_status }}</td>
                </tr>
                {% endif %}
                {% if listing.furnishing %}
                <tr>
                    <td class="text-muted">Furnishing</td>
                    <td class="fw-medium text-capitalize">{{ listing.furnishing }}</td>
                </tr>
                {% endif %}
                {% if listing.permit_number %}
                <tr>
                    <td class="text-muted">Permit Number</td>
                    <td class="fw-medium">{{ listing.permit_number }}</td>
                </tr>
                {% endif %}
                {% if listing.year_built %}
                <tr>
                    <td class="text-muted">Year Built</td>
                    <td class="fw-medium">{{ listing.year_built }}</td>
                </tr>
                {% endif %}
                {% if listing.plot_size %}
                <tr>
                    <td class="text-muted">Plot Size</td>
                    <td class="fw-medium">{{ "{:,.0f}".format(listing.plot_size) }} sqft</td>
                </tr>
                {% endif %}
            </table>
        </div>
        
        <!-- Agent Card -->
        {% if listing.agent %}
        <div class="card p-4 mb-4">
            <h5><i class="bi bi-person me-2"></i>Agent</h5>
            <div class="d-flex align-items-center mt-3">
                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" 
                     style="width: 50px; height: 50px;">
                    <i class="bi bi-person-fill fs-4"></i>
                </div>
                <div>
                    <div class="fw-bold">{{ listing.agent.name or 'Agent' }}</div>
                    {% if listing.agent.email %}
                    <small class="text-muted">{{ listing.agent.email }}</small>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Location Card -->
        {% if listing.location %}
        <div class="card p-4">
            <h5><i class="bi bi-geo-alt me-2"></i>Location</h5>
            {% if listing.location.id %}
            <div class="mb-2">
                <span class="badge bg-light text-dark border" style="cursor: pointer;" 
                      onclick="copyLocationId('{{ listing.location.id }}')" 
                      title="Click to copy Location ID">
                    <i class="bi bi-clipboard me-1"></i>ID: {{ listing.location.id }}
                </span>
            </div>
            {% endif %}
            <table class="table table-sm mt-3">
                {% if listing.location.city %}
                <tr>
                    <td class="text-muted">City</td>
                    <td class="fw-medium">{{ listing.location.city }}</td>
                </tr>
                {% endif %}
                {% if listing.location.community %}
                <tr>
                    <td class="text-muted">Community</td>
                    <td class="fw-medium">{{ listing.location.community }}</td>
                </tr>
                {% endif %}
                {% if listing.location.sub_community %}
                <tr>
                    <td class="text-muted">Sub-community</td>
                    <td class="fw-medium">{{ listing.location.sub_community }}</td>
                </tr>
                {% endif %}
                {% if listing.location.building %}
                <tr>
                    <td class="text-muted">Building</td>
                    <td class="fw-medium">{{ listing.location.building }}</td>
                </tr>
                {% endif %}
            </table>
            
            {% if listing.location.latitude and listing.location.longitude %}
            <div class="mt-3">
                <a href="https://maps.google.com/?q={{ listing.location.latitude }},{{ listing.location.longitude }}" 
                   target="_blank" class="btn btn-outline-secondary btn-sm w-100">
                    <i class="bi bi-map me-1"></i> View on Map
                </a>
            </div>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<script>
function copyLocationId(locationId) {
    navigator.clipboard.writeText(locationId).then(function() {
        // Show a brief toast notification
        const toast = document.createElement('div');
        toast.className = 'position-fixed bottom-0 end-0 m-3 p-3 bg-success text-white rounded shadow';
        toast.innerHTML = '<i class="bi bi-check-circle me-2"></i>Location ID copied: ' + locationId;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 2000);
    }).catch(function(err) {
        alert('Failed to copy: ' + err);
    });
}
</script>
{% endblock %}
