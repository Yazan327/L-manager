{% extends "base.html" %}

{% block title %}Listings - L-Manager{% endblock %}
{% block page_title %}Listings{% endblock %}

{% block content %}
<div x-data="listingsPage()" x-init="init()">
    <div class="flex gap-6">
        <!-- Folder Sidebar -->
        <div class="w-64 flex-shrink-0" x-show="showFolderSidebar" x-transition>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-semibold text-gray-800">
                        <i class="fas fa-folder-tree mr-2 text-indigo-600"></i>Folders
                    </h3>
                    <button @click="showCreateFolderModal = true" 
                            class="p-1.5 text-indigo-600 hover:bg-indigo-50 rounded" title="New Folder">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                
                <!-- All Listings -->
                <a href="{{ url_for('listings') }}" 
                   class="flex items-center justify-between px-3 py-2 rounded-lg mb-1 transition
                          {% if not folder_id and request.args.get('folder_id') != '0' %}bg-indigo-50 text-indigo-700{% else %}hover:bg-gray-50 text-gray-700{% endif %}">
                    <span><i class="fas fa-list mr-2"></i>All Listings</span>
                    <span class="text-xs bg-gray-100 px-2 py-0.5 rounded-full">{{ pagination.total if pagination else 0 }}</span>
                </a>
                
                <!-- Uncategorized -->
                <a href="{{ url_for('listings', folder_id=0) }}" 
                   class="flex items-center justify-between px-3 py-2 rounded-lg mb-1 transition
                          {% if request.args.get('folder_id') == '0' %}bg-indigo-50 text-indigo-700{% else %}hover:bg-gray-50 text-gray-700{% endif %}">
                    <span><i class="fas fa-inbox mr-2 text-gray-400"></i>Uncategorized</span>
                    <span class="text-xs bg-gray-100 px-2 py-0.5 rounded-full">{{ uncategorized_count }}</span>
                </a>
                
                <hr class="my-3">
                
                <!-- Folder List -->
                <div class="space-y-1">
                    {% for folder in folders %}
                    <div class="group relative">
                        <a href="{{ url_for('listings', folder_id=folder.id) }}" 
                           class="flex items-center justify-between px-3 py-2 rounded-lg transition
                                  {% if folder_id == folder.id %}bg-{{ folder.color }}-50 text-{{ folder.color }}-700{% else %}hover:bg-gray-50 text-gray-700{% endif %}">
                            <span>
                                <i class="fas {{ folder.icon }} mr-2 text-{{ folder.color }}-500"></i>
                                {{ folder.name }}
                            </span>
                            <span class="text-xs bg-gray-100 px-2 py-0.5 rounded-full">{{ folder.listing_count }}</span>
                        </a>
                        <!-- Folder actions (show on hover) -->
                        <div class="absolute right-2 top-1/2 -translate-y-1/2 hidden group-hover:flex items-center gap-1">
                            <button @click.prevent="editFolder({{ folder | tojson | e }})" 
                                    class="p-1 text-gray-400 hover:text-indigo-600 hover:bg-white rounded">
                                <i class="fas fa-edit text-xs"></i>
                            </button>
                            <button @click.prevent="deleteFolder({{ folder.id }})" 
                                    class="p-1 text-gray-400 hover:text-red-600 hover:bg-white rounded">
                                <i class="fas fa-trash text-xs"></i>
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                {% if not folders %}
                <p class="text-sm text-gray-500 text-center py-4">
                    No folders yet.<br>
                    <button @click="showCreateFolderModal = true" class="text-indigo-600 hover:underline mt-1">
                        Create your first folder
                    </button>
                </p>
                {% endif %}
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="flex-1 min-w-0">
    <!-- Header Actions -->
    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-6">
        <div class="flex flex-wrap items-center gap-3">
            <!-- Toggle Folders Sidebar -->
            <button @click="showFolderSidebar = !showFolderSidebar" 
                    class="p-2 border border-gray-300 rounded-lg hover:bg-gray-50" 
                    :class="showFolderSidebar ? 'bg-indigo-50 border-indigo-300' : ''"
                    title="Toggle Folders">
                <i class="fas fa-folder-tree"></i>
            </button>
            
            <!-- Search -->
            <div class="relative">
                <input type="text" placeholder="Search listings..." 
                       class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 w-64"
                       x-model="searchQuery"
                       @keyup.enter="applyFilters()">
                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
            </div>
            
            <!-- Status Filter -->
            <select class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500"
                    x-model="filterStatus" @change="applyFilters()">
                <option value="">All Status</option>
                <option value="live">Live</option>
                <option value="draft">Draft</option>
                <option value="unpublished">Unpublished</option>
            </select>
            
            <!-- Sort By -->
            <select class="border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500"
                    x-model="sortBy" @change="applyFilters()">
                <option value="updated_at">Last Updated</option>
                <option value="created_at">Date Created</option>
                <option value="price">Price</option>
                <option value="views">Views</option>
                <option value="leads">Leads</option>
                <option value="bedrooms">Bedrooms</option>
                <option value="size">Size</option>
                <option value="reference">Reference</option>
            </select>
            
            <!-- Sort Order -->
            <button @click="toggleSortOrder()" class="p-2 border border-gray-300 rounded-lg hover:bg-gray-50" :title="sortOrder === 'desc' ? 'Descending' : 'Ascending'">
                <i class="fas" :class="sortOrder === 'desc' ? 'fa-sort-amount-down' : 'fa-sort-amount-up'"></i>
            </button>
            
            <!-- Per Page -->
            <select class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500"
                    x-model="perPage" @change="applyFilters()">
                <option value="10">10 / page</option>
                <option value="25">25 / page</option>
                <option value="50">50 / page</option>
                <option value="100">100 / page</option>
            </select>
            
            <!-- Show Duplicates Toggle -->
            {% if duplicates_count is defined and duplicates_count > 0 %}
            <label class="flex items-center gap-2 px-3 py-2 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50"
                   :class="showDuplicates ? 'bg-purple-50 border-purple-300' : ''">
                <input type="checkbox" x-model="showDuplicates" @change="applyFilters()" class="rounded text-purple-600">
                <span class="text-sm">
                    <i class="fas fa-copy text-purple-500 mr-1"></i>
                    Duplicates <span class="text-xs text-gray-500">({{ duplicates_count }})</span>
                </span>
            </label>
            {% endif %}
        </div>
        
        <a href="{{ url_for('new_listing') }}" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition inline-flex items-center">
            <i class="fas fa-plus mr-2"></i>New Listing
        </a>
    </div>
    
    <!-- Current Folder Header -->
    {% if current_folder %}
    <div class="mb-4 flex items-center gap-3 px-4 py-3 bg-{{ current_folder.color }}-50 rounded-lg border border-{{ current_folder.color }}-200">
        <i class="fas {{ current_folder.icon }} text-{{ current_folder.color }}-600 text-xl"></i>
        <div>
            <h2 class="font-semibold text-{{ current_folder.color }}-800">{{ current_folder.name }}</h2>
            {% if current_folder.description %}
            <p class="text-sm text-{{ current_folder.color }}-600">{{ current_folder.description }}</p>
            {% endif %}
        </div>
        <a href="{{ url_for('listings') }}" class="ml-auto text-sm text-{{ current_folder.color }}-600 hover:text-{{ current_folder.color }}-800">
            <i class="fas fa-times mr-1"></i>Clear folder filter
        </a>
    </div>
    {% elif request.args.get('folder_id') == '0' %}
    <div class="mb-4 flex items-center gap-3 px-4 py-3 bg-gray-50 rounded-lg border border-gray-200">
        <i class="fas fa-inbox text-gray-500 text-xl"></i>
        <div>
            <h2 class="font-semibold text-gray-800">Uncategorized</h2>
            <p class="text-sm text-gray-600">Listings not assigned to any folder</p>
        </div>
        <a href="{{ url_for('listings') }}" class="ml-auto text-sm text-gray-600 hover:text-gray-800">
            <i class="fas fa-times mr-1"></i>Clear folder filter
        </a>
    </div>
    {% endif %}
    
    <!-- Results Summary -->
    <div class="mb-4 flex items-center justify-between">
        <p class="text-sm text-gray-600">
            <span class="font-medium" x-text="pagination.total"></span> listings found
            <span x-show="searchQuery" class="text-gray-400">for "<span x-text="searchQuery"></span>"</span>
        </p>
        <button @click="clearFilters()" x-show="searchQuery || filterStatus" 
                class="text-sm text-indigo-600 hover:text-indigo-800">
            <i class="fas fa-times mr-1"></i>Clear filters
        </button>
    </div>
    
    <!-- Listings Table -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase w-10">
                            <input type="checkbox" class="rounded" @change="toggleSelectAll($event)">
                        </th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:text-gray-700" @click="sortColumn('reference')">
                            Property
                            <i class="fas fa-sort ml-1" x-show="sortBy !== 'reference'"></i>
                            <i class="fas" :class="sortOrder === 'asc' ? 'fa-sort-up' : 'fa-sort-down'" x-show="sortBy === 'reference'"></i>
                        </th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                        <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase cursor-pointer hover:text-gray-700" @click="sortColumn('bedrooms')">
                            Beds
                            <i class="fas fa-sort ml-1" x-show="sortBy !== 'bedrooms'"></i>
                        </th>
                        <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">Baths</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:text-gray-700" @click="sortColumn('size')">
                            Size
                            <i class="fas fa-sort ml-1" x-show="sortBy !== 'size'"></i>
                        </th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Location</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:text-gray-700" @click="sortColumn('price')">
                            Price
                            <i class="fas fa-sort ml-1" x-show="sortBy !== 'price'"></i>
                        </th>
                        <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase cursor-pointer hover:text-gray-700" @click="sortColumn('views')">
                            <i class="fas fa-eye mr-1"></i>Views
                        </th>
                        <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase cursor-pointer hover:text-gray-700" @click="sortColumn('leads')">
                            <i class="fas fa-phone mr-1"></i>Leads
                        </th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                        <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for listing in listings %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-3 py-3">
                            <input type="checkbox" class="rounded" value="{{ listing.id }}" x-model="selectedIds">
                        </td>
                        <td class="px-3 py-3">
                            <div class="flex items-center">
                                <div class="w-10 h-10 bg-gray-200 rounded-lg flex items-center justify-center mr-3 flex-shrink-0">
                                    {% if listing.images and listing.images|length > 0 %}
                                    <img src="{{ listing.images[0] }}" class="w-10 h-10 rounded-lg object-cover" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                    <i class="fas fa-building text-gray-400 hidden"></i>
                                    {% else %}
                                    <i class="fas fa-building text-gray-400"></i>
                                    {% endif %}
                                </div>
                                <div class="min-w-0">
                                    {% set title = listing.title_en or listing.title or 'Untitled' %}
                                    <a href="{{ url_for('view_listing', listing_id=listing.id) }}" 
                                       class="text-sm font-medium text-gray-900 hover:text-indigo-600 truncate block max-w-[180px]">{{ title }}</a>
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs text-gray-500 font-mono">{{ listing.reference or 'No ref' }}</span>
                                        {% if listing.folder %}
                                        <span class="inline-flex items-center text-xs px-1.5 py-0.5 rounded bg-{{ listing.folder.color }}-100 text-{{ listing.folder.color }}-700">
                                            <i class="fas {{ listing.folder.icon }} mr-1 text-[10px]"></i>{{ listing.folder.name }}
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="px-3 py-3">
                            <span class="text-sm text-gray-900 capitalize">{{ (listing.property_type or '-')|replace('-', ' ') }}</span>
                            <div class="text-xs text-gray-500 capitalize">{{ listing.offering_type|default('')|title }}</div>
                        </td>
                        <td class="px-3 py-3 text-sm text-center">
                            {% if listing.bedrooms == 'studio' or listing.bedrooms == 'Studio' %}
                                <span class="text-xs bg-gray-100 px-2 py-1 rounded">Studio</span>
                            {% elif listing.bedrooms %}
                                {{ listing.bedrooms }}
                            {% else %}-{% endif %}
                        </td>
                        <td class="px-3 py-3 text-sm text-center">
                            {{ listing.bathrooms or '-' }}
                        </td>
                        <td class="px-3 py-3 text-sm text-gray-600">
                            {% if listing.size %}
                                {{ "{:,.0f}".format(listing.size) }} <span class="text-xs text-gray-400">sqft</span>
                            {% else %}-{% endif %}
                        </td>
                        <td class="px-3 py-3 text-sm text-gray-600">
                            <div class="max-w-[140px]" title="{{ listing.location }}{% if listing.city %}, {{ listing.city }}{% endif %}{% if listing.emirate %}, {{ listing.emirate }}{% endif %}">
                                {% if listing.location %}
                                    <div class="truncate">{{ listing.location }}</div>
                                    {% if listing.city or listing.emirate %}
                                    <div class="text-xs text-gray-400 truncate">{{ listing.city }}{% if listing.emirate %}, {{ listing.emirate }}{% endif %}</div>
                                    {% endif %}
                                {% elif listing.city %}
                                    <div class="truncate">{{ listing.city }}</div>
                                    {% if listing.emirate %}
                                    <div class="text-xs text-gray-400">{{ listing.emirate }}</div>
                                    {% endif %}
                                {% elif listing.emirate %}
                                    {{ listing.emirate }}
                                {% else %}
                                    <span class="text-gray-400">-</span>
                                {% endif %}
                            </div>
                        </td>
                        <td class="px-3 py-3">
                            {% if listing.price %}
                            <div class="text-sm font-medium text-gray-900">
                                AED {{ "{:,.0f}".format(listing.price) }}
                            </div>
                            {% if listing.offering_type == 'rent' and listing.rent_frequency %}
                            <div class="text-xs text-gray-500">{{ listing.rent_frequency }}</div>
                            {% endif %}
                            {% else %}
                            <span class="text-gray-400">-</span>
                            {% endif %}
                        </td>
                        <td class="px-3 py-3 text-sm text-center">
                            <span class="font-medium text-blue-600">{{ listing.views or 0 }}</span>
                        </td>
                        <td class="px-3 py-3 text-sm text-center">
                            <span class="font-medium text-green-600">{{ listing.leads or 0 }}</span>
                        </td>
                        <td class="px-3 py-3">
                            <span class="inline-flex px-2 py-1 text-xs font-medium rounded-full
                                  {% if listing.status == 'live' or (listing.pf_listing_id and listing.status in ['pending', 'pf_draft']) %}bg-green-100 text-green-800
                                  {% elif listing.status == 'draft' %}bg-yellow-100 text-yellow-800
                                  {% else %}bg-gray-100 text-gray-800{% endif %}">
                                  {% if listing.status == 'live' or (listing.pf_listing_id and listing.status in ['pending', 'pf_draft']) %}Live
                                  {% else %}{{ listing.status|default('draft')|title }}{% endif %}
                            </span>
                        </td>
                        <td class="px-3 py-3">
                            <div class="flex items-center justify-center space-x-1">
                                <a href="{{ url_for('view_listing', listing_id=listing.id) }}" 
                                   class="p-1.5 text-indigo-600 hover:bg-indigo-50 rounded" title="View">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="{{ url_for('edit_listing', listing_id=listing.id) }}" 
                                   class="p-1.5 text-gray-600 hover:bg-gray-100 rounded" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </a>
                                {% if listing.status == 'draft' %}
                                <button @click="sendToPfDraft('{{ listing.id }}')" 
                                        class="p-1.5 text-purple-600 hover:bg-purple-50 rounded" title="Send to PF Draft">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                </button>
                                <button @click="publishListing('{{ listing.id }}')" 
                                        class="p-1.5 text-green-600 hover:bg-green-50 rounded" title="Publish to PF">
                                    <i class="fas fa-check-circle"></i>
                                </button>
                                {% elif listing.status == 'pf_draft' %}
                                <button @click="publishListing('{{ listing.id }}')" 
                                        class="p-1.5 text-green-600 hover:bg-green-50 rounded" title="Publish on PF">
                                    <i class="fas fa-check-circle"></i>
                                </button>
                                {% else %}
                                <button @click="unpublishListing('{{ listing.id }}')" 
                                        class="p-1.5 text-yellow-600 hover:bg-yellow-50 rounded" title="Unpublish">
                                    <i class="fas fa-pause-circle"></i>
                                </button>
                                {% endif %}
                                <button @click="duplicateListing('{{ listing.id }}')" 
                                        class="p-1.5 text-blue-600 hover:bg-blue-50 rounded" title="Duplicate">
                                    <i class="fas fa-copy"></i>
                                </button>
                                <button @click="deleteListing('{{ listing.id }}')" 
                                        class="p-1.5 text-red-600 hover:bg-red-50 rounded" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="12" class="px-6 py-12 text-center">
                            <i class="fas fa-inbox text-gray-300 text-5xl mb-4 block"></i>
                            <p class="text-gray-500 mb-4">No listings found</p>
                            <a href="{{ url_for('new_listing') }}" class="text-indigo-600 hover:underline">
                                Create your first listing
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Pagination -->
    {% if pagination and pagination.total > 0 %}
    {% set folder_param = '&folder_id=' ~ folder_id if folder_id is not none else ('&folder_id=0' if request.args.get('folder_id') == '0' else '') %}
    <div class="mt-6 flex flex-col sm:flex-row items-center justify-between gap-4">
        <div class="text-sm text-gray-600">
            {% set start_item = ((page - 1) * per_page) + 1 %}
            {% set end_item = page * per_page %}
            {% set total = pagination.total %}
            Showing <span class="font-medium">{{ start_item }}</span> to <span class="font-medium">{{ end_item if end_item < total else total }}</span> of <span class="font-medium">{{ total }}</span> listings
        </div>
        
        <div class="flex items-center space-x-1">
            <!-- First Page -->
            <a href="?page=1&per_page={{ per_page }}&sort_by={{ sort_by }}&sort_order={{ sort_order }}&status={{ status }}&search={{ search }}{{ folder_param }}" 
               class="px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 {% if page == 1 %}opacity-50 pointer-events-none{% endif %}"
               title="First page">
                <i class="fas fa-angle-double-left"></i>
            </a>
            
            <!-- Previous -->
            <a href="?page={{ page - 1 }}&per_page={{ per_page }}&sort_by={{ sort_by }}&sort_order={{ sort_order }}&status={{ status }}&search={{ search }}{{ folder_param }}" 
               class="px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 {% if page == 1 %}opacity-50 pointer-events-none{% endif %}">
                <i class="fas fa-chevron-left"></i>
            </a>
            
            <!-- Page Numbers -->
            {% set last_page = pagination.last_page %}
            {% for p in range(1, last_page + 1) %}
                {% if p == 1 or p == last_page or (p >= page - 2 and p <= page + 2) %}
                <a href="?page={{ p }}&per_page={{ per_page }}&sort_by={{ sort_by }}&sort_order={{ sort_order }}&status={{ status }}&search={{ search }}{{ folder_param }}" 
                   class="px-4 py-2 border rounded-lg {% if p == page %}bg-indigo-600 text-white border-indigo-600{% else %}border-gray-300 hover:bg-gray-50{% endif %}">
                    {{ p }}
                </a>
                {% elif p == page - 3 or p == page + 3 %}
                <span class="px-2 py-2 text-gray-400">...</span>
                {% endif %}
            {% endfor %}
            
            <!-- Next -->
            <a href="?page={{ page + 1 }}&per_page={{ per_page }}&sort_by={{ sort_by }}&sort_order={{ sort_order }}&status={{ status }}&search={{ search }}{{ folder_param }}" 
               class="px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 {% if page >= last_page %}opacity-50 pointer-events-none{% endif %}">
                <i class="fas fa-chevron-right"></i>
            </a>
            
            <!-- Last Page -->
            <a href="?page={{ last_page }}&per_page={{ per_page }}&sort_by={{ sort_by }}&sort_order={{ sort_order }}&status={{ status }}&search={{ search }}{{ folder_param }}" 
               class="px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 {% if page >= last_page %}opacity-50 pointer-events-none{% endif %}"
               title="Last page">
                <i class="fas fa-angle-double-right"></i>
            </a>
        </div>
    </div>
    {% endif %}
    
    <!-- Bulk Actions Bar -->
    <div x-show="selectedIds.length > 0" 
         x-cloak
         x-transition
         class="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-lg shadow-lg flex items-center space-x-4 z-50">
        <span class="font-medium"><span x-text="selectedIds.length"></span> selected</span>
        <div class="h-6 w-px bg-gray-600"></div>
        <!-- Move to Folder Button -->
        <div class="relative" x-data="{ showFolderDropdown: false }">
            <button @click="showFolderDropdown = !showFolderDropdown" 
                    class="px-3 py-1.5 bg-indigo-600 rounded hover:bg-indigo-700 transition">
                <i class="fas fa-folder mr-1"></i>Move to Folder
            </button>
            <div x-show="showFolderDropdown" @click.away="showFolderDropdown = false"
                 class="absolute bottom-full left-0 mb-2 w-48 bg-white rounded-lg shadow-lg py-2 text-gray-700">
                <button @click="moveToFolder(null); showFolderDropdown = false" 
                        class="w-full text-left px-4 py-2 hover:bg-gray-100">
                    <i class="fas fa-inbox mr-2 text-gray-400"></i>Uncategorized
                </button>
                {% for folder in folders %}
                <button @click="moveToFolder({{ folder.id }}); showFolderDropdown = false" 
                        class="w-full text-left px-4 py-2 hover:bg-gray-100">
                    <i class="fas {{ folder.icon }} mr-2 text-{{ folder.color }}-500"></i>{{ folder.name }}
                </button>
                {% endfor %}
            </div>
        </div>
        <div class="h-6 w-px bg-gray-600"></div>
        <button @click="bulkPublish()" class="px-3 py-1.5 bg-green-600 rounded hover:bg-green-700 transition">
            <i class="fas fa-check-circle mr-1"></i>Publish
        </button>
        <button @click="bulkUnpublish()" class="px-3 py-1.5 bg-yellow-600 rounded hover:bg-yellow-700 transition">
            <i class="fas fa-pause-circle mr-1"></i>Unpublish
        </button>
        <button @click="bulkDelete()" class="px-3 py-1.5 bg-red-600 rounded hover:bg-red-700 transition">
            <i class="fas fa-trash mr-1"></i>Delete
        </button>
        <button @click="selectedIds = []" class="ml-2 text-gray-400 hover:text-white transition">
            <i class="fas fa-times text-lg"></i>
        </button>
    </div>
    
        </div><!-- End Main Content -->
    </div><!-- End Flex Container -->
    
    <!-- Create/Edit Folder Modal -->
    <div x-show="showCreateFolderModal || showEditFolderModal" 
         x-cloak
         class="fixed inset-0 z-50 overflow-y-auto"
         @keydown.escape.window="showCreateFolderModal = false; showEditFolderModal = false">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center">
            <div class="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75" @click="showCreateFolderModal = false; showEditFolderModal = false"></div>
            
            <div class="relative inline-block w-full max-w-md p-6 my-8 text-left align-middle transition-all transform bg-white shadow-xl rounded-2xl">
                <h3 class="text-lg font-semibold text-gray-900 mb-4" x-text="showEditFolderModal ? 'Edit Folder' : 'Create New Folder'"></h3>
                
                <form @submit.prevent="saveFolder()">
                    <!-- Folder Name -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Folder Name</label>
                        <input type="text" x-model="folderForm.name" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                               placeholder="e.g., Hot Properties">
                    </div>
                    
                    <!-- Color -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Color</label>
                        <div class="flex flex-wrap gap-2">
                            <template x-for="color in folderColors">
                                <button type="button" @click="folderForm.color = color"
                                        class="w-8 h-8 rounded-full border-2 transition"
                                        :class="folderForm.color === color ? 'border-gray-800 scale-110' : 'border-transparent'"
                                        :style="'background-color: var(--color-' + color + '-500, ' + getColorHex(color) + ')'">
                                </button>
                            </template>
                        </div>
                    </div>
                    
                    <!-- Icon -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Icon</label>
                        <div class="flex flex-wrap gap-2">
                            <template x-for="icon in folderIcons">
                                <button type="button" @click="folderForm.icon = icon"
                                        class="w-10 h-10 rounded-lg border-2 flex items-center justify-center transition"
                                        :class="folderForm.icon === icon ? 'border-indigo-500 bg-indigo-50' : 'border-gray-200 hover:border-gray-300'">
                                    <i :class="'fas ' + icon" class="text-gray-600"></i>
                                </button>
                            </template>
                        </div>
                    </div>
                    
                    <!-- Description -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Description (optional)</label>
                        <textarea x-model="folderForm.description" rows="2"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                  placeholder="Brief description..."></textarea>
                    </div>
                    
                    <!-- Actions -->
                    <div class="flex justify-end gap-3 mt-6">
                        <button type="button" @click="showCreateFolderModal = false; showEditFolderModal = false"
                                class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">
                            Cancel
                        </button>
                        <button type="submit" class="px-4 py-2 text-white bg-indigo-600 rounded-lg hover:bg-indigo-700">
                            <span x-text="showEditFolderModal ? 'Save Changes' : 'Create Folder'"></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function listingsPage() {
    return {
        // State from server
        searchQuery: '{{ search|default("") }}',
        filterStatus: '{{ status|default("") }}',
        sortBy: '{{ sort_by|default("updated_at") }}',
        sortOrder: '{{ sort_order|default("desc") }}',
        perPage: '{{ per_page|default(25) }}',
        showDuplicates: {{ 'true' if show_duplicates else 'false' }},
        pagination: {{ pagination | tojson | safe if pagination else '{}' }},
        selectedIds: [],
        
        // Folder state
        showFolderSidebar: localStorage.getItem('showFolderSidebar') !== 'false',
        showCreateFolderModal: false,
        showEditFolderModal: false,
        editingFolderId: null,
        folderForm: {
            name: '',
            color: 'indigo',
            icon: 'fa-folder',
            description: ''
        },
        folderColors: ['indigo', 'blue', 'green', 'yellow', 'red', 'purple', 'pink', 'gray', 'orange', 'teal'],
        folderIcons: ['fa-folder', 'fa-building', 'fa-home', 'fa-city', 'fa-star', 'fa-heart', 'fa-fire', 'fa-bolt', 'fa-gem', 'fa-crown', 'fa-tag', 'fa-bookmark', 'fa-flag', 'fa-bell', 'fa-clock'],
        
        init() {
            // Watch folder sidebar toggle
            this.$watch('showFolderSidebar', (val) => {
                localStorage.setItem('showFolderSidebar', val);
            });
        },
        
        getColorHex(color) {
            const colors = {
                indigo: '#6366f1', blue: '#3b82f6', green: '#22c55e', 
                yellow: '#eab308', red: '#ef4444', purple: '#a855f7',
                pink: '#ec4899', gray: '#6b7280', orange: '#f97316', teal: '#14b8a6'
            };
            return colors[color] || '#6366f1';
        },
        
        resetFolderForm() {
            this.folderForm = { name: '', color: 'indigo', icon: 'fa-folder', description: '' };
            this.editingFolderId = null;
        },
        
        editFolder(folder) {
            this.folderForm = {
                name: folder.name,
                color: folder.color,
                icon: folder.icon,
                description: folder.description || ''
            };
            this.editingFolderId = folder.id;
            this.showEditFolderModal = true;
        },
        
        async saveFolder() {
            const url = this.editingFolderId 
                ? `/api/folders/${this.editingFolderId}` 
                : '/api/folders';
            const method = this.editingFolderId ? 'PUT' : 'POST';
            
            try {
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.folderForm)
                });
                
                if (response.ok) {
                    this.showCreateFolderModal = false;
                    this.showEditFolderModal = false;
                    this.resetFolderForm();
                    location.reload();
                } else {
                    const data = await response.json();
                    alert(data.error || 'Failed to save folder');
                }
            } catch (e) {
                alert('Failed to save folder');
            }
        },
        
        async deleteFolder(folderId) {
            if (!confirm('Delete this folder? Listings will be moved to Uncategorized.')) return;
            
            try {
                const response = await fetch(`/api/folders/${folderId}`, { method: 'DELETE' });
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Failed to delete folder');
                }
            } catch (e) {
                alert('Failed to delete folder');
            }
        },
        
        async moveToFolder(folderId) {
            if (this.selectedIds.length === 0) return;
            
            try {
                const response = await fetch('/api/listings/move-to-folder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        listing_ids: this.selectedIds.map(id => parseInt(id)),
                        folder_id: folderId
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    this.selectedIds = [];
                    location.reload();
                } else {
                    alert('Failed to move listings');
                }
            } catch (e) {
                alert('Failed to move listings');
            }
        },
        
        applyFilters() {
            const params = new URLSearchParams();
            params.set('page', '1'); // Reset to first page when filtering
            params.set('per_page', this.perPage);
            params.set('sort_by', this.sortBy);
            params.set('sort_order', this.sortOrder);
            if (this.filterStatus) params.set('status', this.filterStatus);
            if (this.searchQuery) params.set('search', this.searchQuery);
            if (this.showDuplicates) params.set('show_duplicates', '1');
            // Preserve folder_id if set
            const currentFolderId = new URLSearchParams(window.location.search).get('folder_id');
            if (currentFolderId !== null) params.set('folder_id', currentFolderId);
            window.location.href = '?' + params.toString();
        },
        
        clearFilters() {
            this.searchQuery = '';
            this.filterStatus = '';
            this.applyFilters();
        },
        
        toggleSortOrder() {
            this.sortOrder = this.sortOrder === 'desc' ? 'asc' : 'desc';
            this.applyFilters();
        },
        
        sortColumn(column) {
            if (this.sortBy === column) {
                this.sortOrder = this.sortOrder === 'desc' ? 'asc' : 'desc';
            } else {
                this.sortBy = column;
                this.sortOrder = 'desc';
            }
            this.applyFilters();
        },
        
        toggleSelectAll(event) {
            if (event.target.checked) {
                this.selectedIds = [...document.querySelectorAll('tbody input[type="checkbox"]')].map(cb => cb.value);
            } else {
                this.selectedIds = [];
            }
        },
        
        async publishListing(id) {
            if (!confirm('Publish this listing?')) return;
            try {
                const response = await fetch(`/api/local/listings/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'live' })
                });
                if (response.ok) location.reload();
                else alert('Failed to publish listing');
            } catch (e) {
                alert('Failed to publish listing');
            }
        },
        
        async unpublishListing(id) {
            if (!confirm('Unpublish this listing?')) return;
            try {
                const response = await fetch(`/api/local/listings/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'draft' })
                });
                if (response.ok) location.reload();
                else alert('Failed to unpublish listing');
            } catch (e) {
                alert('Failed to unpublish listing');
            }
        },
        
        async deleteListing(id) {
            if (!confirm('Are you sure you want to delete this listing? This cannot be undone.')) return;
            try {
                const response = await fetch(`/api/local/listings/${id}`, { method: 'DELETE' });
                if (response.ok) location.reload();
                else alert('Failed to delete listing');
            } catch (e) {
                alert('Failed to delete listing');
            }
        },
        
        async duplicateListing(id) {
            try {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/listings/${id}/duplicate`;
                document.body.appendChild(form);
                form.submit();
            } catch (e) {
                alert('Failed to duplicate listing');
            }
        },
        
        async sendToPfDraft(id) {
            try {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/listings/${id}/send-to-pf`;
                document.body.appendChild(form);
                form.submit();
            } catch (e) {
                alert('Failed to send to PF draft');
            }
        },
        
        async bulkPublish() {
            if (!confirm(`Publish ${this.selectedIds.length} listings?`)) return;
            for (const id of this.selectedIds) {
                await fetch(`/api/local/listings/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'live' })
                });
            }
            location.reload();
        },
        
        async bulkUnpublish() {
            if (!confirm(`Unpublish ${this.selectedIds.length} listings?`)) return;
            for (const id of this.selectedIds) {
                await fetch(`/api/local/listings/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'draft' })
                });
            }
            location.reload();
        },
        
        async bulkDelete() {
            if (!confirm(`Delete ${this.selectedIds.length} listings? This cannot be undone.`)) return;
            for (const id of this.selectedIds) {
                await fetch(`/api/local/listings/${id}`, { method: 'DELETE' });
            }
            location.reload();
        }
    }
}
</script>
{% endblock %}
