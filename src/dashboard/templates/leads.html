{% extends "base.html" %}

{% block title %}Leads - L-Manager{% endblock %}

{% block content %}
<div x-data="leadsManager()" x-init="init()" class="space-y-6">
    <!-- Fixed Header Section (not affected by Kanban scroll) -->
    <div class="max-w-full overflow-hidden">
        <!-- Header Section -->
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 flex-wrap">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">Leads</h1>
                <p class="text-gray-600">Manage incoming leads from all sources</p>
            </div>
            <div class="flex gap-2 flex-wrap">
            <!-- View Toggle -->
            <div class="flex bg-gray-100 rounded-lg p-1">
                <button @click="viewMode = 'list'" 
                        :class="viewMode === 'list' ? 'bg-white shadow-sm text-blue-600' : 'text-gray-600 hover:text-gray-900'"
                        class="px-3 py-1.5 rounded-md text-sm font-medium flex items-center gap-1.5 transition-all">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/>
                    </svg>
                    List
                </button>
                <button @click="viewMode = 'kanban'" 
                        :class="viewMode === 'kanban' ? 'bg-white shadow-sm text-blue-600' : 'text-gray-600 hover:text-gray-900'"
                        class="px-3 py-1.5 rounded-md text-sm font-medium flex items-center gap-1.5 transition-all">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2"/>
                    </svg>
                    Kanban
                </button>
            </div>
            <button @click="showAddModal = true" 
                    class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                </svg>
                Add Lead
            </button>
            <button @click="syncFromPF()" :disabled="syncing"
                    class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 flex items-center gap-2 disabled:opacity-50">
                <svg class="w-5 h-5" :class="syncing && 'animate-spin'" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                <span x-text="syncing ? 'Syncing...' : 'Sync from PF'"></span>
            </button>
            <button @click="refreshAgents()" :disabled="refreshingAgents"
                    class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 flex items-center gap-2 disabled:opacity-50">
                <svg class="w-5 h-5" :class="refreshingAgents && 'animate-spin'" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                </svg>
                <span x-text="refreshingAgents ? 'Refreshing...' : 'Refresh Agents'"></span>
            </button>
            <button x-show="selectedLeads.length > 0" @click="bulkDelete()"
                    class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                </svg>
                Delete (<span x-text="selectedLeads.length"></span>)
            </button>
            <button x-show="selectedLeads.length > 0" @click="showBulkUpdateModal = true"
                    class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                </svg>
                Bulk Update (<span x-text="selectedLeads.length"></span>)
            </button>
            <button @click="showContactsModal = true; loadContacts()" 
                    class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                </svg>
                Contacts
            </button>
            <button @click="openSettingsModal()" 
                    class="bg-gray-100 text-gray-700 px-3 py-2 rounded-lg hover:bg-gray-200" title="Configure Statuses & Sources">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
            </button>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mt-6">
            <div class="bg-white rounded-lg p-4 shadow-sm border">
                <div class="text-2xl font-bold text-gray-900" x-text="stats.total">0</div>
                <div class="text-sm text-gray-500">Total Leads</div>
            </div>
            <div class="bg-white rounded-lg p-4 shadow-sm border border-blue-200">
                <div class="text-2xl font-bold text-blue-600" x-text="stats.new">0</div>
                <div class="text-sm text-gray-500">New</div>
            </div>
            <div class="bg-white rounded-lg p-4 shadow-sm border border-yellow-200">
                <div class="text-2xl font-bold text-yellow-600" x-text="stats.contacted">0</div>
                <div class="text-sm text-gray-500">Contacted</div>
            </div>
            <div class="bg-white rounded-lg p-4 shadow-sm border border-green-200">
                <div class="text-2xl font-bold text-green-600" x-text="stats.qualified">0</div>
                <div class="text-sm text-gray-500">Qualified</div>
            </div>
            <div class="bg-white rounded-lg p-4 shadow-sm border border-purple-200">
                <div class="text-2xl font-bold text-purple-600" x-text="stats.won">0</div>
                <div class="text-sm text-gray-500">Won</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="bg-white rounded-lg p-4 shadow-sm border mt-6">
            <div class="flex flex-wrap gap-4">
                <div class="flex-1 min-w-[200px]">
                    <input type="text" x-model="filters.search" @input="filterLeads()"
                           placeholder="Search by name, email, phone..."
                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <select x-model="filters.status" @change="filterLeads()"
                        class="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="">All Status</option>
                    <template x-for="status in customStatuses" :key="status.id">
                        <option :value="status.id" x-text="status.label"></option>
                    </template>
                </select>
                <select x-model="filters.source" @change="filterLeads()"
                        class="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="">All Sources</option>
                    <template x-for="source in customSources" :key="source.id">
                        <option :value="source.id" x-text="source.label"></option>
                    </template>
                </select>
                <select x-model="filters.assigned" @change="filterLeads()"
                        class="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="">All Team</option>
                    <template x-for="member in teamMembers" :key="member.id">
                        <option :value="member.id" x-text="member.name"></option>
                    </template>
                </select>
                <select x-model="filters.priority" @change="filterLeads()"
                        class="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="">All Priority</option>
                    <option value="urgent">Urgent</option>
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                    <option value="low">Low</option>
                </select>
                <!-- Settings Button -->
                <button @click="showSettingsModal = true" class="px-3 py-2 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded-lg" title="Configure Statuses & Sources">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>
    <!-- End of fixed header section -->

    <!-- Leads Table (List View) -->
    <div x-show="viewMode === 'list'" class="bg-white rounded-lg shadow-sm border overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left">
                            <input type="checkbox" @change="toggleSelectAll($event)" 
                                   :checked="selectedLeads.length === filteredLeads.length && filteredLeads.length > 0"
                                   class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        </th>
                        <th @click="sortBy('name')" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100">
                            <div class="flex items-center gap-1">
                                Lead
                                <span x-show="sortColumn === 'name'" x-text="sortDirection === 'asc' ? '↑' : '↓'"></span>
                            </div>
                        </th>
                        <th @click="sortBy('channel')" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100">
                            <div class="flex items-center gap-1">
                                Channel
                                <span x-show="sortColumn === 'channel'" x-text="sortDirection === 'asc' ? '↑' : '↓'"></span>
                            </div>
                        </th>
                        <th @click="sortBy('status')" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100">
                            <div class="flex items-center gap-1">
                                Status
                                <span x-show="sortColumn === 'status'" x-text="sortDirection === 'asc' ? '↑' : '↓'"></span>
                            </div>
                        </th>
                        <th @click="sortBy('pf_status')" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100">
                            <div class="flex items-center gap-1">
                                PF Status
                                <span x-show="sortColumn === 'pf_status'" x-text="sortDirection === 'asc' ? '↑' : '↓'"></span>
                            </div>
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Listing</th>
                        <th @click="sortBy('assigned_to_id')" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100">
                            <div class="flex items-center gap-1">
                                Responsible
                                <span x-show="sortColumn === 'assigned_to_id'" x-text="sortDirection === 'asc' ? '↑' : '↓'"></span>
                            </div>
                        </th>
                        <th @click="sortBy('created_at')" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer hover:bg-gray-100">
                            <div class="flex items-center gap-1">
                                Date
                                <span x-show="sortColumn === 'created_at'" x-text="sortDirection === 'asc' ? '↑' : '↓'"></span>
                            </div>
                        </th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <template x-if="loading">
                        <tr>
                            <td colspan="9" class="px-4 py-8 text-center text-gray-500">
                                <div class="flex items-center justify-center gap-2">
                                    <svg class="animate-spin h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    Loading leads...
                                </div>
                            </td>
                        </tr>
                    </template>
                    <template x-if="!loading && filteredLeads.length === 0">
                        <tr>
                            <td colspan="9" class="px-4 py-8 text-center text-gray-500">
                                No leads found
                            </td>
                        </tr>
                    </template>
                    <template x-for="lead in filteredLeads" :key="lead.id">
                        <tr class="hover:bg-gray-50" :class="selectedLeads.includes(lead.id) && 'bg-blue-50'">
                            <td class="px-4 py-3">
                                <input type="checkbox" :value="lead.id" 
                                       :checked="selectedLeads.includes(lead.id)"
                                       @change="toggleSelect(lead.id)"
                                       class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            </td>
                            <td class="px-4 py-3">
                                <div class="font-medium text-gray-900" x-text="lead.name"></div>
                                <div class="text-sm text-gray-500" x-text="lead.email"></div>
                                <div class="text-sm text-gray-500" x-text="lead.phone || lead.whatsapp"></div>
                            </td>
                            <td class="px-4 py-3">
                                <span class="px-2 py-1 text-xs rounded-full"
                                      :class="getSourceClass(lead.source)"
                                      x-text="getSourceLabel(lead.source)"></span>
                            </td>
                            <td class="px-4 py-3">
                                <select :value="lead.status" @change="updateStatus(lead.id, $event.target.value)"
                                        class="text-sm border rounded px-2 py-1"
                                        :class="getStatusClass(lead.status)">
                                    <template x-for="status in customStatuses" :key="status.id">
                                        <option :value="status.id" x-text="status.label" :selected="lead.status === status.id"></option>
                                    </template>
                                </select>
                            </td>
                            <td class="px-4 py-3">
                                <span class="px-2 py-1 text-xs rounded-full"
                                      :class="getPfStatusClass(lead.pf_status)"
                                      x-text="lead.pf_status || '-'"></span>
                            </td>
                            <td class="px-4 py-3 text-sm">
                                <template x-if="lead.pf_listing_id">
                                    <a :href="'https://propertyfinder.ae/go/' + lead.pf_listing_id" 
                                       target="_blank"
                                       class="text-blue-600 hover:text-blue-800 hover:underline"
                                       x-text="lead.listing_reference || lead.pf_listing_id"></a>
                                </template>
                                <template x-if="!lead.pf_listing_id">
                                    <span class="text-gray-500" x-text="lead.listing_reference || '-'"></span>
                                </template>
                            </td>
                            <td class="px-4 py-3">
                                <select :value="lead.assigned_to_id || ''" @change="updateAssignment(lead.id, $event.target.value)"
                                        class="text-sm border rounded px-2 py-1 max-w-[120px]">
                                    <option value="">Unassigned</option>
                                    <template x-for="member in teamMembers" :key="member.id">
                                        <option :value="member.id" x-text="member.name" :selected="lead.assigned_to_id === member.id"></option>
                                    </template>
                                </select>
                            </td>
                            <td class="px-4 py-3 text-sm text-gray-500">
                                <div x-text="formatDate(lead.received_at || lead.created_at)" class="font-medium"></div>
                                <div x-show="lead.received_at && lead.received_at !== lead.created_at" class="text-xs text-gray-400" x-text="'Added: ' + formatDate(lead.created_at)"></div>
                            </td>
                            <td class="px-4 py-3">
                                <div class="flex gap-2">
                                    <button @click="viewLead(lead)" class="text-blue-600 hover:text-blue-800" title="View Details">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                        </svg>
                                    </button>
                                    <a x-show="lead.response_link" :href="lead.response_link" target="_blank" 
                                       class="text-indigo-600 hover:text-indigo-800" title="Reply in PropertyFinder">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/>
                                        </svg>
                                    </a>
                                    <a :href="'https://wa.me/' + (lead.whatsapp || lead.phone)?.replace(/[^0-9]/g, '')" target="_blank" 
                                       class="text-green-600 hover:text-green-800" x-show="lead.phone || lead.whatsapp" title="WhatsApp">
                                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                                        </svg>
                                    </a>
                                    <button @click="deleteLead(lead.id)" class="text-red-600 hover:text-red-800" title="Delete">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                        </svg>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Kanban View (isolated scrollable area) -->
    <div x-show="viewMode === 'kanban'" class="w-full overflow-x-auto">
        <div class="pb-4">
            <div class="inline-flex gap-4 min-w-max">
                <!-- Kanban Columns -->
                <template x-for="(column, colIndex) in kanbanColumns" :key="column.status">
                    <div class="w-72 sm:w-80 flex-shrink-0 bg-gray-50 rounded-lg"
                         @dragover.prevent="handleColumnDragOver($event, column.status, colIndex)"
                         @dragleave="handleColumnDragLeave($event)"
                         @drop.prevent="handleColumnDrop($event, column.status, colIndex)"
                         :class="[dragOverStatus === column.status && !draggingColumnIndex && 'ring-2 ring-blue-400 ring-inset', 
                                  dragOverColumnIndex === colIndex && draggingColumnIndex !== null && 'ring-2 ring-purple-400 ring-inset']">
                        <!-- Column Header (draggable for reordering) -->
                        <div class="p-3 border-b bg-white rounded-t-lg cursor-move"
                             draggable="true"
                             @dragstart="startColumnDrag($event, colIndex)"
                             @dragend="endColumnDrag($event)">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"/>
                                    </svg>
                                    <div class="w-3 h-3 rounded-full" :class="column.color"></div>
                                    <span class="font-medium text-gray-900" x-text="column.label"></span>
                                </div>
                                <span class="bg-gray-200 text-gray-600 text-xs px-2 py-0.5 rounded-full" 
                                      x-text="getLeadsByStatus(column.status).length"></span>
                            </div>
                        </div>
                    
                        <!-- Column Cards -->
                        <div class="p-2 space-y-2 max-h-[calc(100vh-350px)] overflow-y-auto min-h-[100px]">
                            <template x-for="lead in getLeadsByStatus(column.status)" :key="lead.id">
                                <div @click="viewLead(lead)" 
                                     draggable="true"
                                     @dragstart="dragStart($event, lead)"
                                     @dragend="dragEnd($event)"
                                     :class="[draggingLeadId === lead.id && 'opacity-50', selectedLeads.includes(lead.id) && 'ring-2 ring-blue-500']"
                                     class="bg-white rounded-lg shadow-sm border p-3 cursor-grab hover:shadow-md transition-shadow active:cursor-grabbing relative">
                                    <!-- Selection Checkbox -->
                                    <div class="absolute top-2 right-2" @click.stop>
                                        <input type="checkbox" :checked="selectedLeads.includes(lead.id)" 
                                               @change="toggleLeadSelection(lead.id)"
                                               class="rounded border-gray-300 text-blue-600 focus:ring-blue-500 w-4 h-4">
                                    </div>
                                    <!-- Lead Name & Channel -->
                                    <div class="flex items-start justify-between mb-2 pr-6">
                                        <div class="font-medium text-gray-900 truncate pr-2" x-text="lead.name"></div>
                                        <span class="px-1.5 py-0.5 text-xs rounded flex-shrink-0"
                                              :class="getSourceClass(lead.source)"
                                              x-text="lead.channel || getSourceLabel(lead.source)"></span>
                                    </div>
                                    
                                    <!-- Contact Info -->
                                    <div class="text-sm text-gray-500 mb-2">
                                        <div x-show="lead.email" class="truncate" x-text="lead.email"></div>
                                        <div x-show="lead.phone" x-text="lead.phone"></div>
                                    </div>
                                    
                                    <!-- Listing -->
                                    <div x-show="lead.listing_reference || lead.pf_listing_id" class="text-xs text-gray-400 mb-2">
                                        <span class="bg-gray-100 px-1.5 py-0.5 rounded" x-text="lead.listing_reference || lead.pf_listing_id"></span>
                                    </div>
                                    
                                    <!-- Footer: Responsible & Date -->
                                    <div class="flex items-center justify-between text-xs text-gray-400 mt-2 pt-2 border-t">
                                        <div class="flex items-center gap-1 truncate">
                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                            </svg>
                                            <span x-text="lead.assigned_to_name || lead.pf_agent_name || 'Unassigned'"></span>
                                        </div>
                                        <div x-text="formatDateShort(lead.received_at || lead.created_at)"></div>
                                    </div>
                                    
                                    <!-- Quick Actions -->
                                    <div class="flex gap-2 mt-2 pt-2 border-t">
                                        <a x-show="lead.phone || lead.whatsapp" 
                                           :href="'https://wa.me/' + (lead.whatsapp || lead.phone)?.replace(/[^0-9]/g, '')" 
                                           target="_blank" @click.stop
                                           class="text-green-600 hover:text-green-800 p-1" title="WhatsApp">
                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                                            </svg>
                                        </a>
                                        <a x-show="lead.response_link" :href="lead.response_link" target="_blank" @click.stop
                                           class="text-indigo-600 hover:text-indigo-800 p-1" title="Reply in PF">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/>
                                            </svg>
                                        </a>
                                        <select :value="lead.status" @click.stop @change="updateStatus(lead.id, $event.target.value)"
                                                class="ml-auto text-xs border rounded px-1 py-0.5"
                                                :class="getStatusClass(lead.status)">
                                            <template x-for="s in customStatuses" :key="s.id">
                                                <option :value="s.id" x-text="s.label" :selected="lead.status === s.id"></option>
                                            </template>
                                        </select>
                                    </div>
                                </div>
                            </template>
                            
                            <!-- Empty State -->
                            <div x-show="getLeadsByStatus(column.status).length === 0" class="text-center py-8 text-gray-400 text-sm">
                                No leads
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <!-- Add Lead Modal -->
    <div x-show="showAddModal" x-cloak class="fixed inset-0 z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-black opacity-50" @click="showAddModal = false"></div>
            <div class="relative bg-white rounded-lg shadow-xl max-w-lg w-full p-6">
                <h3 class="text-lg font-semibold mb-4">Add New Lead</h3>
                <form @submit.prevent="addLead()">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700">Name *</label>
                            <input type="text" x-model="newLead.name" required
                                   class="mt-1 w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Email</label>
                            <input type="email" x-model="newLead.email"
                                   class="mt-1 w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Phone</label>
                            <input type="text" x-model="newLead.phone"
                                   class="mt-1 w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Source</label>
                            <select x-model="newLead.source"
                                    class="mt-1 w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                                <template x-for="src in customSources" :key="src.id">
                                    <option :value="src.id" x-text="src.label"></option>
                                </template>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Priority</label>
                            <select x-model="newLead.priority"
                                    class="mt-1 w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="low">Low</option>
                                <option value="medium">Medium</option>
                                <option value="high">High</option>
                                <option value="urgent">Urgent</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Assign To</label>
                            <select x-model="newLead.assigned_to_id"
                                    class="mt-1 w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">Unassigned</option>
                                <template x-for="member in teamMembers" :key="member.id">
                                    <option :value="member.id" x-text="member.name"></option>
                                </template>
                            </select>
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700">Listing Reference</label>
                            <input type="text" x-model="newLead.listing_reference"
                                   class="mt-1 w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700">Message</label>
                            <textarea x-model="newLead.message" rows="3"
                                      class="mt-1 w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end gap-3">
                        <button type="button" @click="showAddModal = false"
                                class="px-4 py-2 border rounded-lg hover:bg-gray-50">Cancel</button>
                        <button type="submit"
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Add Lead</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- View Lead Modal -->
    <div x-show="showViewModal" x-cloak class="fixed inset-0 z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-black opacity-50" @click="showViewModal = false"></div>
            <div class="relative bg-white rounded-lg shadow-xl max-w-2xl w-full p-6" x-show="selectedLead">
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-lg font-semibold" x-text="selectedLead?.name"></h3>
                    <button @click="showViewModal = false" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <div class="text-sm text-gray-500">Email</div>
                        <div class="font-medium" x-text="selectedLead?.email || '-'"></div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-500">Phone</div>
                        <div class="font-medium" x-text="selectedLead?.phone || '-'"></div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-500">Source</div>
                        <select :value="selectedLead?.source" @change="updateLeadField(selectedLead.id, 'source', $event.target.value)"
                                class="w-full px-2 py-1 border rounded text-sm font-medium">
                            <template x-for="src in customSources" :key="src.id">
                                <option :value="src.id" x-text="src.label" :selected="selectedLead?.source === src.id"></option>
                            </template>
                        </select>
                    </div>
                    <div>
                        <div class="text-sm text-gray-500">Channel</div>
                        <div class="font-medium" x-text="selectedLead?.channel || '-'"></div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-500">Status</div>
                        <select :value="selectedLead?.status" @change="updateLeadField(selectedLead.id, 'status', $event.target.value)"
                                class="w-full px-2 py-1 border rounded text-sm font-medium"
                                :class="getStatusClass(selectedLead?.status)">
                            <template x-for="s in customStatuses" :key="s.id">
                                <option :value="s.id" x-text="s.label" :selected="selectedLead?.status === s.id"></option>
                            </template>
                        </select>
                    </div>
                    <div>
                        <div class="text-sm text-gray-500">Priority</div>
                        <select :value="selectedLead?.priority" @change="updateLeadField(selectedLead.id, 'priority', $event.target.value)"
                                class="w-full px-2 py-1 border rounded text-sm font-medium">
                            <option value="urgent">Urgent</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                    <div>
                        <div class="text-sm text-gray-500">Listing Reference</div>
                        <div class="font-medium" x-text="selectedLead?.listing_reference || '-'"></div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-500">Responsible Person</div>
                        <select :value="selectedLead?.assigned_to_id || ''" @change="updateLeadField(selectedLead.id, 'assigned_to_id', $event.target.value || null)"
                                class="w-full px-2 py-1 border rounded text-sm font-medium">
                            <option value="">Unassigned</option>
                            <template x-for="member in teamMembers" :key="member.id">
                                <option :value="member.id" x-text="member.name" :selected="selectedLead?.assigned_to_id == member.id"></option>
                            </template>
                        </select>
                    </div>
                    <div>
                        <div class="text-sm text-gray-500">PF Agent (PropertyFinder)</div>
                        <div class="font-medium text-gray-400" x-text="selectedLead?.pf_agent_name || '-'"></div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-500">PF Status</div>
                        <div class="font-medium">
                            <span class="px-2 py-1 text-xs rounded-full" 
                                  :class="getPfStatusClass(selectedLead?.pf_status)"
                                  x-text="selectedLead?.pf_status || '-'"></span>
                        </div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-500">Received Date (PF)</div>
                        <div class="font-medium" x-text="selectedLead?.received_at ? formatDate(selectedLead.received_at) : '-'"></div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-500">Added Date</div>
                        <div class="font-medium" x-text="formatDate(selectedLead?.created_at)"></div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-500">Listing</div>
                        <div class="font-medium">
                            <template x-if="selectedLead?.pf_listing_id">
                                <a :href="'https://propertyfinder.ae/go/' + selectedLead.pf_listing_id" 
                                   target="_blank"
                                   class="text-blue-600 hover:text-blue-800 hover:underline"
                                   x-text="selectedLead?.listing_reference || selectedLead?.pf_listing_id"></a>
                            </template>
                            <template x-if="!selectedLead?.pf_listing_id">
                                <span x-text="selectedLead?.listing_reference || '-'"></span>
                            </template>
                        </div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-500">Response Link</div>
                        <div class="font-medium">
                            <template x-if="selectedLead?.response_link">
                                <a :href="selectedLead.response_link" 
                                   target="_blank"
                                   class="text-indigo-600 hover:text-indigo-800 hover:underline">
                                   Reply in PF <i class="fas fa-external-link-alt ml-1"></i>
                                </a>
                            </template>
                            <template x-if="!selectedLead?.response_link">
                                <span>-</span>
                            </template>
                        </div>
                    </div>
                    <div class="col-span-2">
                        <div class="text-sm text-gray-500">Message</div>
                        <div class="font-medium whitespace-pre-wrap" x-text="selectedLead?.message || '-'"></div>
                    </div>
                    <div class="col-span-2">
                        <div class="text-sm text-gray-500">Notes</div>
                        <textarea :value="selectedLead?.notes || ''" @input="selectedLead && (selectedLead.notes = $event.target.value)" @change="selectedLead && updateNotes(selectedLead.id, selectedLead.notes)"
                                  rows="3" class="w-full px-3 py-2 border rounded-lg mt-1"
                                  placeholder="Add notes..."></textarea>
                    </div>
                    
                    <!-- Comments Section -->
                    <div class="col-span-2 mt-4 pt-4 border-t">
                        <div class="flex items-center justify-between mb-3">
                            <div class="text-sm font-medium text-gray-700">Comments</div>
                            <span class="text-xs text-gray-400" x-text="leadComments.length + ' comment(s)'"></span>
                        </div>
                        
                        <!-- Add Comment -->
                        <div class="flex gap-2 mb-4">
                            <input type="text" x-model="newComment" @keyup.enter="addComment()"
                                   class="flex-1 px-3 py-2 border rounded-lg text-sm"
                                   placeholder="Add a comment...">
                            <button @click="addComment()" :disabled="!newComment.trim() || addingComment"
                                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 text-sm">
                                <span x-text="addingComment ? '...' : 'Add'"></span>
                            </button>
                        </div>
                        
                        <!-- Comments List -->
                        <div class="space-y-3 max-h-60 overflow-y-auto">
                            <template x-if="loadingComments">
                                <div class="text-center py-4 text-gray-400 text-sm">Loading comments...</div>
                            </template>
                            <template x-if="!loadingComments && leadComments.length === 0">
                                <div class="text-center py-4 text-gray-400 text-sm">No comments yet</div>
                            </template>
                            <template x-for="comment in leadComments" :key="comment.id">
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <div class="flex items-start justify-between">
                                        <div class="flex items-center gap-2 text-xs text-gray-500">
                                            <span class="font-medium text-gray-700" x-text="comment.user_name"></span>
                                            <span>•</span>
                                            <span x-text="formatDateShort(comment.created_at)"></span>
                                        </div>
                                        <button @click="deleteComment(comment.id)" 
                                                class="text-gray-400 hover:text-red-500 p-1" title="Delete">
                                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                            </svg>
                                        </button>
                                    </div>
                                    <div class="text-sm text-gray-700 mt-1 whitespace-pre-wrap" x-text="comment.content"></div>
                                </div>
                            </template>
                        </div>
                    </div>
                    
                    <!-- Actions -->
                    <div class="col-span-2 mt-4 pt-4 border-t flex gap-3 flex-wrap">
                        <button @click="saveContactFromLead(selectedLead)" 
                                class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center gap-2 text-sm">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/>
                            </svg>
                            Save to Contacts
                        </button>
                        <a x-show="selectedLead?.phone || selectedLead?.whatsapp" 
                           :href="'https://wa.me/' + (selectedLead?.whatsapp || selectedLead?.phone)?.replace(/[^0-9]/g, '')" 
                           target="_blank"
                           class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 flex items-center gap-2 text-sm">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                            </svg>
                            WhatsApp
                        </a>
                        <a x-show="selectedLead?.phone" 
                           :href="'tel:' + selectedLead?.phone"
                           class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2 text-sm">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                            </svg>
                            Call
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div x-show="showSettingsModal" x-cloak class="fixed inset-0 z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-black opacity-50" @click="showSettingsModal = false"></div>
            <div class="relative bg-white rounded-lg shadow-xl max-w-2xl w-full p-6 max-h-[90vh] overflow-y-auto">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-semibold">Lead Settings</h3>
                    <button @click="showSettingsModal = false" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                
                <div class="grid grid-cols-2 gap-6">
                    <!-- Statuses -->
                    <div>
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-medium text-gray-900">Lead Statuses</h4>
                            <button @click="addStatus()" class="text-blue-600 hover:text-blue-800 text-sm">+ Add Status</button>
                        </div>
                        <div class="space-y-2">
                            <template x-for="(status, index) in editStatuses" :key="status.id">
                                <div class="flex items-center gap-2">
                                    <select x-model="status.color" class="w-20 px-2 py-1.5 text-xs border rounded">
                                        <option value="blue">Blue</option>
                                        <option value="yellow">Yellow</option>
                                        <option value="green">Green</option>
                                        <option value="purple">Purple</option>
                                        <option value="orange">Orange</option>
                                        <option value="red">Red</option>
                                        <option value="emerald">Emerald</option>
                                        <option value="gray">Gray</option>
                                        <option value="pink">Pink</option>
                                        <option value="indigo">Indigo</option>
                                    </select>
                                    <input type="text" x-model="status.label" @input="updateStatusId(status)"
                                           class="flex-1 px-2 py-1.5 text-sm border rounded focus:ring-2 focus:ring-blue-500"
                                           placeholder="Enter status name">
                                    <button @click="removeStatus(index)" :disabled="editStatuses.length <= 1"
                                            class="text-red-500 hover:text-red-700 disabled:opacity-30 disabled:cursor-not-allowed p-1">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                        </svg>
                                    </button>
                                </div>
                            </template>
                        </div>
                    </div>
                    
                    <!-- Sources -->
                    <div>
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-medium text-gray-900">Lead Sources</h4>
                            <button @click="addSource()" class="text-blue-600 hover:text-blue-800 text-sm">+ Add Source</button>
                        </div>
                        <div class="space-y-2">
                            <template x-for="(source, index) in editSources" :key="source.id">
                                <div class="flex items-center gap-2">
                                    <select x-model="source.color" class="w-20 px-2 py-1.5 text-xs border rounded">
                                        <option value="blue">Blue</option>
                                        <option value="yellow">Yellow</option>
                                        <option value="green">Green</option>
                                        <option value="purple">Purple</option>
                                        <option value="orange">Orange</option>
                                        <option value="red">Red</option>
                                        <option value="emerald">Emerald</option>
                                        <option value="gray">Gray</option>
                                        <option value="pink">Pink</option>
                                        <option value="indigo">Indigo</option>
                                    </select>
                                    <input type="text" x-model="source.label" @input="updateSourceId(source)"
                                           class="flex-1 px-2 py-1.5 text-sm border rounded focus:ring-2 focus:ring-blue-500"
                                           placeholder="Enter source name">
                                    <button @click="removeSource(index)" :disabled="editSources.length <= 1"
                                            class="text-red-500 hover:text-red-700 disabled:opacity-30 disabled:cursor-not-allowed p-1">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                        </svg>
                                    </button>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
                
                <!-- Cleanup Section -->
                <div class="mt-4 pt-4 border-t">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-sm font-medium text-gray-700">Cleanup Invalid Sources</div>
                            <div class="text-xs text-gray-500">Fix leads with invalid source IDs (like source_123...)</div>
                        </div>
                        <button @click="cleanupSources()" :disabled="cleaningUp"
                                class="px-3 py-1.5 text-sm bg-orange-100 text-orange-700 rounded hover:bg-orange-200 disabled:opacity-50">
                            <span x-text="cleaningUp ? 'Fixing...' : 'Fix Now'"></span>
                        </button>
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" @click="showSettingsModal = false"
                            class="px-4 py-2 border rounded-lg hover:bg-gray-50">Cancel</button>
                    <button @click="saveConfig()" :disabled="savingConfig"
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50">
                        <span x-text="savingConfig ? 'Saving...' : 'Save Settings'"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Update Modal -->
    <div x-show="showBulkUpdateModal" x-cloak class="fixed inset-0 z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-black opacity-50" @click="showBulkUpdateModal = false"></div>
            <div class="relative bg-white rounded-lg shadow-xl max-w-md w-full p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">Bulk Update <span x-text="selectedLeads.length"></span> Leads</h3>
                    <button @click="showBulkUpdateModal = false" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                
                <p class="text-sm text-gray-500 mb-4">Leave fields empty to keep current values</p>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                        <select x-model="bulkUpdate.status" class="w-full px-3 py-2 border rounded-lg">
                            <option value="">-- No Change --</option>
                            <template x-for="s in customStatuses" :key="s.id">
                                <option :value="s.id" x-text="s.label"></option>
                            </template>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Source</label>
                        <select x-model="bulkUpdate.source" class="w-full px-3 py-2 border rounded-lg">
                            <option value="">-- No Change --</option>
                            <template x-for="src in customSources" :key="src.id">
                                <option :value="src.id" x-text="src.label"></option>
                            </template>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Assign To</label>
                        <select x-model="bulkUpdate.assigned_to_id" class="w-full px-3 py-2 border rounded-lg">
                            <option value="">-- No Change --</option>
                            <option value="null">Unassigned</option>
                            <template x-for="member in teamMembers" :key="member.id">
                                <option :value="member.id" x-text="member.name"></option>
                            </template>
                        </select>
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" @click="showBulkUpdateModal = false"
                            class="px-4 py-2 border rounded-lg hover:bg-gray-50">Cancel</button>
                    <button @click="applyBulkUpdate()" :disabled="bulkUpdating"
                            class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50">
                        <span x-text="bulkUpdating ? 'Updating...' : 'Apply Update'"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Contacts Modal -->
    <div x-show="showContactsModal" x-cloak class="fixed inset-0 z-50 overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="fixed inset-0 bg-black opacity-50" @click="showContactsModal = false"></div>
            <div class="relative bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] flex flex-col">
                <!-- Header -->
                <div class="p-4 border-b flex items-center justify-between">
                    <h3 class="text-lg font-semibold">Contacts</h3>
                    <button @click="showContactsModal = false" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                
                <!-- Add/Edit Contact Form -->
                <div class="p-4 border-b bg-gray-50">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Name *</label>
                            <input type="text" x-model="newContact.name" placeholder="Contact name"
                                   class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-green-500">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Country Code</label>
                            <select x-model="newContact.country_code" 
                                    class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-green-500">
                                <template x-for="cc in countryCodes" :key="cc[0]">
                                    <option :value="cc[0]" x-text="cc[0] + ' ' + cc[1]"></option>
                                </template>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Phone *</label>
                            <input type="text" x-model="newContact.phone" placeholder="Phone number"
                                   class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-green-500">
                        </div>
                        <div class="flex items-end">
                            <button @click="saveContact()" :disabled="savingContact || !newContact.name || !newContact.phone"
                                    class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 text-sm">
                                <span x-text="editingContactId ? 'Update' : 'Add Contact'"></span>
                            </button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Email</label>
                            <input type="email" x-model="newContact.email" placeholder="Email"
                                   class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-green-500">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Company</label>
                            <input type="text" x-model="newContact.company" placeholder="Company"
                                   class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-green-500">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Notes</label>
                            <input type="text" x-model="newContact.notes" placeholder="Notes"
                                   class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-green-500">
                        </div>
                    </div>
                    <div x-show="editingContactId" class="mt-2">
                        <button @click="cancelEditContact()" class="text-sm text-gray-500 hover:text-gray-700">
                            Cancel editing
                        </button>
                    </div>
                </div>
                
                <!-- Search -->
                <div class="p-4 border-b">
                    <input type="text" x-model="contactSearch" @input="loadContacts()" 
                           placeholder="Search contacts..."
                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500">
                </div>
                
                <!-- Contacts List -->
                <div class="flex-1 overflow-y-auto p-4">
                    <div x-show="loadingContacts" class="text-center py-8 text-gray-500">
                        Loading contacts...
                    </div>
                    <div x-show="!loadingContacts && contacts.length === 0" class="text-center py-8 text-gray-400">
                        No contacts found
                    </div>
                    <div x-show="!loadingContacts" class="space-y-2">
                        <template x-for="contact in contacts" :key="contact.id">
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100">
                                <div class="flex-1">
                                    <div class="font-medium text-gray-900" x-text="contact.name"></div>
                                    <div class="text-sm text-gray-600">
                                        <span x-text="contact.full_phone"></span>
                                        <span x-show="contact.email" class="ml-2">• <span x-text="contact.email"></span></span>
                                        <span x-show="contact.company" class="ml-2">• <span x-text="contact.company"></span></span>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <a :href="'https://wa.me/' + contact.full_phone.replace(/[^0-9]/g, '')" 
                                       target="_blank" class="text-green-600 hover:text-green-800 p-2" title="WhatsApp">
                                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                                        </svg>
                                    </a>
                                    <a :href="'tel:' + contact.full_phone" 
                                       class="text-blue-600 hover:text-blue-800 p-2" title="Call">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                                        </svg>
                                    </a>
                                    <button @click="editContact(contact)" class="text-gray-600 hover:text-gray-800 p-2" title="Edit">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                        </svg>
                                    </button>
                                    <button @click="deleteContact(contact.id)" class="text-red-600 hover:text-red-800 p-2" title="Delete">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function leadsManager() {
    return {
        leads: [],
        filteredLeads: [],
        selectedLeads: [],
        loading: true,
        syncing: false,
        refreshingAgents: false,
        showAddModal: false,
        showViewModal: false,
        selectedLead: null,
        filters: { search: '', status: '', source: '', priority: '', assigned: '' },
        sortColumn: 'created_at',
        sortDirection: 'desc',
        stats: { total: 0, new: 0, contacted: 0, qualified: 0, won: 0 },
        newLead: { name: '', email: '', phone: '', source: '', priority: 'medium', message: '', listing_reference: '', assigned_to_id: '' },
        viewMode: localStorage.getItem('leads_view_mode') || 'list',
        
        // Custom configuration (loaded from API)
        customStatuses: [],
        customSources: [],
        teamMembers: [],
        showSettingsModal: false,
        editStatuses: [],
        editSources: [],
        savingConfig: false,
        cleaningUp: false,
        
        // Bulk update
        showBulkUpdateModal: false,
        bulkUpdate: { status: '', source: '', assigned_to_id: '' },
        bulkUpdating: false,
        
        // Comments
        leadComments: [],
        newComment: '',
        loadingComments: false,
        addingComment: false,
        
        // Drag and drop for Kanban (leads)
        draggingLeadId: null,
        dragOverStatus: null,
        
        // Drag and drop for Kanban columns (reordering)
        draggingColumnIndex: null,
        dragOverColumnIndex: null,
        
        // Contacts
        showContactsModal: false,
        contacts: [],
        loadingContacts: false,
        contactSearch: '',
        countryCodes: [],
        newContact: { name: '', phone: '', country_code: '+971', email: '', company: '', notes: '' },
        editingContactId: null,
        savingContact: false,
        
        // Kanban columns (derived from customStatuses)
        get kanbanColumns() {
            return this.customStatuses.map(s => ({
                status: s.id,
                label: s.label,
                color: 'bg-' + (s.color || 'gray') + '-500'
            }));
        },
        
        get uniqueAgents() {
            const agents = new Set();
            this.leads.forEach(l => {
                if (l.pf_agent_name) agents.add(l.pf_agent_name);
                if (l.assigned_to_name) agents.add(l.assigned_to_name);
            });
            return Array.from(agents).sort();
        },
        
        async init() {
            await this.loadConfig();
            await this.loadLeads();
            // Watch viewMode changes and save to localStorage
            this.$watch('viewMode', (val) => {
                localStorage.setItem('leads_view_mode', val);
            });
        },
        
        async loadConfig() {
            try {
                const resp = await fetch('/api/leads/config');
                const data = await resp.json();
                this.customStatuses = data.statuses || [];
                this.customSources = data.sources || [];
                this.teamMembers = data.team_members || [];
                // Set default source for new lead if available
                if (this.customSources.length > 0 && !this.newLead.source) {
                    this.newLead.source = this.customSources[0].id;
                }
            } catch (e) {
                console.error('Failed to load config:', e);
            }
        },
        
        async loadLeads() {
            this.loading = true;
            this.selectedLeads = [];
            try {
                const resp = await fetch('/api/leads');
                const data = await resp.json();
                this.leads = data.leads || [];
                this.filterLeads();
                this.updateStats();
            } catch (e) {
                console.error('Failed to load leads:', e);
            }
            this.loading = false;
        },
        
        toggleSelect(id) {
            const idx = this.selectedLeads.indexOf(id);
            if (idx > -1) {
                this.selectedLeads.splice(idx, 1);
            } else {
                this.selectedLeads.push(id);
            }
        },
        
        toggleSelectAll(event) {
            if (event.target.checked) {
                this.selectedLeads = this.filteredLeads.map(l => l.id);
            } else {
                this.selectedLeads = [];
            }
        },
        
        async bulkDelete() {
            if (!confirm(`Are you sure you want to delete ${this.selectedLeads.length} leads? This cannot be undone.`)) {
                return;
            }
            try {
                const resp = await fetch('/api/leads/bulk-delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ids: this.selectedLeads })
                });
                const data = await resp.json();
                if (data.success) {
                    alert(`Deleted ${data.deleted} leads`);
                    await this.loadLeads();
                } else {
                    alert('Failed to delete: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                console.error('Failed to bulk delete:', e);
                alert('Failed to delete: ' + e.message);
            }
        },
        
        async applyBulkUpdate() {
            this.bulkUpdating = true;
            try {
                const payload = { ids: this.selectedLeads };
                if (this.bulkUpdate.status) payload.status = this.bulkUpdate.status;
                if (this.bulkUpdate.source) payload.source = this.bulkUpdate.source;
                if (this.bulkUpdate.assigned_to_id !== '') payload.assigned_to_id = this.bulkUpdate.assigned_to_id || null;
                
                const resp = await fetch('/api/leads/bulk-update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await resp.json();
                if (data.success) {
                    this.showBulkUpdateModal = false;
                    this.bulkUpdate = { status: '', source: '', assigned_to_id: '' };
                    await this.loadLeads();
                    alert(`Updated ${data.updated} leads`);
                } else {
                    alert('Failed to update: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                console.error('Failed to bulk update:', e);
                alert('Failed to update: ' + e.message);
            }
            this.bulkUpdating = false;
        },
        
        async loadComments(leadId) {
            this.loadingComments = true;
            this.leadComments = [];
            try {
                const resp = await fetch(`/api/leads/${leadId}/comments`);
                const data = await resp.json();
                this.leadComments = data.comments || [];
            } catch (e) {
                console.error('Failed to load comments:', e);
            }
            this.loadingComments = false;
        },
        
        async addComment() {
            if (!this.newComment.trim() || !this.selectedLead) return;
            this.addingComment = true;
            try {
                const resp = await fetch(`/api/leads/${this.selectedLead.id}/comments`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: this.newComment })
                });
                const data = await resp.json();
                if (data.success) {
                    this.leadComments.unshift(data.comment);
                    this.newComment = '';
                } else {
                    alert('Failed to add comment: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                console.error('Failed to add comment:', e);
            }
            this.addingComment = false;
        },
        
        async deleteComment(commentId) {
            if (!confirm('Delete this comment?')) return;
            try {
                const resp = await fetch(`/api/leads/${this.selectedLead.id}/comments/${commentId}`, {
                    method: 'DELETE'
                });
                const data = await resp.json();
                if (data.success) {
                    this.leadComments = this.leadComments.filter(c => c.id !== commentId);
                } else {
                    alert('Failed to delete: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                console.error('Failed to delete comment:', e);
            }
        },
        
        async refreshAgents() {
            this.refreshingAgents = true;
            try {
                const resp = await fetch('/api/leads/refresh-agents', { method: 'POST' });
                const data = await resp.json();
                if (data.success) {
                    alert(`Updated ${data.updated} of ${data.total} leads`);
                    await this.loadLeads();
                } else {
                    alert('Failed to refresh: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                console.error('Failed to refresh agents:', e);
                alert('Failed to refresh: ' + e.message);
            }
            this.refreshingAgents = false;
        },
        
        sortBy(column) {
            if (this.sortColumn === column) {
                this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                this.sortColumn = column;
                this.sortDirection = 'asc';
            }
            this.filterLeads();
        },
        
        filterLeads() {
            let filtered = [...this.leads];
            if (this.filters.search) {
                const s = this.filters.search.toLowerCase();
                filtered = filtered.filter(l => 
                    l.name?.toLowerCase().includes(s) ||
                    l.email?.toLowerCase().includes(s) ||
                    l.phone?.includes(s)
                );
            }
            if (this.filters.status) filtered = filtered.filter(l => l.status === this.filters.status);
            if (this.filters.source) filtered = filtered.filter(l => l.source === this.filters.source);
            if (this.filters.priority) filtered = filtered.filter(l => l.priority === this.filters.priority);
            if (this.filters.assigned) filtered = filtered.filter(l => l.pf_agent_name === this.filters.assigned || l.assigned_to_name === this.filters.assigned);
            
            // Apply sorting
            filtered.sort((a, b) => {
                let aVal = a[this.sortColumn] || '';
                let bVal = b[this.sortColumn] || '';
                
                // Handle dates
                if (this.sortColumn === 'created_at' || this.sortColumn === 'received_at') {
                    aVal = aVal ? new Date(aVal).getTime() : 0;
                    bVal = bVal ? new Date(bVal).getTime() : 0;
                } else if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }
                
                if (aVal < bVal) return this.sortDirection === 'asc' ? -1 : 1;
                if (aVal > bVal) return this.sortDirection === 'asc' ? 1 : -1;
                return 0;
            });
            
            this.filteredLeads = filtered;
        },
        
        updateStats() {
            this.stats.total = this.leads.length;
            this.stats.new = this.leads.filter(l => l.status === 'new').length;
            this.stats.contacted = this.leads.filter(l => l.status === 'contacted').length;
            this.stats.qualified = this.leads.filter(l => l.status === 'qualified').length;
            this.stats.won = this.leads.filter(l => l.status === 'won').length;
        },
        
        async addLead() {
            try {
                const resp = await fetch('/api/leads', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.newLead)
                });
                if (resp.ok) {
                    this.showAddModal = false;
                    this.newLead = { name: '', email: '', phone: '', source: this.customSources[0]?.id || '', priority: 'medium', message: '', listing_reference: '', assigned_to_id: '' };
                    await this.loadLeads();
                }
            } catch (e) {
                console.error('Failed to add lead:', e);
            }
        },
        
        async updateStatus(id, status) {
            try {
                await fetch(`/api/leads/${id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });
                const lead = this.leads.find(l => l.id === id);
                if (lead) lead.status = status;
                this.updateStats();
            } catch (e) {
                console.error('Failed to update status:', e);
            }
        },
        
        async updateNotes(id, notes) {
            try {
                await fetch(`/api/leads/${id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ notes })
                });
            } catch (e) {
                console.error('Failed to update notes:', e);
            }
        },
        
        // Toggle lead selection for bulk operations (works in both List and Kanban views)
        toggleLeadSelection(id) {
            const idx = this.selectedLeads.indexOf(id);
            if (idx > -1) {
                this.selectedLeads.splice(idx, 1);
            } else {
                this.selectedLeads.push(id);
            }
        },
        
        // Update any field on a lead (used in View Lead Modal)
        async updateLeadField(id, field, value) {
            try {
                const payload = {};
                payload[field] = value;
                
                await fetch(`/api/leads/${id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                // Update local state
                const lead = this.leads.find(l => l.id === id);
                if (lead) {
                    lead[field] = value;
                    // If assigned_to_id changed, update the display name
                    if (field === 'assigned_to_id') {
                        const member = this.teamMembers.find(m => m.id == value);
                        lead.assigned_to_name = member ? member.name : null;
                    }
                }
                if (this.selectedLead && this.selectedLead.id === id) {
                    this.selectedLead[field] = value;
                    if (field === 'assigned_to_id') {
                        const member = this.teamMembers.find(m => m.id == value);
                        this.selectedLead.assigned_to_name = member ? member.name : null;
                    }
                }
                this.filterLeads();
                this.updateStats();
            } catch (e) {
                console.error('Failed to update lead field:', e);
            }
        },
        
        async deleteLead(id) {
            if (!confirm('Delete this lead?')) return;
            try {
                await fetch(`/api/leads/${id}`, { method: 'DELETE' });
                this.leads = this.leads.filter(l => l.id !== id);
                this.filterLeads();
                this.updateStats();
            } catch (e) {
                console.error('Failed to delete lead:', e);
            }
        },
        
        async syncFromPF() {
            this.syncing = true;
            try {
                const resp = await fetch('/api/leads/sync-pf', { method: 'POST' });
                if (!resp.ok) {
                    const text = await resp.text();
                    console.error('Sync failed with status:', resp.status, text.substring(0, 500));
                    alert('Failed to sync: Server error ' + resp.status);
                    this.syncing = false;
                    return;
                }
                const data = await resp.json();
                if (data.success) {
                    await this.loadLeads();
                    // Show detailed message
                    let msg = `PropertyFinder Sync Complete\n\n`;
                    msg += `Total leads found: ${data.total || 0}\n`;
                    msg += `New leads imported: ${data.imported || 0}\n`;
                    msg += `Already synced: ${data.skipped || 0}`;
                    alert(msg);
                } else {
                    alert('Failed to sync: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                console.error('Failed to sync:', e);
                alert('Failed to sync: ' + e.message);
            }
            this.syncing = false;
        },
        
        viewLead(lead) {
            this.selectedLead = { ...lead };
            this.newComment = '';
            this.leadComments = [];
            this.showViewModal = true;
            this.loadComments(lead.id);
        },
        
        // Get leads filtered by status (for kanban)
        getLeadsByStatus(status) {
            return this.filteredLeads.filter(l => l.status === status);
        },
        
        // Drag and drop handlers for Kanban leads
        dragStart(event, lead) {
            this.draggingLeadId = lead.id;
            this.draggingColumnIndex = null; // Not dragging a column
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', JSON.stringify({ type: 'lead', id: lead.id }));
            setTimeout(() => {
                event.target.classList.add('opacity-50');
            }, 0);
        },
        
        dragEnd(event) {
            this.draggingLeadId = null;
            this.dragOverStatus = null;
            event.target.classList.remove('opacity-50');
        },
        
        // Column drag handlers
        startColumnDrag(event, index) {
            this.draggingColumnIndex = index;
            this.draggingLeadId = null; // Not dragging a lead
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', JSON.stringify({ type: 'column', index: index }));
            event.stopPropagation();
        },
        
        endColumnDrag(event) {
            this.draggingColumnIndex = null;
            this.dragOverColumnIndex = null;
        },
        
        handleColumnDragOver(event, status, colIndex) {
            event.preventDefault();
            if (this.draggingColumnIndex !== null) {
                // Dragging a column
                this.dragOverColumnIndex = colIndex;
            } else if (this.draggingLeadId !== null) {
                // Dragging a lead
                this.dragOverStatus = status;
            }
        },
        
        handleColumnDragLeave(event) {
            if (!event.currentTarget.contains(event.relatedTarget)) {
                this.dragOverStatus = null;
                this.dragOverColumnIndex = null;
            }
        },
        
        async handleColumnDrop(event, status, colIndex) {
            event.preventDefault();
            
            try {
                const data = JSON.parse(event.dataTransfer.getData('text/plain'));
                
                if (data.type === 'column') {
                    // Reordering columns
                    await this.reorderColumn(data.index, colIndex);
                } else if (data.type === 'lead') {
                    // Moving a lead to a different status
                    await this.dropLeadOnColumn(data.id, status);
                }
            } catch (e) {
                // Fallback for old lead drag (plain ID)
                const leadId = parseInt(event.dataTransfer.getData('text/plain'));
                if (leadId) {
                    await this.dropLeadOnColumn(leadId, status);
                }
            }
            
            this.dragOverStatus = null;
            this.dragOverColumnIndex = null;
            this.draggingColumnIndex = null;
            this.draggingLeadId = null;
        },
        
        async reorderColumn(fromIndex, toIndex) {
            if (fromIndex === toIndex) return;
            
            // Reorder customStatuses array
            const statuses = [...this.customStatuses];
            const [moved] = statuses.splice(fromIndex, 1);
            statuses.splice(toIndex, 0, moved);
            this.customStatuses = statuses;
            
            // Save to server
            try {
                await fetch('/api/leads/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ statuses: statuses })
                });
            } catch (e) {
                console.error('Failed to save column order:', e);
            }
        },
        
        async dropLeadOnColumn(leadId, newStatus) {
            const lead = this.leads.find(l => l.id === leadId);
            if (!lead || lead.status === newStatus) return;
            
            // Optimistically update UI
            const oldStatus = lead.status;
            lead.status = newStatus;
            this.filterLeads();
            
            // Update on server
            try {
                const resp = await fetch(`/api/leads/${leadId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                if (!resp.ok) {
                    lead.status = oldStatus;
                    this.filterLeads();
                } else {
                    this.updateStats();
                }
            } catch (e) {
                console.error('Failed to update status:', e);
                lead.status = oldStatus;
                this.filterLeads();
            }
        },
        
        // Legacy handlers (can be removed later)
        dragOverColumn(event, status) {
            event.preventDefault();
            this.dragOverStatus = status;
        },
        
        dragLeaveColumn(event) {
            if (!event.currentTarget.contains(event.relatedTarget)) {
                this.dragOverStatus = null;
            }
        },
        
        async dropOnColumn(event, newStatus) {
            event.preventDefault();
            this.dragOverStatus = null;
            
            const leadId = parseInt(event.dataTransfer.getData('text/plain'));
            if (!leadId) return;
            
            await this.dropLeadOnColumn(leadId, newStatus);
            this.draggingLeadId = null;
        },
        
        formatDate(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleDateString('en-AE', { day: 'numeric', month: 'short', year: 'numeric' });
        },
        
        formatDateShort(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            const now = new Date();
            const diffDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return diffDays + 'd ago';
            
            return date.toLocaleDateString('en-AE', { day: 'numeric', month: 'short' });
        },
        
        getSourceClass(source) {
            const classes = {
                propertyfinder: 'bg-red-100 text-red-800',
                bayut: 'bg-blue-100 text-blue-800',
                website: 'bg-purple-100 text-purple-800',
                facebook: 'bg-indigo-100 text-indigo-800',
                instagram: 'bg-pink-100 text-pink-800',
                whatsapp: 'bg-green-100 text-green-800',
                zapier: 'bg-orange-100 text-orange-800'
            };
            return classes[source] || 'bg-gray-100 text-gray-800';
        },
        
        getStatusClass(status) {
            // First check custom statuses
            const customStatus = this.customStatuses.find(s => s.id === status);
            if (customStatus) {
                const color = customStatus.color || 'gray';
                return `bg-${color}-50 border-${color}-300`;
            }
            // Fallback for legacy statuses
            const classes = {
                new: 'bg-blue-50 border-blue-300',
                contacted: 'bg-yellow-50 border-yellow-300',
                qualified: 'bg-green-50 border-green-300',
                viewing: 'bg-purple-50 border-purple-300',
                negotiation: 'bg-orange-50 border-orange-300',
                won: 'bg-emerald-50 border-emerald-300',
                lost: 'bg-red-50 border-red-300',
                spam: 'bg-gray-50 border-gray-300'
            };
            return classes[status] || '';
        },
        
        getChannelClass(channel) {
            const classes = {
                whatsapp: 'bg-green-100 text-green-800',
                email: 'bg-blue-100 text-blue-800',
                call: 'bg-purple-100 text-purple-800',
                sms: 'bg-yellow-100 text-yellow-800',
                chat: 'bg-indigo-100 text-indigo-800'
            };
            return classes[channel] || 'bg-gray-100 text-gray-800';
        },
        
        getPfStatusClass(status) {
            const classes = {
                sent: 'bg-gray-100 text-gray-800',
                delivered: 'bg-blue-100 text-blue-800',
                read: 'bg-yellow-100 text-yellow-800',
                replied: 'bg-green-100 text-green-800'
            };
            return classes[status] || 'bg-gray-100 text-gray-800';
        },
        
        getPriorityClass(priority) {
            const classes = {
                urgent: 'bg-red-100 text-red-800',
                high: 'bg-orange-100 text-orange-800',
                medium: 'bg-yellow-100 text-yellow-800',
                low: 'bg-gray-100 text-gray-800'
            };
            return classes[priority] || 'bg-gray-100 text-gray-800';
        },
        
        async updateAssigned(id, userId) {
            try {
                await fetch(`/api/leads/${id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ assigned_to_id: userId || null })
                });
                // Update local data
                const lead = this.leads.find(l => l.id === id);
                if (lead) {
                    lead.assigned_to_id = userId || null;
                    const member = this.teamMembers.find(m => m.id == userId);
                    lead.assigned_to_name = member ? member.name : null;
                }
                this.filterLeads();
            } catch (e) {
                console.error('Failed to update assigned:', e);
            }
        },
        
        openSettingsModal() {
            this.editStatuses = JSON.parse(JSON.stringify(this.customStatuses));
            this.editSources = JSON.parse(JSON.stringify(this.customSources));
            this.showSettingsModal = true;
        },
        
        addStatus() {
            const id = 'status_' + Date.now();
            this.editStatuses.push({ id, label: '', color: 'gray' });
        },
        
        // Update status ID when label changes (for new statuses only)
        updateStatusId(status) {
            if (status.id.startsWith('status_') && status.label) {
                status.id = status.label.toLowerCase().replace(/[^a-z0-9]+/g, '_').replace(/^_|_$/g, '');
            }
        },
        
        removeStatus(index) {
            if (this.editStatuses.length > 1) {
                this.editStatuses.splice(index, 1);
            }
        },
        
        addSource() {
            // Generate a temporary ID - will be updated when user types the label
            const id = 'source_' + Date.now();
            this.editSources.push({ id, label: '', color: 'gray' });
        },
        
        // Update source ID when label changes (for new sources only)
        updateSourceId(source) {
            if (source.id.startsWith('source_') && source.label) {
                // Create a slug from the label
                source.id = source.label.toLowerCase().replace(/[^a-z0-9]+/g, '_').replace(/^_|_$/g, '');
            }
        },
        
        removeSource(index) {
            if (this.editSources.length > 1) {
                this.editSources.splice(index, 1);
            }
        },
        
        async saveConfig() {
            this.savingConfig = true;
            try {
                const resp = await fetch('/api/leads/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        statuses: this.editStatuses,
                        sources: this.editSources
                    })
                });
                const data = await resp.json();
                if (data.success) {
                    this.customStatuses = [...this.editStatuses];
                    this.customSources = [...this.editSources];
                    this.showSettingsModal = false;
                } else {
                    alert('Failed to save: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                console.error('Failed to save config:', e);
                alert('Failed to save: ' + e.message);
            }
            this.savingConfig = false;
        },
        
        async cleanupSources() {
            this.cleaningUp = true;
            try {
                const resp = await fetch('/api/leads/cleanup-sources', { method: 'POST' });
                const data = await resp.json();
                if (data.success) {
                    if (data.fixed > 0) {
                        alert(`Fixed ${data.fixed} leads with invalid sources`);
                        await this.loadLeads();
                    } else {
                        alert('No leads with invalid sources found');
                    }
                } else {
                    alert('Failed to cleanup: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                console.error('Failed to cleanup sources:', e);
                alert('Failed to cleanup: ' + e.message);
            }
            this.cleaningUp = false;
        },
        
        getStatusLabel(statusId) {
            const s = this.customStatuses.find(st => st.id === statusId);
            return s ? s.label : statusId;
        },
        
        getSourceLabel(sourceId) {
            const s = this.customSources.find(src => src.id === sourceId);
            return s ? s.label : sourceId;
        },
        
        // ==================== CONTACTS ====================
        
        async loadContacts() {
            this.loadingContacts = true;
            try {
                const params = new URLSearchParams();
                if (this.contactSearch) params.set('search', this.contactSearch);
                
                const resp = await fetch('/api/contacts?' + params.toString());
                const data = await resp.json();
                this.contacts = data.contacts || [];
                this.countryCodes = data.country_codes || [['+971', 'UAE']];
            } catch (e) {
                console.error('Failed to load contacts:', e);
            }
            this.loadingContacts = false;
        },
        
        async saveContact() {
            this.savingContact = true;
            try {
                const url = this.editingContactId 
                    ? `/api/contacts/${this.editingContactId}` 
                    : '/api/contacts';
                const method = this.editingContactId ? 'PATCH' : 'POST';
                
                const resp = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.newContact)
                });
                
                const data = await resp.json();
                if (data.success) {
                    this.resetContactForm();
                    await this.loadContacts();
                } else {
                    alert('Failed to save contact: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                console.error('Failed to save contact:', e);
                alert('Failed to save contact: ' + e.message);
            }
            this.savingContact = false;
        },
        
        editContact(contact) {
            this.editingContactId = contact.id;
            this.newContact = {
                name: contact.name,
                phone: contact.phone,
                country_code: contact.country_code || '+971',
                email: contact.email || '',
                company: contact.company || '',
                notes: contact.notes || ''
            };
        },
        
        cancelEditContact() {
            this.resetContactForm();
        },
        
        resetContactForm() {
            this.editingContactId = null;
            this.newContact = { name: '', phone: '', country_code: '+971', email: '', company: '', notes: '' };
        },
        
        async deleteContact(id) {
            if (!confirm('Delete this contact?')) return;
            try {
                const resp = await fetch(`/api/contacts/${id}`, { method: 'DELETE' });
                const data = await resp.json();
                if (data.success) {
                    await this.loadContacts();
                }
            } catch (e) {
                console.error('Failed to delete contact:', e);
            }
        },
        
        async saveContactFromLead(lead) {
            try {
                const resp = await fetch(`/api/contacts/from-lead/${lead.id}`, { method: 'POST' });
                const data = await resp.json();
                if (data.success) {
                    if (data.existing) {
                        alert('Contact already exists: ' + data.contact.name);
                    } else {
                        alert('Contact saved: ' + data.contact.name);
                    }
                }
            } catch (e) {
                console.error('Failed to save contact from lead:', e);
            }
        }
    }
}
</script>
{% endblock %}
