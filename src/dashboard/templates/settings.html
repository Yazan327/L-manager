{% extends "base.html" %}

{% block title %}{{ t('common.settings', default='Settings') }} - L-Manager{% endblock %}
{% block page_title %}{{ t('common.settings', default='Settings') }}{% endblock %}

{% block content %}
<div class="max-w-2xl" x-data="settingsManager()" x-init="init()">
    
    <!-- Sync Settings -->
    <div class="bg-white rounded-lg shadow mb-6">
        <div class="p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold">Data Sync Settings</h3>
                <button @click="manualSync()" :disabled="syncing"
                        class="bg-indigo-600 hover:bg-indigo-700 disabled:bg-indigo-300 text-white px-4 py-2 rounded-lg text-sm flex items-center gap-2">
                    <svg class="w-4 h-4" :class="syncing && 'animate-spin'" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    <span x-text="syncing ? 'Syncing...' : 'Sync Now'"></span>
                </button>
            </div>
            
            <div class="space-y-4">
                <div class="flex items-center justify-between py-3 border-b border-gray-100">
                    <dt>
                        <div class="text-gray-600">Auto-Sync Enabled</div>
                        <div class="text-xs text-gray-400">Automatically sync data from PropertyFinder</div>
                    </dt>
                    <dd>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" x-model="settings.auto_sync_enabled" @change="saveSettings()" 
                                   :checked="settings.auto_sync_enabled === 'true'"
                                   class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                        </label>
                    </dd>
                </div>
                
                <div class="flex items-center justify-between py-3 border-b border-gray-100">
                    <dt>
                        <div class="text-gray-600">Sync Interval</div>
                        <div class="text-xs text-gray-400">How often to sync data (in minutes)</div>
                    </dt>
                    <dd>
                        <select x-model="settings.sync_interval_minutes" @change="saveSettings()"
                                class="border rounded-lg px-3 py-2 text-sm">
                            <option value="15">Every 15 minutes</option>
                            <option value="30">Every 30 minutes</option>
                            <option value="60">Every hour</option>
                            <option value="120">Every 2 hours</option>
                            <option value="360">Every 6 hours</option>
                        </select>
                    </dd>
                </div>

                <div class="py-3 border-b border-gray-100">
                    <label class="block text-gray-600 mb-1">Workspace Timezone</label>
                    <div class="text-xs text-gray-400 mb-2">Used for loop schedules (daily windows and exact run times)</div>
                    <input type="text" x-model="settings.workspace_timezone" @change="saveSettings()"
                           class="w-full border rounded-lg px-3 py-2"
                           placeholder="Asia/Dubai">
                </div>
                
                <div class="flex items-center justify-between py-3 border-b border-gray-100">
                    <dt class="text-gray-600">Last Sync</dt>
                    <dd class="text-sm">
                        <span x-show="lastSync" x-text="formatDate(lastSync)" class="text-green-600"></span>
                        <span x-show="!lastSync" class="text-gray-400">Never</span>
                    </dd>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Default Agent Settings -->
    <div class="bg-white rounded-lg shadow mb-6">
        <div class="p-6">
            <h3 class="text-lg font-semibold mb-2">Default Agent Settings</h3>
            <p class="text-gray-500 text-sm mb-4">Configure default values for listings and insights.</p>
            
            <div class="space-y-4">
                <div class="py-3 border-b border-gray-100" x-data="{ selectedAgentId: '' }" x-init="selectedAgentId = settings.default_pf_agent_id || ''">
                    <label class="block text-gray-600 mb-1">Default Insights Agent</label>
                    <div class="text-xs text-gray-400 mb-2">When opening Insights, show data for this agent by default</div>
                    <select x-model="settings.default_pf_agent_id" 
                            @change="selectedAgentId = $event.target.value; saveSettings()"
                            class="w-full border rounded-lg px-3 py-2">
                        <option value="">All Agents</option>
                        {% for user in pf_users %}
                        <option value="{{ user.id }}">{{ user.name }} ({{ user.email }})</option>
                        {% endfor %}
                    </select>
                    <!-- Show selected Agent ID -->
                    <div x-show="selectedAgentId || settings.default_pf_agent_id" 
                         class="mt-2 p-2 bg-indigo-50 rounded-lg border border-indigo-100 flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-id-badge text-indigo-500"></i>
                            <span class="text-sm text-indigo-700">Agent ID:</span>
                            <code class="bg-white px-2 py-0.5 rounded text-indigo-600 font-mono text-sm" 
                                  x-text="selectedAgentId || settings.default_pf_agent_id"></code>
                        </div>
                        <button type="button" @click="navigator.clipboard.writeText(selectedAgentId || settings.default_pf_agent_id)" 
                                class="text-indigo-500 hover:text-indigo-700 text-xs flex items-center gap-1">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                </div>
                
                <div class="py-3 border-b border-gray-100">
                    <label class="block text-gray-600 mb-1">Default Assigned Agent Email</label>
                    <div class="text-xs text-gray-400 mb-2">Pre-fills Assigned Agent in new listing forms and bulk uploads</div>
                    <input type="email" x-model="settings.default_agent_email" @change="saveSettings()"
                           class="w-full border rounded-lg px-3 py-2"
                           placeholder="agent@company.com">
                </div>
                
                <div class="py-3 border-b border-gray-100">
                    <label class="block text-gray-600 mb-1">Default Owner Email</label>
                    <div class="text-xs text-gray-400 mb-2">Pre-fills owner_id in bulk uploads</div>
                    <input type="email" x-model="settings.default_owner_email" @change="saveSettings()"
                           class="w-full border rounded-lg px-3 py-2"
                           placeholder="owner@company.com">
                </div>
            </div>
            
            <div x-show="saveSuccess" x-cloak class="mt-4 p-3 bg-green-50 border border-green-200 rounded-lg text-green-700 text-sm">
                <i class="fas fa-check-circle mr-2"></i>Settings saved successfully!
            </div>
            
            <!-- All Agents List with IDs -->
            {% if pf_users %}
            <div class="mt-6 pt-4 border-t border-gray-100">
                <div class="flex items-center justify-between mb-3">
                    <h4 class="font-medium text-gray-700">
                        <i class="fas fa-users mr-2 text-indigo-500"></i>All PropertyFinder Agents
                    </h4>
                    <span class="text-xs text-gray-400">{{ pf_users|length }} agent(s)</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="text-left px-3 py-2 text-gray-600 font-medium">Name</th>
                                <th class="text-left px-3 py-2 text-gray-600 font-medium">Email</th>
                                <th class="text-left px-3 py-2 text-gray-600 font-medium">Agent ID</th>
                                <th class="px-3 py-2"></th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            {% for user in pf_users %}
                            {% set user_name = user.get('name', user.get('fullName', 'Unknown')) if user is mapping else user.name %}
                            {% set user_email = user.get('email', '') if user is mapping else user.email %}
                            {% set user_id = user.get('id', '') if user is mapping else user.id %}
                            {% set user_avatar = user.get('avatar', user.get('profilePhoto', '')) if user is mapping else (user.avatar if user.avatar else '') %}
                            <tr class="hover:bg-gray-50">
                                <td class="px-3 py-2">
                                    <div class="flex items-center gap-2">
                                        {% if user_avatar %}
                                        <img src="{{ user_avatar }}" class="w-6 h-6 rounded-full" alt="">
                                        {% else %}
                                        <div class="w-6 h-6 rounded-full bg-indigo-100 flex items-center justify-center">
                                            <span class="text-xs font-medium text-indigo-600">{{ user_name[:1] if user_name else '?' }}</span>
                                        </div>
                                        {% endif %}
                                        <span>{{ user_name }}</span>
                                    </div>
                                </td>
                                <td class="px-3 py-2 text-gray-600">{{ user_email }}</td>
                                <td class="px-3 py-2">
                                    <code class="bg-indigo-50 text-indigo-600 px-2 py-0.5 rounded font-mono text-xs">{{ user_id }}</code>
                                </td>
                                <td class="px-3 py-2">
                                    <button type="button" @click="navigator.clipboard.writeText('{{ user_id }}')" 
                                            class="text-gray-400 hover:text-indigo-600 text-xs flex items-center gap-1">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Enterprise API Configuration -->
    <div class="bg-white rounded-lg shadow mb-6">
        <div class="p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold">Enterprise API Configuration</h3>
                <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full">
                    <i class="fas fa-building mr-1"></i>Enterprise API v1
                </span>
            </div>
            <p class="text-gray-600 mb-6">Configure your PropertyFinder Enterprise API credentials. Get them from <strong>PF Expert → Settings → API Keys</strong> (Type: "API Integration").</p>
            
            <dl class="space-y-4">
                <div class="flex items-center justify-between py-3 border-b border-gray-100">
                    <dt class="text-gray-600">API Base URL</dt>
                    <dd class="font-mono text-sm bg-gray-100 px-3 py-1 rounded">{{ config.api_base_url }}</dd>
                </div>
                
                <div class="flex items-center justify-between py-3 border-b border-gray-100">
                    <dt class="text-gray-600">API Key</dt>
                    <dd>
                        {% if config.has_api_key %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            <i class="fas fa-check-circle mr-1"></i>Configured
                        </span>
                        {% else %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                            <i class="fas fa-exclamation-circle mr-1"></i>Not Set
                        </span>
                        {% endif %}
                    </dd>
                </div>
                
                <div class="flex items-center justify-between py-3 border-b border-gray-100">
                    <dt class="text-gray-600">API Secret</dt>
                    <dd>
                        {% if config.has_api_secret %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            <i class="fas fa-check-circle mr-1"></i>Configured
                        </span>
                        {% else %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                            <i class="fas fa-exclamation-circle mr-1"></i>Not Set
                        </span>
                        {% endif %}
                    </dd>
                </div>
                
                <div class="flex items-center justify-between py-3 border-b border-gray-100">
                    <dt class="text-gray-600">Debug Mode</dt>
                    <dd>
                        {% if config.debug %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                            Enabled
                        </span>
                        {% else %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                            Disabled
                        </span>
                        {% endif %}
                    </dd>
                </div>
            </dl>
            
            <!-- Test Connection Button -->
            <div class="mt-6 pt-4 border-t border-gray-100">
                <button @click="testConnection()" 
                        :disabled="testing"
                        class="w-full bg-indigo-600 hover:bg-indigo-700 disabled:bg-indigo-300 text-white font-medium py-3 px-4 rounded-lg transition-colors flex items-center justify-center">
                    <template x-if="testing">
                        <span><i class="fas fa-spinner fa-spin mr-2"></i>Testing Connection...</span>
                    </template>
                    <template x-if="!testing">
                        <span><i class="fas fa-plug mr-2"></i>Test API Connection</span>
                    </template>
                </button>
                
                <!-- Test Result -->
                <div x-show="testResult" x-cloak class="mt-4">
                    <template x-if="testResult && testResult.success">
                        <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                            <div class="flex items-start">
                                <i class="fas fa-check-circle text-green-500 text-xl mr-3 mt-0.5"></i>
                                <div>
                                    <p class="font-medium text-green-800" x-text="testResult.message"></p>
                                    <p class="text-sm text-green-600 mt-1">
                                        Token expires: <span x-text="testResult.token_expires_at"></span>
                                    </p>
                                    <p class="text-sm text-green-600" x-show="testResult.user_count">
                                        Users found: <span x-text="testResult.user_count"></span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </template>
                    <template x-if="testResult && !testResult.success">
                        <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                            <div class="flex items-start">
                                <i class="fas fa-times-circle text-red-500 text-xl mr-3 mt-0.5"></i>
                                <div>
                                    <p class="font-medium text-red-800">Connection Failed</p>
                                    <p class="text-sm text-red-600 mt-1" x-text="testResult.message"></p>
                                    <p class="text-xs text-red-500 mt-2" x-text="'Status: ' + (testResult.status_code || 'N/A')"></p>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bulk Settings -->
    <div class="bg-white rounded-lg shadow mb-6">
        <div class="p-6">
            <h3 class="text-lg font-semibold mb-4">Bulk Operation Settings</h3>
            
            <dl class="space-y-4">
                <div class="flex items-center justify-between py-3 border-b border-gray-100">
                    <dt class="text-gray-600">Batch Size</dt>
                    <dd class="font-mono">{{ config.bulk_batch_size }}</dd>
                </div>
                
                <div class="flex items-center justify-between py-3 border-b border-gray-100">
                    <dt class="text-gray-600">Delay Between Requests</dt>
                    <dd class="font-mono">{{ config.bulk_delay }}s</dd>
                </div>
            </dl>
        </div>
    </div>
    
    <!-- Environment File Info -->
    <div class="bg-white rounded-lg shadow">
        <div class="p-6">
            <h3 class="text-lg font-semibold mb-4">Environment Variables</h3>
            <p class="text-gray-600 mb-4">Some settings can only be changed in the <code class="bg-gray-100 px-2 py-1 rounded">.env</code> file:</p>
            
            <div class="mt-4 p-4 bg-blue-50 rounded-lg">
                <div class="flex">
                    <i class="fas fa-info-circle text-blue-500 mt-0.5 mr-3"></i>
                    <div class="text-sm text-blue-700">
                        <p class="font-medium">How to get your API Credentials:</p>
                        <ol class="list-decimal ml-4 mt-2 space-y-1">
                            <li>Log in to <strong>PropertyFinder Expert</strong></li>
                            <li>Go to <strong>Settings → API Keys</strong></li>
                            <li>Create a new key with Type: <strong>"API Integration"</strong></li>
                            <li>Copy both <strong>API Key</strong> and <strong>API Secret</strong></li>
                            <li>Paste them in your <code>.env</code> file</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function settingsManager() {
    return {
        settings: {{ app_settings | tojson | safe }},
        lastSync: '{{ app_settings.last_sync_at or "" }}',
        syncing: false,
        testing: false,
        testResult: null,
        saveSuccess: false,
        
        init() {
            // Convert string booleans
            if (this.settings.auto_sync_enabled === 'true') {
                this.settings.auto_sync_enabled = true;
            }
        },
        
        async saveSettings() {
            try {
                const payload = {
                    ...this.settings,
                    auto_sync_enabled: this.settings.auto_sync_enabled ? 'true' : 'false'
                };
                
                const resp = await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await resp.json().catch(() => ({}));
                if (resp.ok && data.success !== false) {
                    this.saveSuccess = true;
                    setTimeout(() => this.saveSuccess = false, 3000);
                } else {
                    alert(data.error || 'Failed to save settings');
                }
            } catch (e) {
                console.error('Failed to save settings:', e);
            }
        },
        
        async manualSync() {
            this.syncing = true;
            try {
                const resp = await fetch('/api/sync', { method: 'POST' });
                const data = await resp.json();
                if (data.success) {
                    this.lastSync = data.synced_at;
                    alert(`Sync complete!\n\nListings: ${data.listings_count}\nUsers: ${data.users_count}\nLeads: ${data.leads_count}`);
                } else {
                    alert('Sync failed: ' + data.error);
                }
            } catch (e) {
                alert('Sync failed: ' + e.message);
            }
            this.syncing = false;
        },
        
        async testConnection() {
            this.testing = true;
            this.testResult = null;
            
            try {
                const response = await fetch('/api/test-connection', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                this.testResult = await response.json();
            } catch (error) {
                this.testResult = {
                    success: false,
                    message: 'Network error: ' + error.message
                };
            } finally {
                this.testing = false;
            }
        },
        
        formatDate(dateStr) {
            if (!dateStr) return 'Never';
            const date = new Date(dateStr);
            const locale = (window.I18N && window.I18N.lang === 'ar') ? 'ar-AE-u-nu-latn' : 'en-AE';
            return date.toLocaleString(locale, { 
                day: 'numeric', month: 'short', year: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });
        }
    }
}
</script>
{% endblock %}
