{% extends "base.html" %}

{% block title %}Workspace Admin - {{ workspace.name }} - L-Manager{% endblock %}
{% block page_title %}Workspace Administration{% endblock %}

{% block content %}
<div x-data="workspaceAdminManager()" x-init="init()" class="max-w-7xl mx-auto">
    
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 rounded-lg flex items-center justify-center text-white font-bold text-xl bg-{{ workspace.color }}-500">
                {{ workspace.name[0] | upper }}
            </div>
            <div>
                <h2 class="text-2xl font-bold text-gray-900">{{ workspace.name }}</h2>
                <p class="text-gray-500">Workspace Administration</p>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <a href="{{ url_for('workspaces_page') }}" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">
                <i class="fas fa-arrow-left mr-1"></i> Back to Workspaces
            </a>
        </div>
    </div>
    
    <!-- Tabs -->
    <div class="bg-white rounded-lg shadow mb-6">
        <div class="border-b border-gray-200">
            <nav class="flex -mb-px">
                <button @click="activeTab = 'members'" 
                        :class="activeTab === 'members' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="py-4 px-6 border-b-2 font-medium text-sm">
                    <i class="fas fa-users mr-2"></i>Members
                </button>
                <button @click="activeTab = 'roles'" 
                        :class="activeTab === 'roles' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="py-4 px-6 border-b-2 font-medium text-sm">
                    <i class="fas fa-user-tag mr-2"></i>Roles & Permissions
                </button>
                <button @click="activeTab = 'connections'" 
                        :class="activeTab === 'connections' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="py-4 px-6 border-b-2 font-medium text-sm">
                    <i class="fas fa-plug mr-2"></i>Connections
                </button>
                <button @click="activeTab = 'openapi'" 
                        :class="activeTab === 'openapi' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="py-4 px-6 border-b-2 font-medium text-sm">
                    <i class="fas fa-key mr-2"></i>Open API
                </button>
                <button @click="activeTab = 'settings'" 
                        :class="activeTab === 'settings' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="py-4 px-6 border-b-2 font-medium text-sm">
                    <i class="fas fa-cog mr-2"></i>Settings
                </button>
            </nav>
        </div>
    </div>
    
    <!-- Members Tab -->
    <div x-show="activeTab === 'members'" class="space-y-6">
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b flex items-center justify-between">
                <h3 class="text-lg font-semibold">Workspace Members</h3>
                <button @click="showAddMemberModal = true" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm">
                    <i class="fas fa-user-plus mr-1"></i> Invite Member
                </button>
            </div>
            <div class="px-6 py-3 bg-gray-50 border-b text-sm text-gray-600">
                Platform/system admins are managed in System Admin and are hidden from workspace member lists.
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Member</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Role</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Joined</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <template x-for="member in members" :key="member.id">
                            <tr>
                                <td class="px-6 py-4">
                                    <div class="flex items-center">
                                        <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-semibold">
                                            <span x-text="member.user_name?.charAt(0)?.toUpperCase() || '?'"></span>
                                        </div>
                                        <div class="ml-3">
                                            <p class="font-medium text-gray-900" x-text="member.user_name"></p>
                                            <p class="text-sm text-gray-500" x-text="member.user_email"></p>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4">
                                    <select x-model="member.role" @change="updateMemberRole(member)"
                                            class="border rounded px-2 py-1 text-sm"
                                            :disabled="member.role === 'owner'">
                                        <option value="owner">Owner</option>
                                        <option value="admin">Admin</option>
                                        <option value="moderator">Moderator</option>
                                        <option value="member">Member</option>
                                        <option value="viewer">Viewer</option>
                                        <option value="external">External</option>
                                    </select>
                                </td>
                                <td class="px-6 py-4 text-sm text-gray-500" x-text="formatDate(member.joined_at)"></td>
                                <td class="px-6 py-4">
                                    <button x-show="member.role !== 'owner'" @click="removeMember(member)"
                                            class="text-red-600 hover:text-red-800 text-sm">
                                        <i class="fas fa-trash mr-1"></i> Remove
                                    </button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b">
                <h3 class="text-lg font-semibold">Pending Invites</h3>
            </div>
            <div class="p-6">
                <div x-show="pendingInvites.length === 0" class="text-sm text-gray-500">
                    No pending invites.
                </div>
                <div class="space-y-2" x-show="pendingInvites.length > 0">
                    <template x-for="invite in pendingInvites" :key="invite.id">
                        <div class="flex items-center justify-between p-3 border rounded-lg">
                            <div>
                                <div class="font-medium text-gray-900" x-text="invite.email"></div>
                                <div class="text-xs text-gray-500">
                                    Role: <span x-text="invite.role"></span> â€¢ Expires: <span x-text="formatDate(invite.expires_at)"></span>
                                </div>
                            </div>
                            <button @click="revokeInvite(invite.id)" class="px-3 py-1.5 bg-red-100 text-red-700 rounded hover:bg-red-200 text-xs">
                                <i class="fas fa-ban mr-1"></i>Revoke
                            </button>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Roles & Permissions Tab -->
    <div x-show="activeTab === 'roles'" class="space-y-6">
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-semibold">Workspace Roles</h3>
                    <p class="text-sm text-gray-500">Define custom roles and permissions for this workspace</p>
                </div>
                <button @click="showCreateRoleModal = true" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm">
                    <i class="fas fa-plus mr-1"></i> Create Custom Role
                </button>
            </div>
            <div class="p-6 space-y-4">
                <template x-for="role in workspaceRoles" :key="role.id">
                    <div class="border rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="flex items-center gap-2">
                                    <h4 class="font-semibold text-gray-900" x-text="role.name"></h4>
                                    <span class="px-2 py-0.5 text-xs rounded bg-gray-100 text-gray-600" x-text="role.code"></span>
                                    <span x-show="role.is_system" class="px-2 py-0.5 text-xs rounded bg-blue-100 text-blue-600">Template</span>
                                    <span x-show="role.is_default" class="px-2 py-0.5 text-xs rounded bg-green-100 text-green-600">Default</span>
                                </div>
                                <p class="text-sm text-gray-500 mt-1" x-text="role.description"></p>
                            </div>
                            <div class="flex items-center gap-2">
                                <button @click="editRole(role)" class="px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded hover:bg-gray-200">
                                    <i class="fas fa-edit mr-1"></i> Edit
                                </button>
                                <button @click="viewModulePermissions(role)" class="px-3 py-1 text-sm bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200">
                                    <i class="fas fa-key mr-1"></i> Modules
                                </button>
                            </div>
                        </div>
                        
                        <!-- Permission Buckets Preview -->
                        <div class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-2">
                            <template x-for="(bucket, action) in role.permission_buckets" :key="action">
                                <div class="flex items-center justify-between p-2 bg-gray-50 rounded text-sm">
                                    <span class="text-gray-600" x-text="action.replace(/_/g, ' ')"></span>
                                    <span :class="{
                                        'text-green-600': bucket === 'all_members',
                                        'text-blue-600': bucket === 'admin_moderator',
                                        'text-purple-600': bucket === 'admin_only',
                                        'text-red-600': bucket === 'deny',
                                        'text-yellow-600': bucket === 'external'
                                    }" x-text="bucket.replace(/_/g, ' ')"></span>
                                </div>
                            </template>
                        </div>
                    </div>
                </template>
            </div>
        </div>
        
        <!-- Permission Buckets Legend -->
        <div class="bg-white rounded-lg shadow p-6">
            <h4 class="font-semibold mb-4">Permission Bucket Levels</h4>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm">
                <div class="flex items-center gap-2">
                    <span class="w-3 h-3 rounded-full bg-purple-500"></span>
                    <span><strong>admin_only</strong> - Admins only</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="w-3 h-3 rounded-full bg-blue-500"></span>
                    <span><strong>admin_moderator</strong> - Admins + Moderators</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="w-3 h-3 rounded-full bg-green-500"></span>
                    <span><strong>all_members</strong> - All members</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="w-3 h-3 rounded-full bg-yellow-500"></span>
                    <span><strong>authorized</strong> - Any authorized user</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="w-3 h-3 rounded-full bg-orange-500"></span>
                    <span><strong>external</strong> - Including external guests</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="w-3 h-3 rounded-full bg-red-500"></span>
                    <span><strong>deny</strong> - No access</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Connections Tab -->
    <div x-show="activeTab === 'connections'" class="space-y-6">
        <div class="bg-white rounded-lg shadow p-6 text-center">
            <i class="fas fa-plug text-4xl text-gray-300 mb-4"></i>
            <h3 class="text-lg font-semibold text-gray-700 mb-2">Connection Center</h3>
            <p class="text-gray-500 mb-4">Manage API connections for this workspace</p>
            <a href="{{ url_for('connections_page', workspace_id=workspace.id) }}" 
               class="inline-flex items-center px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                <i class="fas fa-external-link-alt mr-2"></i> Open Connection Center
            </a>
        </div>
    </div>

    <!-- Open API Tab -->
    <div x-show="activeTab === 'openapi'" class="space-y-6">
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-semibold">Open API Credentials</h3>
                    <p class="text-sm text-gray-500">Generate workspace credentials for external listing creation.</p>
                </div>
                <a href="/open-api/docs" target="_blank" class="px-3 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 text-sm">
                    <i class="fas fa-book mr-1"></i> Docs
                </a>
            </div>
            <div class="p-6 border-b bg-gray-50">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div class="md:col-span-1">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Credential Name</label>
                        <input type="text" x-model="openApiForm.name" class="w-full border rounded-lg px-3 py-2" placeholder="CRM Integration">
                    </div>
                    <div class="md:col-span-1">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Expires At (optional)</label>
                        <input type="datetime-local" x-model="openApiForm.expiresAt" class="w-full border rounded-lg px-3 py-2">
                    </div>
                    <div class="md:col-span-1 flex items-end">
                        <button @click="createOpenApiCredential()" :disabled="creatingOpenApiCredential || !openApiForm.name.trim()"
                                class="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50">
                            <i class="fas fa-plus mr-1"></i>
                            <span x-text="creatingOpenApiCredential ? 'Creating...' : 'Create Credential'"></span>
                        </button>
                    </div>
                </div>
                <div class="text-xs text-gray-500 mt-3">
                    Secrets are shown only once. Save them in your secure vault.
                </div>
            </div>
            <div class="p-6 border-b" x-show="openApiSecretBundle">
                <div class="border border-yellow-300 bg-yellow-50 rounded-lg p-4">
                    <div class="font-semibold text-yellow-800 mb-2">New Credential Secret (Shown Once)</div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                        <div>
                            <div class="text-gray-600 mb-1">X-API-Key</div>
                            <div class="font-mono break-all" x-text="openApiSecretBundle?.key_id"></div>
                        </div>
                        <div>
                            <div class="text-gray-600 mb-1">X-API-Secret</div>
                            <div class="font-mono break-all" x-text="openApiSecretBundle?.api_secret"></div>
                        </div>
                    </div>
                    <div class="mt-3 flex items-center gap-2">
                        <button @click="copyOpenApiCredentialPair()" class="px-3 py-1.5 bg-indigo-600 text-white rounded hover:bg-indigo-700 text-xs">
                            <i class="fas fa-copy mr-1"></i> Copy Headers
                        </button>
                        <button @click="openApiSecretBundle = null" class="px-3 py-1.5 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 text-xs">
                            Dismiss
                        </button>
                    </div>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Key ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Created</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Last Used</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Expires</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <template x-if="openApiCredentials.length === 0">
                            <tr>
                                <td colspan="7" class="px-6 py-6 text-sm text-gray-500">No credentials created yet.</td>
                            </tr>
                        </template>
                        <template x-for="credential in openApiCredentials" :key="credential.id">
                            <tr>
                                <td class="px-6 py-4 text-sm text-gray-900" x-text="credential.name"></td>
                                <td class="px-6 py-4 text-sm font-mono text-gray-700" x-text="credential.key_id_masked || credential.key_id"></td>
                                <td class="px-6 py-4 text-sm">
                                    <span class="px-2 py-1 rounded text-xs"
                                          :class="{
                                              'bg-green-100 text-green-700': credential.status === 'active',
                                              'bg-red-100 text-red-700': credential.status === 'revoked',
                                              'bg-yellow-100 text-yellow-700': credential.status === 'expired',
                                              'bg-gray-100 text-gray-700': credential.status === 'inactive'
                                          }"
                                          x-text="credential.status || 'inactive'"></span>
                                </td>
                                <td class="px-6 py-4 text-sm text-gray-500" x-text="formatDate(credential.created_at)"></td>
                                <td class="px-6 py-4 text-sm text-gray-500" x-text="formatDate(credential.last_used_at)"></td>
                                <td class="px-6 py-4 text-sm text-gray-500" x-text="formatDate(credential.expires_at)"></td>
                                <td class="px-6 py-4 text-sm">
                                    <div class="flex gap-2">
                                        <button @click="regenerateOpenApiSecret(credential)"
                                                class="px-2 py-1 bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200 text-xs"
                                                :disabled="credential.status === 'revoked'">
                                            Regenerate
                                        </button>
                                        <button @click="revokeOpenApiCredential(credential)"
                                                class="px-2 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200 text-xs"
                                                :disabled="credential.status === 'revoked'">
                                            Revoke
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Settings Tab -->
    <div x-show="activeTab === 'settings'" class="space-y-6">
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b">
                <h3 class="text-lg font-semibold">Workspace Settings</h3>
            </div>
            <div class="p-6 space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Workspace Name</label>
                    <input type="text" x-model="workspaceSettings.name" class="w-full border rounded-lg px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea x-model="workspaceSettings.description" rows="3" class="w-full border rounded-lg px-3 py-2"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Theme Color</label>
                    <div class="flex gap-2">
                        <template x-for="color in colors" :key="color">
                            <button @click="workspaceSettings.color = color"
                                    :class="['w-8 h-8 rounded-lg', 'bg-' + color + '-500', workspaceSettings.color === color ? 'ring-2 ring-offset-2 ring-' + color + '-500' : '']">
                            </button>
                        </template>
                    </div>
                </div>
                <div class="flex items-center justify-between pt-4 border-t">
                    <button @click="saveWorkspaceSettings()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                        <i class="fas fa-save mr-1"></i> Save Changes
                    </button>
                    <button @click="showDeleteConfirm = true" class="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200">
                        <i class="fas fa-trash mr-1"></i> Delete Workspace
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Invite Member Modal -->
    <div x-show="showAddMemberModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" x-cloak>
        <div @click.away="showAddMemberModal = false" class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="px-6 py-4 border-b flex items-center justify-between">
                <h3 class="text-lg font-semibold">Invite Member</h3>
                <button @click="showAddMemberModal = false" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" x-model="inviteEmail" class="w-full border rounded-lg px-3 py-2" placeholder="user@example.com">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Role</label>
                    <select x-model="inviteRole" class="w-full border rounded-lg px-3 py-2">
                        <option value="owner">Owner</option>
                        <option value="member">Member</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div x-show="inviteLink" class="p-3 bg-gray-50 border rounded-lg">
                    <div class="text-xs text-gray-600 mb-2">Invite Link</div>
                    <div class="text-sm text-gray-800 break-all" x-text="inviteLink"></div>
                    <button @click="copyInviteLink()" class="mt-2 px-3 py-1.5 bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200 text-xs">
                        <i class="fas fa-copy mr-1"></i>Copy Link
                    </button>
                </div>
            </div>
            <div class="px-6 py-4 border-t bg-gray-50 flex justify-end gap-2">
                <button @click="showAddMemberModal = false" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                    Cancel
                </button>
                <button @click="createInvite()" :disabled="!inviteEmail" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50">
                    Generate Link
                </button>
            </div>
        </div>
    </div>
    
    <!-- Module Permissions Modal -->
    <div x-show="showModuleModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" x-cloak>
        <div @click.away="showModuleModal = false" class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="px-6 py-4 border-b flex items-center justify-between sticky top-0 bg-white">
                <h3 class="text-lg font-semibold">Module Permissions: <span x-text="selectedRole?.name"></span></h3>
                <button @click="showModuleModal = false" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <p class="text-sm text-gray-500">Configure what this role can do in each module</p>
                
                <template x-for="module in modules" :key="module">
                    <div class="border rounded-lg p-4">
                        <h4 class="font-medium text-gray-900 capitalize mb-3" x-text="module"></h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <label class="flex items-center gap-2">
                                <input type="checkbox" :checked="getModuleCap(module, 'read')" @change="setModuleCap(module, 'read', $event.target.checked)" class="rounded">
                                <span class="text-sm">Read</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" :checked="getModuleCap(module, 'create')" @change="setModuleCap(module, 'create', $event.target.checked)" class="rounded">
                                <span class="text-sm">Create</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" :checked="getModuleCap(module, 'edit')" @change="setModuleCap(module, 'edit', $event.target.checked)" class="rounded">
                                <span class="text-sm">Edit</span>
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="checkbox" :checked="getModuleCap(module, 'delete')" @change="setModuleCap(module, 'delete', $event.target.checked)" class="rounded">
                                <span class="text-sm">Delete</span>
                            </label>
                        </div>
                        <div class="mt-3">
                            <label class="block text-sm text-gray-600 mb-1">Scope</label>
                            <select :value="getModuleCap(module, 'scope') || 'own'" @change="setModuleCap(module, 'scope', $event.target.value)"
                                    class="border rounded px-2 py-1 text-sm">
                                <option value="own">Own items only</option>
                                <option value="team">Team items</option>
                                <option value="workspace">All workspace items</option>
                            </select>
                        </div>
                    </div>
                </template>
            </div>
            <div class="px-6 py-4 border-t bg-gray-50 flex justify-end gap-2 sticky bottom-0">
                <button @click="showModuleModal = false" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                    Close
                </button>
                <button @click="saveModulePermissions()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                    Save Permissions
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function workspaceAdminManager() {
    return {
        workspaceId: {{ workspace.id }},
        activeTab: 'members',
        members: {{ workspace.members | tojson | safe }},
        workspaceRoles: [],
        pendingInvites: [],
        showAddMemberModal: false,
        showCreateRoleModal: false,
        showModuleModal: false,
        showDeleteConfirm: false,
        creatingOpenApiCredential: false,
        
        inviteEmail: '',
        inviteRole: 'member',
        inviteLink: '',
        selectedRole: null,
        modulePermissions: {},
        modules: ['dashboard', 'listings', 'leads', 'tasks', 'contacts', 'insights'],
        openApiCredentials: [],
        openApiForm: {
            name: '',
            expiresAt: ''
        },
        openApiSecretBundle: null,
        
        workspaceSettings: {
            name: '{{ workspace.name }}',
            description: '{{ workspace.description or "" }}',
            color: '{{ workspace.color }}'
        },
        colors: ['indigo', 'blue', 'green', 'yellow', 'red', 'purple', 'pink', 'gray', 'orange', 'teal'],
        
        async init() {
            await Promise.all([
                this.loadWorkspaceRoles(),
                this.loadPendingInvites(),
                this.loadOpenApiCredentials()
            ]);
        },
        
        async loadWorkspaceRoles() {
            try {
                const resp = await fetch(`/api/workspaces/${this.workspaceId}/roles`);
                const data = await resp.json();
                if (data.success) {
                    this.workspaceRoles = data.roles;
                }
            } catch (e) {
                console.error('Failed to load workspace roles:', e);
            }
        },
        
        async loadPendingInvites() {
            try {
                const resp = await fetch(`/api/workspaces/${this.workspaceId}/invites`);
                const data = await resp.json();
                if (data.success) {
                    this.pendingInvites = data.invites || [];
                }
            } catch (e) {
                console.error('Failed to load pending invites:', e);
            }
        },
        
        async createInvite() {
            if (!this.inviteEmail) return;
            
            try {
                const resp = await fetch(`/api/workspaces/${this.workspaceId}/invites`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: this.inviteEmail,
                        role: this.inviteRole
                    })
                });
                const data = await resp.json();
                if (data.success) {
                    this.inviteLink = data.invite_link || '';
                    this.inviteEmail = '';
                    await this.loadPendingInvites();
                } else {
                    alert('Failed to create invite: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                console.error('Failed to create invite:', e);
            }
        },

        copyInviteLink() {
            if (!this.inviteLink) return;
            navigator.clipboard.writeText(this.inviteLink);
        },

        async revokeInvite(inviteId) {
            if (!confirm('Revoke this invite?')) return;
            try {
                const resp = await fetch(`/api/workspaces/${this.workspaceId}/invites/${inviteId}/revoke`, {
                    method: 'POST'
                });
                const data = await resp.json();
                if (data.success) {
                    await this.loadPendingInvites();
                } else {
                    alert('Failed to revoke invite: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                console.error('Failed to revoke invite:', e);
            }
        },

        async loadOpenApiCredentials() {
            try {
                const resp = await fetch(`/api/workspaces/${this.workspaceId}/open-api/credentials`);
                const data = await resp.json();
                if (data.success) {
                    this.openApiCredentials = data.credentials || [];
                } else {
                    console.error('Failed to load Open API credentials:', data.error || 'Unknown error');
                }
            } catch (e) {
                console.error('Failed to load Open API credentials:', e);
            }
        },

        async createOpenApiCredential() {
            const name = (this.openApiForm.name || '').trim();
            if (!name || this.creatingOpenApiCredential) return;
            this.creatingOpenApiCredential = true;
            try {
                const payload = { name };
                if (this.openApiForm.expiresAt) {
                    payload.expires_at = new Date(this.openApiForm.expiresAt).toISOString();
                }
                const resp = await fetch(`/api/workspaces/${this.workspaceId}/open-api/credentials`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await resp.json();
                if (data.success) {
                    this.openApiSecretBundle = {
                        key_id: data.key_id,
                        api_secret: data.api_secret
                    };
                    this.openApiForm = { name: '', expiresAt: '' };
                    await this.loadOpenApiCredentials();
                } else {
                    alert('Failed to create credential: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                console.error('Failed to create Open API credential:', e);
            } finally {
                this.creatingOpenApiCredential = false;
            }
        },

        async revokeOpenApiCredential(credential) {
            if (!credential || credential.status === 'revoked') return;
            if (!confirm(`Revoke credential "${credential.name}"?`)) return;
            try {
                const resp = await fetch(`/api/workspaces/${this.workspaceId}/open-api/credentials/${credential.id}/revoke`, {
                    method: 'POST'
                });
                const data = await resp.json();
                if (data.success) {
                    await this.loadOpenApiCredentials();
                } else {
                    alert('Failed to revoke credential: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                console.error('Failed to revoke Open API credential:', e);
            }
        },

        async regenerateOpenApiSecret(credential) {
            if (!credential || credential.status === 'revoked') return;
            if (!confirm(`Regenerate secret for "${credential.name}"? Existing integrations will stop working until updated.`)) return;
            try {
                const resp = await fetch(`/api/workspaces/${this.workspaceId}/open-api/credentials/${credential.id}/regenerate-secret`, {
                    method: 'POST'
                });
                const data = await resp.json();
                if (data.success) {
                    this.openApiSecretBundle = {
                        key_id: data.key_id,
                        api_secret: data.api_secret
                    };
                    await this.loadOpenApiCredentials();
                } else {
                    alert('Failed to regenerate secret: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                console.error('Failed to regenerate Open API secret:', e);
            }
        },

        copyOpenApiCredentialPair() {
            if (!this.openApiSecretBundle) return;
            const headersText = `X-API-Key: ${this.openApiSecretBundle.key_id}\nX-API-Secret: ${this.openApiSecretBundle.api_secret}`;
            navigator.clipboard.writeText(headersText);
        },

        async updateMemberRole(member) {
            try {
                const resp = await fetch(`/api/workspaces/${this.workspaceId}/members/${member.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role: member.role })
                });
                const data = await resp.json();
                if (!data.success) {
                    alert('Failed to update role: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                console.error('Failed to update member role:', e);
            }
        },
        
        async removeMember(member) {
            if (!confirm(`Remove ${member.user_name} from this workspace?`)) return;
            
            try {
                const resp = await fetch(`/api/workspaces/${this.workspaceId}/members/${member.id}`, {
                    method: 'DELETE'
                });
                const data = await resp.json();
                if (data.success) {
                    this.members = this.members.filter(m => m.id !== member.id);
                }
            } catch (e) {
                console.error('Failed to remove member:', e);
            }
        },
        
        editRole(role) {
            // TODO: Open role editor modal
            alert('Role editing UI - coming soon');
        },
        
        async viewModulePermissions(role) {
            this.selectedRole = role;
            this.modulePermissions = {};
            
            // Load module permissions for this role
            try {
                const resp = await fetch(`/api/workspaces/${this.workspaceId}/roles/${role.id}/modules`);
                const data = await resp.json();
                if (data.success) {
                    for (let mp of data.modules) {
                        this.modulePermissions[mp.module] = mp.capabilities;
                    }
                }
            } catch (e) {
                console.error('Failed to load module permissions:', e);
            }
            
            this.showModuleModal = true;
        },
        
        getModuleCap(module, cap) {
            return this.modulePermissions[module]?.[cap];
        },
        
        setModuleCap(module, cap, value) {
            if (!this.modulePermissions[module]) {
                this.modulePermissions[module] = {};
            }
            this.modulePermissions[module][cap] = value;
        },
        
        async saveModulePermissions() {
            if (!this.selectedRole) return;
            
            try {
                for (let module of this.modules) {
                    if (this.modulePermissions[module]) {
                        await fetch(`/api/workspaces/${this.workspaceId}/roles/${this.selectedRole.id}/modules/${module}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ capabilities: this.modulePermissions[module] })
                        });
                    }
                }
                alert('Module permissions saved');
                this.showModuleModal = false;
            } catch (e) {
                console.error('Failed to save module permissions:', e);
            }
        },
        
        async saveWorkspaceSettings() {
            try {
                const resp = await fetch(`/api/workspaces/${this.workspaceId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(this.workspaceSettings)
                });
                const data = await resp.json();
                if (data.success) {
                    alert('Settings saved');
                } else {
                    alert('Failed to save: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                console.error('Failed to save settings:', e);
            }
        },
        
        formatDate(dateStr) {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleDateString();
        }
    };
}
</script>
{% endblock %}
