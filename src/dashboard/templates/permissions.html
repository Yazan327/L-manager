{% extends "base.html" %}

{% block title %}Permission Center - L-Manager{% endblock %}
{% block page_title %}Permission Center{% endblock %}

{% block content %}
<div x-data="permissionsManager()" x-init="init()" class="max-w-7xl mx-auto">
    
    <!-- Header -->
    <div class="bg-white rounded-lg shadow mb-6 p-6">
        <div class="flex items-center justify-between">
            <div>
                <h2 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                    <i class="fas fa-shield-alt text-indigo-500"></i>
                    Permission Center
                </h2>
                <p class="text-gray-500 mt-1">Manage section access and action permissions for each user</p>
            </div>
            <a href="{{ url_for('users_page') }}" class="text-indigo-600 hover:text-indigo-800">
                <i class="fas fa-arrow-left mr-1"></i> Back to Users
            </a>
        </div>
    </div>
    
    <!-- User Selection -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
        <!-- Users List -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-lg shadow">
                <div class="p-4 border-b">
                    <h3 class="font-semibold text-gray-700">Users</h3>
                    <input type="text" x-model="searchQuery" placeholder="Search users..."
                           class="w-full mt-2 px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="max-h-[600px] overflow-y-auto">
                    <template x-for="user in filteredUsers" :key="user.id">
                        <button @click="selectUser(user.id)" 
                                :class="selectedUserId === user.id ? 'bg-indigo-50 border-l-4 border-indigo-500' : 'hover:bg-gray-50'"
                                class="w-full p-4 text-left border-b flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center flex-shrink-0">
                                <span class="text-indigo-600 font-semibold" x-text="user.name.charAt(0).toUpperCase()"></span>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="font-medium text-gray-900 truncate" x-text="user.name"></div>
                                <div class="text-xs text-gray-500 truncate" x-text="user.email"></div>
                                <div class="flex items-center gap-1 mt-1">
                                    <span class="text-xs px-1.5 py-0.5 rounded-full"
                                          :class="user.accessible_sections.length > 0 ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'"
                                          x-text="user.accessible_sections.length + ' sections'"></span>
                                    <template x-if="user.pf_agent_id">
                                        <span class="text-xs px-1.5 py-0.5 rounded-full bg-amber-100 text-amber-700">
                                            <i class="fas fa-lock text-xs"></i>
                                        </span>
                                    </template>
                                </div>
                            </div>
                        </button>
                    </template>
                    <div x-show="filteredUsers.length === 0" class="p-4 text-center text-gray-500">
                        No users found
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Permissions Editor -->
        <div class="lg:col-span-3">
            <template x-if="selectedUser">
                <div class="bg-white rounded-lg shadow">
                    <!-- User Header -->
                    <div class="p-6 border-b bg-gradient-to-r from-indigo-50 to-white">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-4">
                                <div class="w-16 h-16 rounded-full bg-indigo-100 flex items-center justify-center">
                                    <span class="text-2xl text-indigo-600 font-bold" x-text="selectedUser.name.charAt(0).toUpperCase()"></span>
                                </div>
                                <div>
                                    <h3 class="text-xl font-bold text-gray-900" x-text="selectedUser.name"></h3>
                                    <p class="text-gray-500" x-text="selectedUser.email"></p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <button @click="grantAllPermissions()" 
                                        class="px-3 py-1.5 text-sm bg-green-100 text-green-700 rounded-lg hover:bg-green-200">
                                    <i class="fas fa-check-double mr-1"></i> Grant All
                                </button>
                                <button @click="revokeAllPermissions()" 
                                        class="px-3 py-1.5 text-sm bg-red-100 text-red-700 rounded-lg hover:bg-red-200">
                                    <i class="fas fa-times mr-1"></i> Revoke All
                                </button>
                            </div>
                        </div>
                        
                        <!-- PF Agent Restriction -->
                        <div class="mt-4 p-3 bg-white rounded-lg border">
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                <i class="fas fa-lock text-amber-500 mr-1"></i> Restrict to PF Agent
                            </label>
                            <select x-model="selectedUser.pf_agent_id" @change="markDirty()"
                                    class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500">
                                <option value="">No restriction - can see all agents</option>
                                {% for user in pf_users %}
                                <option value="{{ user.id }}">{{ user.firstName }} {{ user.lastName }} ({{ user.email }})</option>
                                {% endfor %}
                            </select>
                            <p class="text-xs text-gray-500 mt-1">When set, user will only see listings and leads for this agent</p>
                        </div>
                    </div>
                    
                    <!-- Sections Grid -->
                    <div class="p-6">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">Section Permissions</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {% for section_key, section in sections.items() %}
                            <div class="border rounded-lg p-4 hover:shadow-md transition-shadow"
                                 :class="hasAnySectionPermission('{{ section_key }}') ? 'border-green-300 bg-green-50' : 'border-gray-200'">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center gap-2">
                                        <div class="w-8 h-8 rounded-lg flex items-center justify-center"
                                             :class="hasAnySectionPermission('{{ section_key }}') ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-500'">
                                            <i class="fas {{ section.icon }}"></i>
                                        </div>
                                        <div>
                                            <h5 class="font-semibold text-gray-800">{{ section.name }}</h5>
                                            <p class="text-xs text-gray-500">{{ section.description }}</p>
                                        </div>
                                    </div>
                                    <button @click="toggleAllSection('{{ section_key }}')" 
                                            class="text-xs px-2 py-1 rounded"
                                            :class="hasAnySectionPermission('{{ section_key }}') ? 'bg-green-200 text-green-700' : 'bg-gray-200 text-gray-600'">
                                        <span x-text="hasAllSectionPermissions('{{ section_key }}') ? 'Revoke All' : 'Grant All'"></span>
                                    </button>
                                </div>
                                <div class="flex flex-wrap gap-2">
                                    {% for action in section.actions %}
                                    <label class="flex items-center gap-1.5 cursor-pointer">
                                        <input type="checkbox" 
                                               :checked="getPermission('{{ section_key }}', '{{ action }}')"
                                               @change="setPermission('{{ section_key }}', '{{ action }}', $event.target.checked)"
                                               class="w-4 h-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                        <span class="text-sm text-gray-700">{{ action_labels.get(action, action) }}</span>
                                    </label>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Save Button -->
                    <div class="p-6 border-t bg-gray-50 flex justify-end gap-3">
                        <button @click="resetPermissions()" x-show="isDirty"
                                class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-100">
                            Reset Changes
                        </button>
                        <button @click="savePermissions()" 
                                :disabled="saving"
                                class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50 flex items-center gap-2">
                            <i class="fas fa-save" x-show="!saving"></i>
                            <i class="fas fa-spinner fa-spin" x-show="saving"></i>
                            <span x-text="saving ? 'Saving...' : 'Save Permissions'"></span>
                        </button>
                    </div>
                </div>
            </template>
            
            <!-- No User Selected -->
            <template x-if="!selectedUser">
                <div class="bg-white rounded-lg shadow p-12 text-center">
                    <i class="fas fa-user-shield text-6xl text-gray-300 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-700 mb-2">Select a User</h3>
                    <p class="text-gray-500">Choose a user from the list to manage their permissions</p>
                </div>
            </template>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function permissionsManager() {
    return {
        users: {{ users|tojson|safe }},
        sections: {{ sections|tojson|safe }},
        selectedUserId: null,
        selectedUser: null,
        originalPermissions: {},
        searchQuery: '',
        saving: false,
        isDirty: false,
        
        init() {
            // Auto-select first user if exists
            if (this.users.length > 0) {
                this.selectUser(this.users[0].id);
            }
        },
        
        get filteredUsers() {
            if (!this.searchQuery) return this.users;
            const q = this.searchQuery.toLowerCase();
            return this.users.filter(u => 
                u.name.toLowerCase().includes(q) || 
                u.email.toLowerCase().includes(q)
            );
        },
        
        async selectUser(userId) {
            this.selectedUserId = userId;
            this.selectedUser = JSON.parse(JSON.stringify(this.users.find(u => u.id === userId)));
            if (!this.selectedUser.section_permissions) {
                this.selectedUser.section_permissions = {};
            }
            this.originalPermissions = JSON.parse(JSON.stringify(this.selectedUser.section_permissions));
            this.isDirty = false;
        },
        
        getPermission(section, action) {
            if (!this.selectedUser || !this.selectedUser.section_permissions) return false;
            const sectionPerms = this.selectedUser.section_permissions[section] || {};
            return sectionPerms[action] === true;
        },
        
        setPermission(section, action, value) {
            if (!this.selectedUser.section_permissions[section]) {
                this.selectedUser.section_permissions[section] = {};
            }
            this.selectedUser.section_permissions[section][action] = value;
            this.markDirty();
        },
        
        hasAnySectionPermission(section) {
            if (!this.selectedUser || !this.selectedUser.section_permissions) return false;
            const sectionPerms = this.selectedUser.section_permissions[section] || {};
            return Object.values(sectionPerms).some(v => v === true);
        },
        
        hasAllSectionPermissions(section) {
            if (!this.selectedUser || !this.sections[section]) return false;
            const actions = this.sections[section].actions;
            return actions.every(action => this.getPermission(section, action));
        },
        
        toggleAllSection(section) {
            const grantAll = !this.hasAllSectionPermissions(section);
            const actions = this.sections[section].actions;
            actions.forEach(action => this.setPermission(section, action, grantAll));
        },
        
        grantAllPermissions() {
            Object.keys(this.sections).forEach(section => {
                this.sections[section].actions.forEach(action => {
                    this.setPermission(section, action, true);
                });
            });
        },
        
        revokeAllPermissions() {
            this.selectedUser.section_permissions = {};
            this.markDirty();
        },
        
        markDirty() {
            this.isDirty = true;
        },
        
        resetPermissions() {
            this.selectedUser.section_permissions = JSON.parse(JSON.stringify(this.originalPermissions));
            this.isDirty = false;
        },
        
        async savePermissions() {
            if (!this.selectedUser) return;
            this.saving = true;
            
            try {
                const res = await fetch(`/api/users/${this.selectedUser.id}/permissions`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        section_permissions: this.selectedUser.section_permissions,
                        pf_agent_id: this.selectedUser.pf_agent_id || null,
                        pf_agent_name: this.selectedUser.pf_agent_id ? 
                            document.querySelector(`option[value="${this.selectedUser.pf_agent_id}"]`)?.textContent : null
                    })
                });
                const data = await res.json();
                
                if (data.success) {
                    // Update local users array
                    const idx = this.users.findIndex(u => u.id === this.selectedUser.id);
                    if (idx >= 0) {
                        this.users[idx] = data.user;
                    }
                    this.originalPermissions = JSON.parse(JSON.stringify(this.selectedUser.section_permissions));
                    this.isDirty = false;
                    
                    // Show success toast
                    this.showToast('Permissions saved successfully!', 'success');
                } else {
                    this.showToast(data.error || 'Failed to save permissions', 'error');
                }
            } catch (e) {
                console.error('Failed to save permissions:', e);
                this.showToast('Failed to save permissions', 'error');
            }
            
            this.saving = false;
        },
        
        showToast(message, type = 'info') {
            // Simple alert for now - could be replaced with a toast library
            if (type === 'error') {
                alert('Error: ' + message);
            } else {
                alert(message);
            }
        }
    };
}
</script>
{% endblock %}
