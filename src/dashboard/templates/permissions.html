{% extends "base.html" %}

{% block title %}{{ t('permissions.center', default='Permission Center') }} - L-Manager{% endblock %}
{% block page_title %}{{ t('permissions.center', default='Permission Center') }}{% endblock %}

{% block content %}
<div x-data="permissionCenter()" x-init="init()" class="max-w-7xl mx-auto space-y-6">
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
            <div>
                <h2 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                    <i class="fas fa-shield-alt text-indigo-500"></i>
                    Workspace Permission Center
                </h2>
                <p class="text-gray-500 mt-1">Baseline permissions are role-based per workspace. Per-user overrides are allow/deny and deny wins.</p>
            </div>
            <div class="w-full lg:w-96">
                <label class="block text-xs text-gray-500 mb-1">Workspace</label>
                <select x-model.number="selectedWorkspaceId" @change="onWorkspaceChange()"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    <template x-for="workspace in workspaces" :key="workspace.id">
                        <option :value="workspace.id" x-text="workspace.name"></option>
                    </template>
                </select>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center justify-between mb-4">
            <div>
                <h3 class="text-lg font-semibold text-gray-900">Baseline Role Permissions</h3>
                <p class="text-sm text-gray-500">System admins can edit owner/admin/team_leader/member/viewer role matrix per workspace.</p>
            </div>
            <button @click="saveMatrix()" :disabled="savingMatrix || !matrix"
                    class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50">
                <span x-show="!savingMatrix">Save Matrix</span>
                <span x-show="savingMatrix"><i class="fas fa-spinner fa-spin mr-1"></i>Saving...</span>
            </button>
        </div>

        <div class="flex flex-wrap gap-2 mb-4">
            <template x-for="roleKey in roleOrder" :key="roleKey">
                <button type="button"
                        @click="selectedRole = roleKey"
                        :class="selectedRole === roleKey ? 'bg-indigo-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                        class="px-3 py-1.5 rounded-lg text-sm font-medium">
                    <span x-text="roleLabels[roleKey] || roleKey"></span>
                </button>
            </template>
        </div>

        <div x-show="matrix" class="overflow-x-auto">
            <table class="w-full min-w-[900px] text-sm">
                <thead>
                    <tr class="border-b">
                        <th class="text-left py-2 pr-3 text-gray-600">Module</th>
                        <th class="text-left py-2 pr-3 text-gray-600">Actions</th>
                        <th class="text-left py-2 text-gray-600">Scope</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="module in modules" :key="module">
                        <tr class="border-b align-top">
                            <td class="py-3 pr-3 font-medium text-gray-800" x-text="module"></td>
                            <td class="py-3 pr-3">
                                <div class="flex flex-wrap gap-3">
                                    <template x-for="action in actionsForModule(module)" :key="`${module}:${action}`">
                                        <label class="inline-flex items-center gap-2 text-gray-700">
                                            <input type="checkbox"
                                                   :checked="isBaselineAllowed(selectedRole, module, action)"
                                                   @change="setBaselineAllowed(selectedRole, module, action, $event.target.checked)"
                                                   class="w-4 h-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                                            <span x-text="action"></span>
                                        </label>
                                    </template>
                                </div>
                            </td>
                            <td class="py-3">
                                <template x-if="isScopedModule(module)">
                                    <select :value="getBaselineScope(selectedRole, module)"
                                            @change="setBaselineScope(selectedRole, module, $event.target.value)"
                                            class="border border-gray-300 rounded-lg px-2 py-1 text-sm">
                                        <option value="own">own</option>
                                        <option value="team">team</option>
                                        <option value="workspace">workspace</option>
                                    </select>
                                </template>
                                <template x-if="!isScopedModule(module)">
                                    <span class="text-gray-400">n/a</span>
                                </template>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center justify-between mb-4">
            <div>
                <h3 class="text-lg font-semibold text-gray-900">Per-User Overrides</h3>
                <p class="text-sm text-gray-500">Overrides are workspace-local. Deny overrides always win over role baseline.</p>
            </div>
            <div class="w-full max-w-sm">
                <label class="block text-xs text-gray-500 mb-1">Workspace Member</label>
                <select x-model.number="selectedMemberUserId" @change="onMemberChange()"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    <option value="">Select member</option>
                    <template x-for="member in members" :key="member.id">
                        <option :value="member.user_id" x-text="`${member.user_name} (${member.role})`"></option>
                    </template>
                </select>
            </div>
        </div>

        <template x-if="selectedMember">
            <div class="space-y-4">
                <div class="overflow-x-auto">
                    <table class="w-full min-w-[900px] text-sm">
                        <thead>
                            <tr class="border-b">
                                <th class="text-left py-2 pr-3 text-gray-600">Module</th>
                                <th class="text-left py-2 text-gray-600">Action Overrides</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="module in modules" :key="`ovr-${module}`">
                                <tr class="border-b align-top">
                                    <td class="py-3 pr-3 font-medium text-gray-800" x-text="module"></td>
                                    <td class="py-3">
                                        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3">
                                            <template x-for="action in actionsForModule(module)" :key="`ovr-${module}-${action}`">
                                                <label class="flex items-center justify-between border border-gray-200 rounded-lg px-3 py-2">
                                                    <span class="text-gray-700" x-text="action"></span>
                                                    <select :value="getOverrideValue(module, action)"
                                                            @change="setOverrideValue(module, action, $event.target.value)"
                                                            class="border border-gray-300 rounded px-2 py-1 text-sm">
                                                        <option value="inherit">inherit</option>
                                                        <option value="allow">allow</option>
                                                        <option value="deny">deny</option>
                                                    </select>
                                                </label>
                                            </template>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>

                <div class="flex items-center justify-end gap-2">
                    <button @click="clearSelectedMemberOverrides()"
                            class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                        Clear Overrides
                    </button>
                    <button @click="saveMemberOverrides()" :disabled="savingOverrides"
                            class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50">
                        <span x-show="!savingOverrides">Save Overrides</span>
                        <span x-show="savingOverrides"><i class="fas fa-spinner fa-spin mr-1"></i>Saving...</span>
                    </button>
                </div>
            </div>
        </template>

        <template x-if="!selectedMember">
            <div class="text-sm text-gray-500">Select a member to edit workspace-specific allow/deny overrides.</div>
        </template>
    </div>

    <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-1">Effective Permissions Preview</h3>
        <p class="text-sm text-gray-500 mb-4">Computed result after applying role baseline + per-user overrides.</p>

        <template x-if="selectedMember && effectiveByUser[selectedMember.user_id]">
            <div class="overflow-x-auto">
                <table class="w-full min-w-[900px] text-sm">
                    <thead>
                        <tr class="border-b">
                            <th class="text-left py-2 pr-3 text-gray-600">Module</th>
                            <th class="text-left py-2 pr-3 text-gray-600">Allowed Actions</th>
                            <th class="text-left py-2 text-gray-600">Scope</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="module in modules" :key="`eff-${module}`">
                            <tr class="border-b">
                                <td class="py-3 pr-3 font-medium text-gray-800" x-text="module"></td>
                                <td class="py-3 pr-3">
                                    <span class="text-gray-700" x-text="formatAllowedActions(module)"></span>
                                </td>
                                <td class="py-3 text-gray-700" x-text="getEffectiveScope(module)"></td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </template>
        <template x-if="!selectedMember">
            <div class="text-sm text-gray-500">Select a member to preview effective permissions.</div>
        </template>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function permissionCenter() {
    return {
        workspaces: {{ workspaces|tojson|safe }},
        selectedWorkspaceId: {{ selected_workspace_id|tojson|safe }},
        roleLabels: {{ role_labels|tojson|safe }},
        actionsByModule: {{ actions_by_module|tojson|safe }},
        scopedModules: {{ scoped_modules|tojson|safe }},
        roleOrder: ['owner', 'admin', 'team_leader', 'member', 'viewer'],
        selectedRole: 'owner',
        matrix: null,
        members: [],
        selectedMemberUserId: '',
        overridesByUser: {},
        effectiveByUser: {},
        savingMatrix: false,
        savingOverrides: false,

        init() {
            if (!this.selectedWorkspaceId && this.workspaces.length > 0) {
                this.selectedWorkspaceId = this.workspaces[0].id;
            }
            if (this.selectedWorkspaceId) {
                this.onWorkspaceChange();
            }
        },

        get modules() {
            return Object.keys(this.actionsByModule || {});
        },

        get selectedMember() {
            const userId = Number(this.selectedMemberUserId);
            if (!userId) return null;
            return this.members.find(member => Number(member.user_id) === userId) || null;
        },

        async onWorkspaceChange() {
            if (!this.selectedWorkspaceId) return;
            this.selectedMemberUserId = '';
            await Promise.all([
                this.loadMatrix(),
                this.loadMembers(),
                this.loadOverrides(),
                this.loadEffective()
            ]);
        },

        async onMemberChange() {
            if (!this.selectedWorkspaceId) return;
            await this.loadEffective();
        },

        async loadMatrix() {
            const response = await fetch(`/api/workspaces/${this.selectedWorkspaceId}/permission-matrix`);
            const data = await response.json().catch(() => ({}));
            if (!response.ok || !data.success) {
                alert(data.error || 'Failed to load permission matrix');
                return;
            }
            this.matrix = data.matrix;
        },

        async loadMembers() {
            const response = await fetch(`/api/workspaces/${this.selectedWorkspaceId}/members`);
            const data = await response.json().catch(() => ({}));
            if (!response.ok || !data.success) {
                alert(data.error || 'Failed to load workspace members');
                return;
            }
            this.members = (data.members || []).sort((a, b) => {
                const an = (a.user_name || '').toLowerCase();
                const bn = (b.user_name || '').toLowerCase();
                return an.localeCompare(bn);
            });
        },

        async loadOverrides() {
            const response = await fetch(`/api/workspaces/${this.selectedWorkspaceId}/permission-overrides`);
            const data = await response.json().catch(() => ({}));
            if (!response.ok || !data.success) {
                alert(data.error || 'Failed to load permission overrides');
                return;
            }
            this.overridesByUser = data.grouped || {};
        },

        async loadEffective() {
            const response = await fetch(`/api/workspaces/${this.selectedWorkspaceId}/members/effective-permissions`);
            const data = await response.json().catch(() => ({}));
            if (!response.ok || !data.success) {
                alert(data.error || 'Failed to load effective permissions');
                return;
            }
            const map = {};
            (data.members || []).forEach(member => {
                map[member.user_id] = member;
            });
            this.effectiveByUser = map;
        },

        actionsForModule(module) {
            return this.actionsByModule[module] || [];
        },

        isScopedModule(module) {
            return this.scopedModules.includes(module);
        },

        isBaselineAllowed(roleKey, module, action) {
            return !!(this.matrix &&
                this.matrix.roles &&
                this.matrix.roles[roleKey] &&
                this.matrix.roles[roleKey].modules &&
                this.matrix.roles[roleKey].modules[module] &&
                this.matrix.roles[roleKey].modules[module][action]);
        },

        setBaselineAllowed(roleKey, module, action, value) {
            if (!this.matrix || !this.matrix.roles || !this.matrix.roles[roleKey]) return;
            if (!this.matrix.roles[roleKey].modules[module]) {
                this.matrix.roles[roleKey].modules[module] = {};
            }
            this.matrix.roles[roleKey].modules[module][action] = !!value;
        },

        getBaselineScope(roleKey, module) {
            const scope = this.matrix?.roles?.[roleKey]?.modules?.[module]?.scope;
            return scope || (this.isScopedModule(module) ? 'own' : 'n/a');
        },

        setBaselineScope(roleKey, module, value) {
            if (!this.matrix || !this.matrix.roles || !this.matrix.roles[roleKey]) return;
            if (!this.matrix.roles[roleKey].modules[module]) {
                this.matrix.roles[roleKey].modules[module] = {};
            }
            this.matrix.roles[roleKey].modules[module].scope = value;
        },

        getOverrideValue(module, action) {
            if (!this.selectedMember) return 'inherit';
            const perUser = this.overridesByUser[String(this.selectedMember.user_id)] || {};
            return perUser[module]?.[action] || 'inherit';
        },

        setOverrideValue(module, action, value) {
            if (!this.selectedMember) return;
            const userKey = String(this.selectedMember.user_id);
            if (!this.overridesByUser[userKey]) this.overridesByUser[userKey] = {};
            if (!this.overridesByUser[userKey][module]) this.overridesByUser[userKey][module] = {};

            if (value === 'inherit') {
                delete this.overridesByUser[userKey][module][action];
                if (Object.keys(this.overridesByUser[userKey][module]).length === 0) {
                    delete this.overridesByUser[userKey][module];
                }
                if (Object.keys(this.overridesByUser[userKey]).length === 0) {
                    delete this.overridesByUser[userKey];
                }
                return;
            }

            this.overridesByUser[userKey][module][action] = value;
        },

        clearSelectedMemberOverrides() {
            if (!this.selectedMember) return;
            delete this.overridesByUser[String(this.selectedMember.user_id)];
        },

        buildSelectedMemberOverrideRows() {
            if (!this.selectedMember) return [];
            const userKey = String(this.selectedMember.user_id);
            const perUser = this.overridesByUser[userKey] || {};
            const rows = [];
            Object.entries(perUser).forEach(([module, actions]) => {
                Object.entries(actions || {}).forEach(([action, effect]) => {
                    if (effect === 'allow' || effect === 'deny') {
                        rows.push({ module, action, effect });
                    }
                });
            });
            return rows;
        },

        async saveMatrix() {
            if (!this.matrix || !this.selectedWorkspaceId) return;
            this.savingMatrix = true;
            try {
                const response = await fetch(`/api/workspaces/${this.selectedWorkspaceId}/permission-matrix`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ roles: this.matrix.roles })
                });
                const data = await response.json().catch(() => ({}));
                if (!response.ok || !data.success) {
                    alert(data.error || 'Failed to save permission matrix');
                    return;
                }
                this.matrix = data.matrix;
                await this.loadEffective();
            } finally {
                this.savingMatrix = false;
            }
        },

        async saveMemberOverrides() {
            if (!this.selectedWorkspaceId || !this.selectedMember) return;
            this.savingOverrides = true;
            try {
                const rows = this.buildSelectedMemberOverrideRows();
                const response = await fetch(`/api/workspaces/${this.selectedWorkspaceId}/members/${this.selectedMember.id}/permission-overrides`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ overrides: rows })
                });
                const data = await response.json().catch(() => ({}));
                if (!response.ok || !data.success) {
                    alert(data.error || 'Failed to save member overrides');
                    return;
                }
                this.overridesByUser[String(this.selectedMember.user_id)] = data.grouped || {};
                await this.loadEffective();
            } finally {
                this.savingOverrides = false;
            }
        },

        formatAllowedActions(module) {
            if (!this.selectedMember) return '-';
            const effective = this.effectiveByUser[this.selectedMember.user_id]?.effective_capabilities?.[module] || {};
            const allowed = [];
            for (const action of this.actionsForModule(module)) {
                if (effective[action] === true) allowed.push(action);
            }
            return allowed.length ? allowed.join(', ') : 'none';
        },

        getEffectiveScope(module) {
            if (!this.selectedMember) return '-';
            const effective = this.effectiveByUser[this.selectedMember.user_id]?.effective_capabilities?.[module] || {};
            if (!this.isScopedModule(module)) return 'n/a';
            return effective.scope || 'own';
        }
    };
}
</script>
{% endblock %}
