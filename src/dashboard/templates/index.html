{% extends "base.html" %}

{% block title %}{{ t('common.dashboard', default='Dashboard') }} - L-Manager{% endblock %}
{% block page_title %}{{ t('common.dashboard', default='Dashboard') }}{% endblock %}

{% block content %}
<div x-data="dashboard()" x-init="loadStats()">
    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-{{ 5 if can_view_pf_credits else 4 }} gap-6 mb-8">
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-indigo-100 text-indigo-600">
                    <i class="fas fa-building text-2xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm text-gray-500">{{ t('dashboard.total_listings', default='Total Listings') }}</p>
                    <p class="text-2xl font-semibold" x-text="stats.total || '-'"></p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-green-100 text-green-600">
                    <i class="fas fa-check-circle text-2xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm text-gray-500">{{ t('dashboard.published', default='Published') }}</p>
                    <p class="text-2xl font-semibold" x-text="stats.published || '-'"></p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                    <i class="fas fa-edit text-2xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm text-gray-500">{{ t('dashboard.drafts', default='Drafts') }}</p>
                    <p class="text-2xl font-semibold" x-text="stats.drafts || '-'"></p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                    <i class="fas fa-eye text-2xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm text-gray-500">{{ t('dashboard.views_today', default='Views Today') }}</p>
                    <p class="text-2xl font-semibold" x-text="stats.views || '-'"></p>
                </div>
            </div>
        </div>

        {% if can_view_pf_credits %}
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                    <i class="fas fa-coins text-2xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm text-gray-500">{{ t('dashboard.pf_credit_balance', default='PF Credit Balance') }}</p>
                    <p class="text-2xl font-semibold" x-text="stats.credits"></p>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- Quick Actions -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold mb-4">{{ t('dashboard.quick_actions', default='Quick Actions') }}</h3>
            <div class="grid grid-cols-2 gap-4">
                <a href="{{ url_for('new_listing') }}" class="flex items-center justify-center p-4 bg-indigo-50 rounded-lg hover:bg-indigo-100 transition">
                    <i class="fas fa-plus-circle text-indigo-600 mr-2"></i>
                    <span class="font-medium text-indigo-600">{{ t('common.new_listing', default='New Listing') }}</span>
                </a>
                <a href="{{ url_for('bulk_upload') }}" class="flex items-center justify-center p-4 bg-green-50 rounded-lg hover:bg-green-100 transition">
                    <i class="fas fa-upload text-green-600 mr-2"></i>
                    <span class="font-medium text-green-600">{{ t('common.bulk_upload', default='Bulk Upload') }}</span>
                </a>
                <a href="{{ url_for('listings') }}" class="flex items-center justify-center p-4 bg-blue-50 rounded-lg hover:bg-blue-100 transition">
                    <i class="fas fa-list text-blue-600 mr-2"></i>
                    <span class="font-medium text-blue-600">{{ t('common.view_all', default='View All') }}</span>
                </a>
                <a href="{{ url_for('settings') }}" class="flex items-center justify-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                    <i class="fas fa-cog text-gray-600 mr-2"></i>
                    <span class="font-medium text-gray-600">{{ t('common.settings', default='Settings') }}</span>
                </a>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold mb-4">{{ t('dashboard.api_status', default='API Status') }}</h3>
            <div class="space-y-3">
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                    <span class="text-gray-600">{{ t('dashboard.connection', default='Connection') }}</span>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium" 
                          :class="apiStatus.connected ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'">
                        <i class="fas fa-circle mr-1 text-xs" :class="apiStatus.connected ? 'text-green-500' : 'text-red-500'"></i>
                        <span x-text="apiStatus.connected ? i18nT('dashboard.connected', 'Connected') : i18nT('dashboard.disconnected', 'Disconnected')"></span>
                    </span>
                </div>
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                    <span class="text-gray-600">{{ t('dashboard.api_token', default='API Token') }}</span>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                          :class="apiStatus.hasToken ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'">
                        <span x-text="apiStatus.hasToken ? i18nT('dashboard.configured', 'Configured') : i18nT('dashboard.not_set', 'Not Set')"></span>
                    </span>
                </div>
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                    <span class="text-gray-600">{{ t('dashboard.last_sync', default='Last Sync') }}</span>
                    <span class="text-sm text-gray-500" x-text="apiStatus.lastSync || i18nT('common.never', 'Never')"></span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Listings -->
    <div class="bg-white rounded-lg shadow">
        <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
            <h3 class="text-lg font-semibold">{{ t('dashboard.recent_listings', default='Recent Listings') }}</h3>
            <a href="{{ url_for('listings') }}" class="text-indigo-600 hover:text-indigo-800 text-sm">
                {{ t('common.view_all', default='View All') }} <i class="fas fa-arrow-right ml-1"></i>
            </a>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">{{ t('common.reference', default='Reference') }}</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">{{ t('common.title', default='Title') }}</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">{{ t('common.type', default='Type') }}</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">{{ t('common.beds', default='Beds') }}</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">{{ t('common.size', default='Size') }}</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">{{ t('common.location', default='Location') }}</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">{{ t('common.price', default='Price') }}</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">{{ t('common.status', default='Status') }}</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">{{ t('common.actions', default='Actions') }}</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    <template x-for="listing in recentListings" :key="listing.id">
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-4 text-sm text-gray-500 font-mono" x-text="listing.reference || listing.id || '-'"></td>
                            <td class="px-4 py-4">
                                <div class="max-w-[180px] truncate text-sm font-medium text-gray-900" x-text="listing.title_en || listing.title || listing.reference || i18nT('dashboard.untitled', 'Untitled')"></div>
                            </td>
                            <td class="px-4 py-4 text-sm text-gray-500">
                                <span class="capitalize" x-text="(listing.property_type || '-').replace(/-/g, ' ')"></span>
                            </td>
                            <td class="px-4 py-4 text-sm text-center text-gray-600" x-text="formatBedrooms(listing)"></td>
                            <td class="px-4 py-4 text-sm text-gray-600" x-text="formatSize(listing)"></td>
                            <td class="px-4 py-4 text-sm text-gray-500">
                                <div class="max-w-[120px] truncate" x-text="getLocation(listing)"></div>
                            </td>
                            <td class="px-4 py-4 text-sm font-medium text-gray-900" x-text="formatPrice(listing.price)"></td>
                            <td class="px-4 py-4">
                                <span class="inline-flex px-2 py-1 text-xs font-medium rounded-full capitalize"
                                      :class="getStatusClass(listing.status)"
                                      x-text="listing.status"></span>
                            </td>
                            <td class="px-4 py-4 text-sm">
                                <a :href="'/listings/' + listing.id" class="text-indigo-600 hover:text-indigo-900 mr-3">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a :href="'/listings/' + listing.id + '/edit'" class="text-gray-600 hover:text-gray-900">
                                    <i class="fas fa-edit"></i>
                                </a>
                            </td>
                        </tr>
                    </template>
                    <tr x-show="recentListings.length === 0">
                        <td colspan="9" class="px-6 py-8 text-center text-gray-500">
                            <i class="fas fa-inbox text-4xl mb-2"></i>
                            <p>{{ t('dashboard.no_listings_found', default='No listings found') }}</p>
                            <a href="{{ url_for('new_listing') }}" class="text-indigo-600 hover:underline">{{ t('dashboard.create_first_listing', default='Create your first listing') }}</a>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function dashboard() {
    // Server-side data
    const serverStats = {{ stats | tojson | safe if stats else '{}' }};
    const serverListings = {{ recent_listings | tojson | safe if recent_listings else '[]' }};
    const canViewPfCredits = {{ 'true' if can_view_pf_credits else 'false' }};
    
    return {
        stats: {
            total: serverStats.total || 0,
            published: serverStats.published || 0,
            drafts: serverStats.draft || 0,
            views: '-',
            credits: '-'
        },
        recentListings: serverListings,
        canViewPfCredits: canViewPfCredits,
        apiStatus: {
            connected: true,
            hasToken: true,
            lastSync: formatLocalizedDate(new Date(), {
                year: 'numeric',
                month: 'short',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            })
        },

        numberLocale() {
            return (window.I18N && window.I18N.lang === 'ar') ? 'ar-AE-u-nu-latn' : 'en-AE';
        },
        
        async loadStats() {
            // Stats are now loaded from server
            try {
                const response = await fetch('/api/local/stats');
                const data = await response.json();
                this.stats.total = data.total;
                this.stats.published = data.published;
                this.stats.drafts = data.draft;
            } catch (error) {
                console.error('Failed to load stats:', error);
            }

            if (this.canViewPfCredits) {
                try {
                    const creditResp = await fetch('/api/credits');
                    const creditData = await creditResp.json();
                    if (creditResp.ok) {
                        let balance = null;
                        if (creditData && creditData.remaining !== null && creditData.remaining !== undefined) {
                            balance = Number(creditData.remaining);
                        }
                        if (!Number.isFinite(balance)) {
                            balance = this.extractCreditBalance(creditData);
                        }
                        this.stats.credits = balance !== null ? this.formatCredit(balance) : '-';
                    } else {
                    this.stats.credits = i18nT('common.not_available', 'Unavailable');
                }
            } catch (error) {
                console.error('Failed to load PF credits:', error);
                this.stats.credits = i18nT('common.not_available', 'Unavailable');
            }
        }
        },

        extractCreditBalance(payload) {
            const preferredKeys = [
                'balance', 'remaining', 'available', 'available_credits',
                'availableCredits', 'credit_balance', 'credits_remaining',
                'remaining_credits', 'total_remaining'
            ];
            return this.findCreditValue(payload, preferredKeys);
        },

        findCreditValue(value, preferredKeys) {
            if (value === null || value === undefined) return null;
            if (typeof value === 'number' && Number.isFinite(value)) return value;
            if (typeof value === 'string') {
                const asNumber = Number(value);
                return Number.isFinite(asNumber) ? asNumber : null;
            }
            if (Array.isArray(value)) {
                for (const item of value) {
                    const found = this.findCreditValue(item, preferredKeys);
                    if (found !== null) return found;
                }
                return null;
            }
            if (typeof value === 'object') {
                for (const key of preferredKeys) {
                    if (Object.prototype.hasOwnProperty.call(value, key)) {
                        const found = this.findCreditValue(value[key], preferredKeys);
                        if (found !== null) return found;
                    }
                }
                for (const nestedKey of ['data', 'results', 'meta', 'credits', 'quota']) {
                    if (Object.prototype.hasOwnProperty.call(value, nestedKey)) {
                        const found = this.findCreditValue(value[nestedKey], preferredKeys);
                        if (found !== null) return found;
                    }
                }
                for (const nested of Object.values(value)) {
                    const found = this.findCreditValue(nested, preferredKeys);
                    if (found !== null) return found;
                }
            }
            return null;
        },

        formatCredit(amount) {
            const numeric = Number(amount);
            if (!Number.isFinite(numeric)) return '-';
            return new Intl.NumberFormat(this.numberLocale(), {
                maximumFractionDigits: 0
            }).format(numeric);
        },
        
        formatPrice(price) {
            if (!price) return '-';
            const amount = price.amount || price;
            return new Intl.NumberFormat(this.numberLocale(), { 
                style: 'currency', 
                currency: 'AED',
                maximumFractionDigits: 0
            }).format(amount);
        },
        
        formatBedrooms(listing) {
            const beds = listing.bedrooms;
            if (beds === 'studio' || beds === 'Studio') return i18nT('dashboard.studio', 'Studio');
            if (beds === null || beds === undefined) return '-';
            return beds.toString();
        },
        
        formatSize(listing) {
            const size = listing.size;
            if (!size) return '-';
            const sqft = size.value || size.sqft || size;
            if (typeof sqft !== 'number') return '-';
            return sqft.toLocaleString(this.numberLocale()) + ' sqft';
        },
        
        getLocation(listing) {
            // Handle various location formats
            if (listing.location) {
                if (typeof listing.location === 'object') {
                    return listing.location.fullName || listing.location.community || listing.location.name || '-';
                }
                if (listing.city) return listing.location + ', ' + listing.city;
                return listing.location;
            }
            if (listing.city) return listing.city;
            return '-';
        },
        
        getStatusClass(status) {
            const classes = {
                'published': 'bg-green-100 text-green-800',
                'live': 'bg-green-100 text-green-800',
                'draft': 'bg-yellow-100 text-yellow-800',
                'pending': 'bg-blue-100 text-blue-800',
                'unpublished': 'bg-gray-100 text-gray-800',
                'expired': 'bg-red-100 text-red-800'
            };
            return classes[status] || 'bg-gray-100 text-gray-800';
        }
    }
}
</script>
{% endblock %}
