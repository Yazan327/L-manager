{% extends "base.html" %}

{% block title %}Connection Center - {{ workspace.name }} - L-Manager{% endblock %}
{% block page_title %}Connection Center{% endblock %}

{% block content %}
<div x-data="connectionsManager()" x-init="init()" class="max-w-6xl mx-auto">
    
    <!-- Header -->
    <div class="bg-white rounded-lg shadow mb-6 p-6">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-lg flex items-center justify-center text-white text-xl"
                     style="background-color: var(--{{ workspace.color }}-500, #6366f1);">
                    <i class="fas fa-layer-group"></i>
                </div>
                <div>
                    <h2 class="text-xl font-bold text-gray-900">{{ workspace.name }}</h2>
                    <p class="text-gray-500">Configure API connections for this workspace</p>
                </div>
            </div>
            <a href="{{ url_for('workspaces_page') }}" class="text-indigo-600 hover:text-indigo-800">
                <i class="fas fa-arrow-left mr-1"></i> Back to Workspaces
            </a>
        </div>
    </div>
    
    <!-- Available Providers -->
    <div class="bg-white rounded-lg shadow mb-6">
        <div class="p-6 border-b">
            <h3 class="text-lg font-semibold text-gray-800">Add Connection</h3>
            <p class="text-gray-500 text-sm">Connect your workspace to external services</p>
        </div>
        <div class="p-6">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                {% for key, provider in providers.items() %}
                <button @click="addConnection('{{ key }}')"
                        :disabled="hasConnection('{{ key }}')"
                        class="p-4 border rounded-lg text-center hover:border-{{ provider.color }}-500 hover:bg-{{ provider.color }}-50 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                    <div class="w-12 h-12 mx-auto rounded-full flex items-center justify-center text-white text-xl mb-2"
                         style="background-color: var(--{{ provider.color }}-500, #6366f1);">
                        <i class="{{ provider.icon }}"></i>
                    </div>
                    <div class="font-medium text-gray-800">{{ provider.name }}</div>
                    <div x-show="hasConnection('{{ key }}')" class="text-xs text-green-600 mt-1">
                        <i class="fas fa-check-circle"></i> Connected
                    </div>
                </button>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- Active Connections -->
    <div class="bg-white rounded-lg shadow">
        <div class="p-6 border-b">
            <h3 class="text-lg font-semibold text-gray-800">Active Connections</h3>
        </div>
        <div class="divide-y">
            <template x-for="conn in connections" :key="conn.id">
                <div class="p-6">
                    <div class="flex items-start justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-full flex items-center justify-center text-white text-xl"
                                 :class="'bg-' + conn.provider_color + '-500'">
                                <i :class="'fas ' + conn.provider_icon"></i>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-800" x-text="conn.provider_name"></h4>
                                <div class="flex items-center gap-2 mt-1">
                                    <!-- Status Badge -->
                                    <span x-show="conn.connection_status === 'connected'" 
                                          class="px-2 py-0.5 text-xs rounded-full bg-green-100 text-green-700">
                                        <i class="fas fa-check-circle mr-1"></i> Connected
                                    </span>
                                    <span x-show="conn.connection_status === 'pending'" 
                                          class="px-2 py-0.5 text-xs rounded-full bg-yellow-100 text-yellow-700">
                                        <i class="fas fa-clock mr-1"></i> Pending
                                    </span>
                                    <span x-show="conn.connection_status === 'error'" 
                                          class="px-2 py-0.5 text-xs rounded-full bg-red-100 text-red-700">
                                        <i class="fas fa-exclamation-circle mr-1"></i> Error
                                    </span>
                                    
                                    <!-- Last Connected -->
                                    <template x-if="conn.last_connected_at">
                                        <span class="text-xs text-gray-500">
                                            Last connected: <span x-text="formatDate(conn.last_connected_at)"></span>
                                        </span>
                                    </template>
                                </div>
                                
                                <!-- Error Message -->
                                <div x-show="conn.last_error" class="mt-2 text-sm text-red-600 bg-red-50 p-2 rounded">
                                    <i class="fas fa-exclamation-triangle mr-1"></i>
                                    <span x-text="conn.last_error"></span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex items-center gap-2">
                            <button @click="testConnection(conn)" :disabled="testing === conn.id"
                                    class="px-3 py-1.5 text-sm border rounded-lg hover:bg-gray-50">
                                <i class="fas fa-plug mr-1" x-show="testing !== conn.id"></i>
                                <i class="fas fa-spinner fa-spin mr-1" x-show="testing === conn.id"></i>
                                Test
                            </button>
                            <button @click="editConnection(conn)"
                                    class="px-3 py-1.5 text-sm bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200">
                                <i class="fas fa-edit mr-1"></i> Edit
                            </button>
                            <button @click="confirmDelete(conn)"
                                    class="px-3 py-1.5 text-sm bg-red-100 text-red-700 rounded-lg hover:bg-red-200">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Credentials Preview (masked) -->
                    <div class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-4">
                        <template x-for="(value, key) in conn.credentials_masked || {}" :key="key">
                            <div class="bg-gray-50 rounded p-2">
                                <div class="text-xs text-gray-500" x-text="key"></div>
                                <div class="font-mono text-sm text-gray-700" x-text="value || '(empty)'"></div>
                            </div>
                        </template>
                    </div>
                </div>
            </template>
            
            <!-- Empty State -->
            <template x-if="connections.length === 0">
                <div class="p-12 text-center">
                    <i class="fas fa-plug text-5xl text-gray-300 mb-4"></i>
                    <h4 class="text-lg font-medium text-gray-700 mb-2">No Connections</h4>
                    <p class="text-gray-500">Add a connection above to get started</p>
                </div>
            </template>
        </div>
    </div>
    
    <!-- Connection Modal -->
    <div x-show="showModal" x-cloak
         class="fixed inset-0 bg-black/50 flex items-center justify-center z-50"
         @click.self="closeModal()">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-4">
            <div class="p-6 border-b flex items-center gap-3">
                <div class="w-10 h-10 rounded-full flex items-center justify-center text-white"
                     :class="'bg-' + (providers[selectedProvider]?.color || 'gray') + '-500'">
                    <i :class="'fas ' + (providers[selectedProvider]?.icon || 'fa-plug')"></i>
                </div>
                <div>
                    <h3 class="text-lg font-semibold" x-text="(editingConnection ? 'Edit ' : 'Add ') + (providers[selectedProvider]?.name || 'Connection')"></h3>
                </div>
            </div>
            <div class="p-6">
                <div class="space-y-4">
                    <template x-for="field in (providers[selectedProvider]?.fields || [])" :key="field.key">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                <span x-text="field.label"></span>
                                <span x-show="field.required" class="text-red-500">*</span>
                            </label>
                            <template x-if="field.type === 'textarea'">
                                <textarea x-model="formData.credentials[field.key]" rows="4"
                                          class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 font-mono text-sm"
                                          :placeholder="field.placeholder || ''"></textarea>
                            </template>
                            <template x-if="field.type === 'password'">
                                <div class="relative">
                                    <input :type="showPassword ? 'text' : 'password'" 
                                           x-model="formData.credentials[field.key]"
                                           class="w-full border rounded-lg px-3 py-2 pr-10 focus:ring-2 focus:ring-indigo-500 font-mono"
                                           :placeholder="field.placeholder || '••••••••'">
                                    <button type="button" @click="showPassword = !showPassword"
                                            class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                        <i :class="showPassword ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
                                    </button>
                                </div>
                            </template>
                            <template x-if="field.type === 'text'">
                                <input type="text" x-model="formData.credentials[field.key]"
                                       class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 font-mono"
                                       :placeholder="field.placeholder || ''">
                            </template>
                        </div>
                    </template>
                </div>
            </div>
            <div class="p-6 border-t bg-gray-50 flex justify-between">
                <button @click="testBeforeSave()" :disabled="testing"
                        class="px-4 py-2 border rounded-lg hover:bg-gray-100 flex items-center gap-2">
                    <i class="fas fa-plug" x-show="!testing"></i>
                    <i class="fas fa-spinner fa-spin" x-show="testing"></i>
                    Test Connection
                </button>
                <div class="flex gap-3">
                    <button @click="closeModal()" class="px-4 py-2 border rounded-lg hover:bg-gray-100">Cancel</button>
                    <button @click="saveConnection()" :disabled="saving"
                            class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50">
                        <span x-show="!saving" x-text="editingConnection ? 'Save Changes' : 'Add Connection'"></span>
                        <span x-show="saving"><i class="fas fa-spinner fa-spin mr-1"></i> Saving...</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Delete Confirmation -->
    <div x-show="showDeleteModal" x-cloak
         class="fixed inset-0 bg-black/50 flex items-center justify-center z-50"
         @click.self="showDeleteModal = false">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md mx-4">
            <div class="p-6 border-b">
                <h3 class="text-lg font-semibold text-red-600">Delete Connection</h3>
            </div>
            <div class="p-6">
                <p class="text-gray-600">
                    Are you sure you want to delete the <strong x-text="connectionToDelete?.provider_name"></strong> connection?
                </p>
            </div>
            <div class="p-6 border-t bg-gray-50 flex justify-end gap-3">
                <button @click="showDeleteModal = false" class="px-4 py-2 border rounded-lg hover:bg-gray-100">Cancel</button>
                <button @click="deleteConnection()" :disabled="deleting"
                        class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:opacity-50">
                    Delete
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function connectionsManager() {
    return {
        workspace: {{ workspace|tojson|safe }},
        providers: {{ providers|tojson|safe }},
        connections: {{ workspace.connections|tojson|safe if workspace.connections else [] }},
        
        showModal: false,
        showDeleteModal: false,
        selectedProvider: null,
        editingConnection: null,
        connectionToDelete: null,
        
        formData: {
            credentials: {}
        },
        
        showPassword: false,
        saving: false,
        testing: null,
        deleting: false,
        
        init() {},
        
        hasConnection(provider) {
            return this.connections.some(c => c.provider === provider);
        },
        
        addConnection(provider) {
            this.selectedProvider = provider;
            this.editingConnection = null;
            this.formData = { credentials: {} };
            this.showModal = true;
        },
        
        editConnection(conn) {
            this.selectedProvider = conn.provider;
            this.editingConnection = conn;
            // Fetch actual credentials
            this.loadCredentials(conn.id);
            this.showModal = true;
        },
        
        async loadCredentials(connId) {
            try {
                const res = await fetch(`/api/workspaces/${this.workspace.id}/connections`);
                const data = await res.json();
                if (data.success) {
                    const conn = data.connections.find(c => c.id === connId);
                    if (conn && conn.credentials) {
                        this.formData.credentials = conn.credentials;
                    }
                }
            } catch (e) {
                console.error(e);
            }
        },
        
        closeModal() {
            this.showModal = false;
            this.selectedProvider = null;
            this.editingConnection = null;
            this.formData = { credentials: {} };
            this.showPassword = false;
        },
        
        confirmDelete(conn) {
            this.connectionToDelete = conn;
            this.showDeleteModal = true;
        },
        
        async saveConnection() {
            this.saving = true;
            
            try {
                const isEdit = !!this.editingConnection;
                const url = isEdit 
                    ? `/api/workspaces/${this.workspace.id}/connections/${this.editingConnection.id}`
                    : `/api/workspaces/${this.workspace.id}/connections`;
                
                const res = await fetch(url, {
                    method: isEdit ? 'PUT' : 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        provider: this.selectedProvider,
                        credentials: this.formData.credentials
                    })
                });
                const data = await res.json();
                
                if (data.success) {
                    if (isEdit) {
                        const idx = this.connections.findIndex(c => c.id === this.editingConnection.id);
                        if (idx >= 0) this.connections[idx] = data.connection;
                    } else {
                        this.connections.push(data.connection);
                    }
                    this.closeModal();
                } else {
                    alert(data.error || 'Failed to save connection');
                }
            } catch (e) {
                console.error(e);
                alert('Failed to save connection');
            }
            
            this.saving = false;
        },
        
        async deleteConnection() {
            if (!this.connectionToDelete) return;
            
            this.deleting = true;
            
            try {
                const res = await fetch(`/api/workspaces/${this.workspace.id}/connections/${this.connectionToDelete.id}`, {
                    method: 'DELETE'
                });
                const data = await res.json();
                
                if (data.success) {
                    this.connections = this.connections.filter(c => c.id !== this.connectionToDelete.id);
                    this.showDeleteModal = false;
                    this.connectionToDelete = null;
                } else {
                    alert(data.error || 'Failed to delete connection');
                }
            } catch (e) {
                console.error(e);
                alert('Failed to delete connection');
            }
            
            this.deleting = false;
        },
        
        async testConnection(conn) {
            this.testing = conn.id;
            
            try {
                const res = await fetch(`/api/workspaces/${this.workspace.id}/connections/${conn.id}/test`, {
                    method: 'POST'
                });
                const data = await res.json();
                
                // Update connection status
                conn.connection_status = data.status || (data.success ? 'connected' : 'error');
                conn.last_error = data.error || null;
                if (data.success) {
                    conn.last_connected_at = new Date().toISOString();
                }
                
                if (data.success) {
                    alert('Connection successful!');
                } else {
                    alert('Connection failed: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                console.error(e);
                alert('Failed to test connection');
            }
            
            this.testing = null;
        },
        
        async testBeforeSave() {
            // Create temp connection to test
            alert('Save the connection first, then use the Test button to verify it.');
        },
        
        formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }
    };
}
</script>
{% endblock %}
